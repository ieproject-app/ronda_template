<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ronda Malam Scheduler v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Menggunakan font Inter dan skema warna gelap/terang */
        html { 
            font-family: 'Inter', sans-serif;
            color-scheme: light dark; 
            scroll-behavior: smooth;
        }
        body { 
            transition: background-color 0.3s, color 0.3s; 
        }

        /* Styling dasar untuk mode gelap */
        body.dark {
            background-color: #111827; /* gray-900 */
            color: #d1d5db; /* gray-300 */
        }
        body.dark .bg-white { background-color: #1f2937; /* gray-800 */ }
        body.dark .bg-slate-50 { background-color: #111827; /* gray-900 */ }
        body.dark .text-slate-700 { color: #d1d5db; /* gray-300 */ }
        body.dark .text-slate-400 { color: #6b7280; /* gray-500 */ }
        body.dark .bg-slate-100 { background-color: #374151; /* gray-700 */ }
        body.dark .bg-slate-200 { background-color: #4b5563; /* gray-600 */ }
        body.dark .border, body.dark .border-slate-200, body.dark .border-slate-300 { border-color: #4b5563; }
        body.dark input, body.dark textarea {
             background-color: #374151;
             border-color: #6b7280;
             color: #f3f4f6; /* gray-100 */
        }
        body.dark input::placeholder, body.dark textarea::placeholder { color: #9ca3af; /* gray-400 */ }
        body.dark .wa-preview {
             background: #1e3a2a;
             color: #d1fae5;
             border-color: #34d399;
        }
        body.dark .wa-btn-secondary {
            background: #374151;
            color: #d1d5db;
            border-color: #4b5563;
        }
         body.dark .wa-btn-secondary:hover { background: #4b5563; }


        /* Menyembunyikan elemen yang tidak perlu saat mencetak */
        @media print {
            .no-print { display: none !important; }
            body { background-color: #fff; }
        }

        /* Transisi untuk toast notification */
        #toast {
            transition: opacity 0.3s, transform 0.3s;
            transform: translate(-50%, 20px);
        }
        #toast.show {
            opacity: 1;
            transform: translate(-50%, 0);
        }

        /* Overlay & Modal Styling */
        .overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }
        .overlay.show {
            opacity: 1;
            pointer-events: auto;
        }
        .modal {
            background-color: #fff;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
            width: 90%;
            max-width: 400px;
            transform: scale(0.95);
            transition: transform 0.2s;
        }
        .overlay.show .modal {
            transform: scale(1);
        }
        body.dark .modal { background-color: #1f2937; /* gray-800 */ }
    </style>
</head>
<body class="bg-slate-50 text-slate-700">

<div class="max-w-3xl mx-auto p-4 md:p-6">
    <header class="flex items-center justify-between mb-4">
        <h1 class="text-xl md:text-2xl font-bold text-slate-800 dark:text-white">üóìÔ∏è Ronda Malam Scheduler</h1>
        <button id="btnShowTutorial" class="no-print px-3 py-1.5 text-xs font-semibold text-blue-600 bg-blue-100 dark:bg-blue-900/50 dark:text-blue-300 rounded-full hover:bg-blue-200 dark:hover:bg-blue-900">
            Tutorial
        </button>
    </header>

    <!-- Panel Kontrol -->
    <div class="bg-white p-4 rounded-lg shadow-sm mb-4 no-print">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
            <button id="btnImport" class="flex items-center justify-center gap-2 px-3 py-2 bg-blue-600 text-white rounded-md text-sm font-semibold hover:bg-blue-700 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                Import
            </button>
            <button id="btnExportTxt" class="flex items-center justify-center gap-2 px-3 py-2 bg-green-600 text-white rounded-md text-sm font-semibold hover:bg-green-700 transition-colors">
                 <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                Export TXT
            </button>
            <button id="btnExportJson" class="flex items-center justify-center gap-2 px-3 py-2 bg-sky-600 text-white rounded-md text-sm font-semibold hover:bg-sky-700 transition-colors">
                 <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                Export JSON
            </button>
            <button id="btnClear" class="flex items-center justify-center gap-2 px-3 py-2 bg-red-600 text-white rounded-md text-sm font-semibold hover:bg-red-700 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                Clear
            </button>
            <input type="file" id="inputFile" accept=".txt,.json" class="hidden" />
        </div>
    </div>

    <!-- Navigasi Tanggal -->
    <div class="flex items-center gap-2 mb-4 bg-white p-3 rounded-lg shadow-sm">
        <label for="datePicker" class="font-semibold text-sm whitespace-nowrap">Pilih Tanggal:</label>
        <input type="date" id="datePicker" class="border rounded-md p-2 text-sm w-full" />
        <button id="btnPrev" class="p-2 rounded-md bg-slate-100 hover:bg-slate-200 border border-slate-200 no-print">&lt;</button>
        <button id="btnNext" class="p-2 rounded-md bg-slate-100 hover:bg-slate-200 border border-slate-200 no-print">&gt;</button>
    </div>

    <!-- Konten utama: Jadwal dan Preview WA -->
    <div class="grid md:grid-cols-2 gap-4">
        <!-- Panel Jadwal -->
        <div id="schedulePanel" class="bg-white p-4 rounded-lg shadow-sm">
            <div id="previewContainer" class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="bg-slate-100">
                            <th class="p-2 font-semibold text-left">Detail</th>
                            <th class="p-2 font-semibold text-left">Informasi</th>
                        </tr>
                    </thead>
                    <tbody id="previewTableBody"></tbody>
                </table>
                <div id="notFound" class="text-center text-slate-500 dark:text-slate-400 p-6 hidden">Tidak ada jadwal.</div>
            </div>

            <!-- Panel Edit -->
            <div id="editRowPanel" class="mt-4 hidden">
                <h3 class="font-bold mb-2 text-md">Edit Jadwal</h3>
                <form id="editForm" class="flex flex-col gap-3">
                    <input type="date" id="editTanggal" class="border rounded-md p-2 text-sm" required>
                    <input type="text" id="editTeam" placeholder="Nama Tim" class="border rounded-md p-2 text-sm" required>
                    <textarea id="editAnggota" placeholder="Satu anggota per baris" class="border rounded-md p-2 text-sm min-h-[100px] resize-y" required></textarea>
                    <div class="flex gap-2 justify-end">
                        <button id="btnCancelEdit" class="px-4 py-1.5 bg-slate-200 rounded-md text-xs font-semibold hover:bg-slate-300" type="button">Batal</button>
                        <button class="px-4 py-1.5 bg-blue-600 text-white rounded-md text-xs font-semibold hover:bg-blue-700" type="submit">Simpan</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Panel WhatsApp -->
        <div id="whatsappPanel" class="bg-white p-4 rounded-lg shadow-sm">
            <h3 class="font-bold mb-2 text-md">Bagikan ke WhatsApp</h3>
            <div id="waOutput" class="wa-preview whitespace-pre-wrap text-sm p-3 rounded-lg min-h-[200px] bg-slate-50 border">Pilih tanggal untuk melihat preview.</div>
            <div class="mt-3 flex flex-wrap gap-2 justify-end no-print" id="waBtnGroup">
                 <button id="btnEditRow" class="wa-btn-secondary">Edit</button>
                 <button id="btnCopyWA" class="wa-btn-secondary">Copy</button>
                 <button id="btnPrint" class="wa-btn-secondary">Print</button>
                 <button id="btnShareWA" class="wa-btn">
                    <svg viewBox="0 0 32 32" fill="none" class="wa-icon" width="18" height="18"><circle cx="16" cy="16" r="16" fill="#25D366"/><path d="M16 6.3c-5.4 0-9.7 4.3-9.7 9.7 0 1.7.5 3.3 1.3 4.7L6 26l5.4-1.7c1.3.7 2.8 1.1 4.3 1.1 5.4 0 9.7-4.3 9.7-9.7S21.4 6.3 16 6.3zm0 17.1c-1.3 0-2.6-.3-3.7-.9l-.3-.2-3.2 1 1-3.1-.2-.3C8.8 18.3 8.4 17.2 8.4 16c0-4.2 3.4-7.6 7.6-7.6s7.6 3.4 7.6 7.6-3.4 7.6-7.6 7.6zm4.1-5.7c-.2-.1-1.2-.6-1.3-.7-.2-.1-.3-.1-.5.1-.1.2-.6.7-.7.8-.1.1-.2.2-.5.1-1.1-.4-2-1.1-2.7-2-.2-.2.1-.3.2-.4.1-.1.2-.2.3-.4.1-.2 0-.3-.1-.5-.1-.1-.5-1.3-.7-1.7-.2-.4-.3-.3-.5-.3-.2 0-.3 0-.5 0-.2.1-.5.2-.8.5-.3.3-1.1 1.1-1.1 2.6 0 1.4 1.2 2.8 1.4 2.9.2.1 2.3 1.5 4.5 1.5 2.2 0 3.5-1.5 3.6-2.9.2-.3.2-.4 0-.5z" fill="#fff"/></svg>
                    Bagikan
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Mobile Sticky Action Bar -->
<div id="waActionBar" class="fixed bottom-0 left-0 right-0 bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-3 border-t dark:border-gray-700 shadow-t-lg flex gap-2 justify-evenly md:hidden no-print" style="display:none;">
    <button id="btnEditRowMobile" class="wa-btn-secondary flex-1">Edit</button>
    <button id="btnCopyWAMobile" class="wa-btn-secondary flex-1">Copy</button>
    <button id="btnPrintMobile" class="wa-btn-secondary flex-1">Print</button>
    <button id="btnShareWAMobile" class="wa-btn flex-1">Bagikan</button>
</div>

<!-- Toast Notification -->
<div id="toast" class="fixed left-1/2 bottom-5 px-5 py-2.5 rounded-full shadow-lg text-white bg-slate-800 dark:bg-slate-200 dark:text-slate-800 text-sm z-50 opacity-0 pointer-events-none"></div>

<!-- Confirmation Modal -->
<div id="confirmationOverlay" class="overlay">
    <div class="modal">
        <h3 id="confirmTitle" class="font-bold text-lg mb-2">Konfirmasi</h3>
        <p id="confirmMessage" class="text-sm text-slate-600 dark:text-slate-300 mb-6">Apakah Anda yakin ingin melanjutkan?</p>
        <div class="flex justify-end gap-3">
            <button id="btnConfirmCancel" class="px-4 py-2 bg-slate-200 dark:bg-slate-600 rounded-md font-semibold text-sm hover:bg-slate-300 dark:hover:bg-slate-500">Batal</button>
            <button id="btnConfirmOk" class="px-4 py-2 bg-red-600 text-white rounded-md font-semibold text-sm hover:bg-red-700">Ya, Lanjutkan</button>
        </div>
    </div>
</div>

<!-- Tutorial Modal -->
<div id="tutorialOverlay" class="overlay">
    <div class="modal max-w-lg">
         <h3 class="font-bold text-lg mb-4 text-center">Tutorial Penggunaan</h3>
         <!-- ... Konten tutorial bisa dimasukkan di sini, mirip dengan versi sebelumnya ... -->
         <p class="text-sm text-slate-600 dark:text-slate-300">
            <b>1. Import Jadwal:</b> Gunakan tombol <b>Import</b> untuk memuat jadwal dari file TXT atau JSON.<br><br>
            <b>2. Navigasi:</b> Pilih tanggal di kalender atau gunakan tombol panah untuk berpindah hari.<br><br>
            <b>3. Edit:</b> Klik tombol <b>Edit</b> untuk mengubah detail jadwal pada tanggal yang dipilih.<br><br>
            <b>4. Bagikan:</b> Gunakan panel WhatsApp untuk menyalin atau membagikan jadwal. Tombol akan muncul di bawah pada tampilan mobile.<br><br>
            <b>5. Export & Clear:</b> Gunakan tombol di panel kontrol untuk menyimpan (backup) atau menghapus semua jadwal.
         </p>
         <div class="flex justify-end mt-6">
            <button id="btnCloseTutorial" class="px-4 py-2 bg-blue-600 text-white rounded-md font-semibold text-sm hover:bg-blue-700">Mengerti</button>
        </div>
    </div>
</div>


<script type="module">
    // Import fungsi-fungsi Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Konfigurasi dan Inisialisasi Firebase ---
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'ronda-malam-scheduler-default';
    
    let db, auth, userId, scheduleDocRef;
    let jadwalArr = [];
    let currentTanggal = new Date().toISOString().slice(0, 10);
    let editIdx = null;

    // --- DOM Elements ---
    const DOMElements = {
        datePicker: document.getElementById('datePicker'),
        previewTableBody: document.getElementById('previewTableBody'),
        notFound: document.getElementById('notFound'),
        waOutput: document.getElementById('waOutput'),
        editRowPanel: document.getElementById('editRowPanel'),
        editForm: document.getElementById('editForm'),
        editTanggal: document.getElementById('editTanggal'),
        editTeam: document.getElementById('editTeam'),
        editAnggota: document.getElementById('editAnggota'),
        waActionBar: document.getElementById('waActionBar'),
        waBtnGroup: document.getElementById('waBtnGroup'),
        toast: document.getElementById('toast'),
        // ... (tambahkan elemen lain jika perlu)
    };

    // --- Fungsi Utilitas ---
    const showToast = (msg) => {
        DOMElements.toast.textContent = msg;
        DOMElements.toast.classList.add('show');
        setTimeout(() => { DOMElements.toast.classList.remove('show'); }, 2500);
    };

    const showConfirmationModal = (message, onConfirm) => {
        const overlay = document.getElementById('confirmationOverlay');
        document.getElementById('confirmMessage').textContent = message;
        overlay.classList.add('show');

        const okButton = document.getElementById('btnConfirmOk');
        const cancelButton = document.getElementById('btnConfirmCancel');
        
        const close = () => {
            overlay.classList.remove('show');
            okButton.replaceWith(okButton.cloneNode(true)); // Hapus event listener
        };

        okButton.onclick = () => {
            onConfirm();
            close();
        };
        cancelButton.onclick = close;
        overlay.onclick = (e) => { if(e.target === overlay) close(); };
    };

    const formatTanggalLong = (iso) => {
        const hari = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
        const bulan = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
        try {
            const d = new Date(iso + 'T00:00:00'); // Atasi masalah timezone
            if (isNaN(d)) return iso;
            return `${hari[d.getUTCDay()]}, ${d.getUTCDate()} ${bulan[d.getUTCMonth()]} ${d.getUTCFullYear()}`;
        } catch (e) {
            return iso;
        }
    };
    
    const parseTanggalToISO = (s) => {
        s = s.trim().replace(/^[A-Za-z]+,\s*/, '');
        const parts = s.split(' ');
        if (parts.length < 3) return null;
        const [tgl, blnStr, th] = parts;
        const bulanMap = {Januari:1,Februari:2,Maret:3,April:4,Mei:5,Juni:6,Juli:7,Agustus:8,September:9,Oktober:10,November:11,Desember:12,Jan:1,Feb:2,Mar:3,Apr:4,Mei:5,Jun:6,Jul:7,Agu:8,Sep:9,Okt:10,Nov:11,Des:12};
        const m = Object.keys(bulanMap).find(key => blnStr.toLowerCase().startsWith(key.toLowerCase()));
        if (!m) return null;
        const pad = (n) => n.toString().padStart(2, '0');
        return `${th}-${pad(bulanMap[m])}-${pad(parseInt(tgl, 10))}`;
    };

    const parseJadwalTxt = (txt) => {
        return txt.split('\n')
            .map(l => l.trim())
            .filter(l => l && !/Jadwal\s+Tim/i.test(l))
            .map(line => {
                const parts = line.split(',');
                if (parts.length < 4) return null;
                const tanggalStr = parts[0] + ',' + parts[1].trim();
                const iso = parseTanggalToISO(tanggalStr);
                if (!iso) return null;
                return {
                    date: iso,
                    team: parts[2].trim(),
                    members: parts.slice(3).join(',').split(';').map(m => m.trim()).filter(Boolean)
                };
            })
            .filter(Boolean)
            .sort((a, b) => a.date.localeCompare(b.date));
    };

    // --- Logika Firestore ---
    async function saveJadwalToFirestore(newJadwalArr) {
        if (!scheduleDocRef) return;
        try {
            await setDoc(scheduleDocRef, { schedules: newJadwalArr });
            // onSnapshot akan menangani update UI, jadi tidak perlu panggil render di sini
            showToast("Jadwal berhasil disimpan ke cloud!");
        } catch (error) {
            console.error("Error saving to Firestore: ", error);
            showToast("Gagal menyimpan ke cloud.");
        }
    }

    // --- Logika Render ---
    const renderAll = () => {
        renderPreview();
        renderWAOutput();
        toggleActionButtons();
    };

    const renderPreview = () => {
        editIdx = jadwalArr.findIndex(j => j.date === currentTanggal);
        DOMElements.previewTableBody.innerHTML = '';
        DOMElements.editRowPanel.classList.add('hidden'); // Selalu sembunyikan edit panel saat render ulang

        if (editIdx === -1) {
            DOMElements.notFound.classList.remove('hidden');
            return;
        }
        
        DOMElements.notFound.classList.add('hidden');
        const j = jadwalArr[editIdx];
        const rows = [
            { label: 'Tanggal', value: formatTanggalLong(j.date) },
            { label: 'Tim', value: `<span class="font-bold">${j.team}</span>` },
            { 
                label: 'Anggota', 
                value: j.members.map(m => `<span class="inline-block bg-blue-100 dark:bg-blue-900/50 text-blue-800 dark:text-blue-200 rounded-full px-3 py-1 text-xs font-semibold mr-1 mb-1">${m}</span>`).join('')
            }
        ];

        rows.forEach(row => {
            const tr = document.createElement('tr');
            tr.className = 'border-b dark:border-gray-700';
            tr.innerHTML = `
                <td class="p-2 align-top font-medium text-slate-500 dark:text-slate-400">${row.label}</td>
                <td class="p-2">${row.value}</td>
            `;
            DOMElements.previewTableBody.appendChild(tr);
        });
    };

    const generateWAOutput = () => {
        const idx = jadwalArr.findIndex(j => j.date === currentTanggal);
        if (idx === -1) return 'Pilih tanggal yang ada jadwalnya untuk melihat preview.';
        
        const j = jadwalArr[idx];
        const selanjutnya = jadwalArr
            .filter(row => row.team === j.team && row.date > j.date)
            .map(row => `‚Ä¢ ${formatTanggalLong(row.date)}`)
            .join('\n') || '‚Ä¢ Belum ada jadwal berikutnya';

        const randomKata = ["Keamanan Prioritas!", "Siskamling untuk Kenyamanan!", "Jaga Lingkungan, Jaga Keluarga!", "Bersatu Menjaga, Damai Dirasa!"];
        const penutup = randomKata[Math.floor(Math.random() * randomKata.length)];

        return `üî•üö® *JADWAL RONDA MALAM* üö®üî•

üìÜ *${formatTanggalLong(j.date)}*
‚è∞ Waktu Jaga: 23.00‚Äì04.00 WIB

üë• *Tim: ${j.team}*
üëÆ‚Äç‚ôÇÔ∏è Petugas Jaga:
${j.members.map(m => `‚Ä¢ ${m}`).join('\n')}

üìå *Jadwal Berikutnya ${j.team}:*
${selanjutnya}

Terima kasih atas partisipasinya. Mari jaga lingkungan tetap aman & nyaman.

üí• *${penutup}* ÔøΩ`;
    };

    const renderWAOutput = () => {
        DOMElements.waOutput.textContent = generateWAOutput();
    };
    
    const toggleActionButtons = () => {
        const hasSchedule = jadwalArr.findIndex(j => j.date === currentTanggal) !== -1;
        DOMElements.waActionBar.style.display = hasSchedule ? 'flex' : 'none';
        DOMElements.waBtnGroup.style.display = hasSchedule ? 'flex' : 'none';
    };

    // --- Logika Event Handler ---
    const handleDateChange = () => {
        currentTanggal = DOMElements.datePicker.value;
        renderAll();
    };

    const setTanggalNext = (dir) => {
        if (!jadwalArr.length) return;
        const currentIdxInArray = jadwalArr.findIndex(j => j.date === currentTanggal);
        let nextIdx;

        if (currentIdxInArray === -1) {
            // Jika tanggal saat ini tidak ada di jadwal, cari yang terdekat
            const sortedDates = jadwalArr.map(j => j.date).sort();
            if (dir > 0) {
                 nextIdx = sortedDates.findIndex(d => d > currentTanggal);
            } else {
                 const prevDates = sortedDates.filter(d => d < currentTanggal);
                 nextIdx = sortedDates.indexOf(prevDates[prevDates.length-1]);
            }
            if(nextIdx === -1) nextIdx = dir > 0 ? 0 : sortedDates.length - 1;

        } else {
            nextIdx = currentIdxInArray + dir;
        }

        if (nextIdx >= 0 && nextIdx < jadwalArr.length) {
            currentTanggal = jadwalArr[nextIdx].date;
            DOMElements.datePicker.value = currentTanggal;
            renderAll();
        }
    };
    
    const showEditPanel = (show) => {
        const idx = jadwalArr.findIndex(j => j.date === currentTanggal);
        DOMElements.editRowPanel.classList.toggle('hidden', !show);
        if (show && idx !== -1) {
            const j = jadwalArr[idx];
            DOMElements.editTanggal.value = j.date;
            DOMElements.editTeam.value = j.team;
            DOMElements.editAnggota.value = j.members.join('\n');
            DOMElements.editRowPanel.scrollIntoView({ behavior: 'smooth' });
        }
    };

    const handleEditFormSubmit = (e) => {
        e.preventDefault();
        const idx = jadwalArr.findIndex(j => j.date === currentTanggal);
        if (idx === -1) return;

        const updatedJadwal = {
            date: DOMElements.editTanggal.value,
            team: DOMElements.editTeam.value.trim(),
            members: DOMElements.editAnggota.value.split('\n').map(m => m.trim()).filter(Boolean)
        };

        const newJadwalArr = [...jadwalArr];
        newJadwalArr[idx] = updatedJadwal;
        newJadwalArr.sort((a, b) => a.date.localeCompare(b.date)); // Jaga urutan

        currentTanggal = updatedJadwal.date; // Update tanggal aktif
        DOMElements.datePicker.value = currentTanggal;

        saveJadwalToFirestore(newJadwalArr);
        showEditPanel(false);
    };
    
    const shareToWA = () => {
        const waText = generateWAOutput();
        if (waText.startsWith('Pilih tanggal')) {
            showToast('Tidak ada jadwal untuk dibagikan.');
            return;
        }
        if (navigator.share) {
            navigator.share({ text: waText }).catch(console.error);
        } else {
            window.open(`https://wa.me/?text=${encodeURIComponent(waText)}`, '_blank');
        }
    };

    // --- Inisialisasi Aplikasi ---
    const init = () => {
        // Dark Mode Toggle
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.body.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            document.body.classList.toggle('dark', event.matches);
        });

        // Setup Event Listeners
        DOMElements.datePicker.onchange = handleDateChange;
        document.getElementById('btnPrev').onclick = () => setTanggalNext(-1);
        document.getElementById('btnNext').onclick = () => setTanggalNext(1);
        
        // Kontrol Atas
        document.getElementById('btnImport').onclick = () => document.getElementById('inputFile').click();
        document.getElementById('inputFile').onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                let newJadwal = [];
                try {
                    if (file.name.endsWith('.json')) {
                        newJadwal = JSON.parse(ev.target.result) || [];
                    } else {
                        newJadwal = parseJadwalTxt(ev.target.result);
                    }
                    if(!Array.isArray(newJadwal)) throw new Error("Format tidak valid");
                    saveJadwalToFirestore(newJadwal);
                } catch(err) {
                    showToast('Gagal import: format file salah.');
                    console.error(err);
                }
            };
            reader.readAsText(file);
        };
        document.getElementById('btnExportTxt').onclick = () => {
             const lines = jadwalArr.map(j => `${formatTanggalLong(j.date)}, ${j.team}, ${j.members.join('; ')}`).join('\n');
             const blob = new Blob([lines], { type: 'text/plain' });
             const a = document.createElement('a');
             a.href = URL.createObjectURL(blob);
             a.download = "jadwal_ronda.txt";
             a.click();
             URL.revokeObjectURL(a.href);
        };
        document.getElementById('btnExportJson').onclick = () => {
            const blob = new Blob([JSON.stringify(jadwalArr, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = "jadwal_ronda.json";
            a.click();
            URL.revokeObjectURL(a.href);
        };
        document.getElementById('btnClear').onclick = () => {
            showConfirmationModal('Anda yakin ingin menghapus SEMUA jadwal? Tindakan ini tidak bisa dibatalkan.', () => {
                 saveJadwalToFirestore([]);
            });
        };
        
        // Tombol Aksi
        const copyAction = () => {
             const waText = generateWAOutput();
             navigator.clipboard.writeText(waText).then(() => showToast('Teks berhasil disalin!'));
        };
        const editAction = () => showEditPanel(true);
        const printAction = () => window.print();

        document.getElementById('btnShareWA').onclick = shareToWA;
        document.getElementById('btnCopyWA').onclick = copyAction;
        document.getElementById('btnEditRow').onclick = editAction;
        document.getElementById('btnPrint').onclick = printAction;

        document.getElementById('btnShareWAMobile').onclick = shareToWA;
        document.getElementById('btnCopyWAMobile').onclick = copyAction;
        document.getElementById('btnEditRowMobile').onclick = editAction;
        document.getElementById('btnPrintMobile').onclick = printAction;

        // Form Edit
        DOMElements.editForm.onsubmit = handleEditFormSubmit;
        document.getElementById('btnCancelEdit').onclick = () => showEditPanel(false);

        // Modal Tutorial
        document.getElementById('btnShowTutorial').onclick = () => document.getElementById('tutorialOverlay').classList.add('show');
        document.getElementById('btnCloseTutorial').onclick = () => document.getElementById('tutorialOverlay').classList.remove('show');

        // Render awal
        DOMElements.datePicker.value = currentTanggal;
        renderAll();
    };

    // --- Titik Masuk Utama ---
    window.onload = async () => {
        if (!firebaseConfig) {
            console.error("Konfigurasi Firebase tidak ditemukan. Aplikasi akan berjalan tanpa penyimpanan cloud.");
            showToast("Mode Offline: Data tidak tersimpan di cloud.");
            init(); // Jalankan aplikasi dalam mode offline
            return;
        }
        
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Autentikasi pengguna
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("User authenticated with UID:", userId);
                    // Path dokumen di Firestore. Semua jadwal user disimpan dalam 1 dokumen.
                    scheduleDocRef = doc(db, `artifacts/${appId}/users/${userId}/schedules`, "main");

                    // Listener real-time ke dokumen
                    onSnapshot(scheduleDocRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            jadwalArr = data.schedules || [];
                            console.log("Jadwal dimuat dari Firestore:", jadwalArr.length, "entri.");
                        } else {
                            console.log("Dokumen tidak ditemukan, jadwal diinisialisasi kosong.");
                            jadwalArr = [];
                        }
                        
                        // Cek apakah tanggal saat ini masih valid
                        if (!jadwalArr.some(j => j.date === currentTanggal) && jadwalArr.length > 0) {
                             currentTanggal = jadwalArr[0].date;
                             DOMElements.datePicker.value = currentTanggal;
                        }

                        renderAll();
                    }, (error) => {
                        console.error("Error listening to document:", error);
                        showToast("Gagal sinkronisasi data.");
                    });
                }
            });

            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                 await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                 await signInAnonymously(auth);
            }
            
        } catch (error) {
            console.error("Firebase Initialization Error:", error);
            showToast("Gagal terhubung ke server.");
        }

        init();
    };
</script>

</body>
</html>
