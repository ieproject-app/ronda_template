<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Ronda Malam Scheduler</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="dark light">
  <style>
    html { color-scheme: light dark; }
    body { transition: background 0.2s, color 0.2s; }
    @media print {
      /* Consider using more specific selectors instead of !important */
      body, .bg-white { background: #fff !important; color:#222 !important; }
      .shadow, .rounded, .bg-slate-50, .bg-slate-100, .bg-slate-200 { box-shadow:none; border-radius:0; background: #fff; }
      .max-w-2xl { max-width: 100vw; }
      pre, textarea { background: #fff; color: #000; }
      #mainBody { color: #000; }
      .no-print { display:none; }
    }
  </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-700 px-4 sm:px-6 md:px-8" id="mainBody">

<div class="max-w-2xl mx-auto mt-4 bg-white rounded shadow p-4">
  <!-- Reusable utility classes should be extracted to avoid repetition -->
  <div class="flex items-center justify-between mb-4">
    <h1 class="text-lg md:text-xl font-bold">Ronda Malam Scheduler</h1>
    <button id="btnShowFormat" class="no-print px-2 py-1 text-xs bg-slate-200 rounded">Format TXT</button>
  </div>

  <!-- Import / Export Buttons -->
  <div class="flex flex-wrap gap-2 mb-4 no-print justify-center">
    <input type="file" id="inputFile" accept=".txt,.json" class="hidden" />
    <!-- Consider looping through button configs in JS to dynamically generate these -->
    <button id="btnImport" class="btn-action">Import TXT</button>
    <button id="btnExportTxt" class="btn-action btn-green">Export TXT</button>
    <button id="btnExportJson" class="btn-action btn-sky">Export JSON</button>
    <button id="btnClear" class="btn-action btn-red">Clear Jadwal</button>
    <button id="btnCopyFormatTxt" class="btn-action" title="Copy Format TXT">Copy Format TXT</button>
  </div>

  <!-- Date Picker -->
  <div class="flex flex-col sm:flex-row sm:items-center gap-2 mb-4">
    <label class="font-semibold flex-shrink-0">Pilih Tanggal:</label>
    <input type="date" id="datePicker" class="border rounded p-1 text-sm" />
    <button id="btnPrev" class="nav-btn">&lt;</button>
    <button id="btnNext" class="nav-btn">&gt;</button>
  </div>

  <!-- Preview: Table for desktop, Cards for mobile -->
  <div id="previewContainer" class="mb-4">
    <!-- Desktop Table -->
    <div class="hidden sm:block overflow-x-auto">
      <table class="w-full border text-sm rounded overflow-hidden min-w-[360px]">
        <thead>
          <tr class="bg-slate-200 dark:bg-slate-700">
            <th class="p-2 border">Tanggal</th>
            <th class="p-2 border">Tim</th>
            <th class="p-2 border">Anggota</th>
          </tr>
        </thead>
        <tbody id="previewTableBody"></tbody>
      </table>
    </div>
    <!-- Mobile Card List -->
    <div class="space-y-3 sm:hidden">
      <template id="cardTemplate">
        <div class="p-4 bg-white rounded shadow dark:bg-gray-800">
          <div class="flex justify-between mb-2">
            <span class="font-semibold text-base text-slate-700 dark:text-slate-200" data-label="Tim"></span>
            <span class="text-xs text-gray-500 dark:text-gray-400" data-label="Tanggal"></span>
          </div>
          <div class="flex flex-wrap gap-1 break-words" data-label="Members"></div> <!-- Fixed malformed closing tag -->
        </div>
      </template>
      <div id="cardContainer"></div>
    </div>
    <div id="notFound" class="text-center text-slate-400 p-3"></div>
  </div>

  <!-- Edit Panel -->
  <div id="editRowPanel" class="mb-4 hidden">
    <div class="bg-slate-100 rounded p-3 mb-2">
      <div class="mb-2 font-semibold">Edit Jadwal</div>
      <form id="editForm" class="flex flex-col gap-2">
        <label>Tanggal: <input type="date" id="editTanggal" class="border rounded p-1 text-sm" required></label>
        <label>Tim: <input type="text" id="editTeam" class="border rounded p-1 text-sm" required></label>
        <label>Anggota: <input type="text" id="editAnggota" class="border rounded p-1 text-sm" required></label>
        <div class="flex gap-2 mt-2">
          <button class="btn-action btn-blue" type="submit">Simpan</button>
          <button id="btnCancelEdit" class="btn-action" type="button">Batal</button>
        </div>
      </form>
    </div>
  </div>

  <!-- WhatsApp & Copy -->
  <div class="mt-2 mb-2 bg-slate-100 rounded p-3">
    <div class="flex flex-wrap gap-2 mb-2 items-center">
      <button id="btnShareWA" class="wa-btn no-print">‚Ä¶</button>
      <button id="btnCopyWA" class="btn-action" title="Copy Text">Copy Text</button>
      <!-- Consider grouping edit/print/copy actions into a toolbar component -->
      <button id="btnEditRow" class="btn-action">Edit Baris</button>
      <button id="btnPrint" class="btn-action">Print</button>
    </div>
    <pre id="waOutput" class="whitespace-pre-wrap text-slate-700 text-sm bg-transparent"></pre>
  </div>
</div>

<!-- Fixed Bottom Bar for Mobile -->
<div class="fixed bottom-0 left-0 w-full sm:hidden bg-white border-t p-2 flex justify-around shadow-md z-50 no-print">
  <button id="btnShareWAFixed" class="wa-btn flex-1 mx-1 justify-center">‚Ä¶</button>
  <button id="btnCopyWAFixed" class="btn-action flex-1 mx-1 justify-center" title="Copy Text">Copy</button>
</div>

<!-- Add <noscript> fallback message for users with JS disabled -->
<noscript>
  <div class="fixed inset-0 bg-white p-4 text-center">
    <p>JavaScript diperlukan agar aplikasi ini berfungsi dengan baik. Silakan aktifkan JavaScript.</p>
  </div>
</noscript>

<script>
let jadwalArr = [];
let currentTanggal = null;
let editIdx = null;
const STORAGE_KEY = "ronda_jadwal_v3";
const randomKata2 = [
  "Keamanan Kita Prioritas!",
  "Utamakan Siskamling, Nyaman Bersama!",
  "Bersama, Lingkungan Aman Nyaman!",
  "Jaga Lingkungan, Jaga Keluarga!",
  "Satukan Langkah, Aman Bersama!",
  "Ronda untuk Harmoni Bersama!",
  "Bersatu Menjaga, Damai Dirasa!",
  "Bersama kita lebih kuat!",
  "Ronda Malam, Wujud Peduli!",
  "Ayo Jaga Malam, Demi Kenyamanan!"
];

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.display = '';
  t.style.opacity = '1';
  setTimeout(() => { t.style.opacity = '0'; }, 1600);
  setTimeout(() => { t.style.display = 'none'; }, 1900);
}

// Format dan parsing tanggal (ID)
function pad(n){ return n<10?'0'+n:n; }
function formatTanggalLong(iso){
  const hari=['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'];
  const bulan=['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];
  let d=new Date(iso);
  if(isNaN(d)) return iso;
  return `${hari[d.getDay()]}, ${d.getDate()} ${bulan[d.getMonth()]} ${d.getFullYear()}`;
}
function parseTanggalToISO(s){
  s=s.trim().replace(/^[A-Za-z]+,\s*/,'');
  let [tgl,bln,th]=s.split(' ');
  if(!tgl||!bln||!th)return null;
  const bulan={Januari:1,Februari:2,Maret:3,April:4,Mei:5,Juni:6,Juli:7,Agustus:8,September:9,Oktober:10,November:11,Desember:12,
    Jan:1,Feb:2,Mar:3,Apr:4,Mei:5,Jun:6,Jul:7,Agu:8,Sep:9,Okt:10,Nov:11,Des:12};
  let m=bulan[bln];
  if(!m)return null;
  return `${th}-${pad(m)}-${pad(parseInt(tgl,10))}`;
}

// Parse TXT
function parseJadwalTxt(txt){
  const lines=txt.split('\n').map(l=>l.trim()).filter(l=>!!l&&!/Jadwal\s+Tim/i.test(l));
  let res=[];
  for(let line of lines){
    let parts=line.split(',');
    if(parts.length<4)continue;
    let tanggal=parts[1].trim();
    let team=parts[2].trim();
    let membersRaw=parts.slice(3).join(',').trim();
    let members=membersRaw.split(';').map(m=>m.trim()).filter(Boolean);
    let iso=parseTanggalToISO(parts[0]+','+tanggal)||parseTanggalToISO(tanggal);
    if(!iso)continue;
    res.push({date:iso,team,members});
  }
  return res.sort((a,b)=>a.date.localeCompare(b.date));
}

// LocalStorage
function saveJadwal(arr){ localStorage.setItem(STORAGE_KEY,JSON.stringify(arr)); }
function loadJadwal(){ let d=localStorage.getItem(STORAGE_KEY); try{return d?JSON.parse(d):[];}catch{return [];} }

// Cari index berdasar tanggal
function findByTanggal(tanggal) {
  return jadwalArr.findIndex(j=>j.date===tanggal);
}

// Render Tabel Preview
function renderPreview() {
  const tbody = document.getElementById('previewTableBody');
  const notFound = document.getElementById('notFound');
  tbody.innerHTML = '';
  notFound.textContent = '';
  let idx = findByTanggal(currentTanggal);
  if(idx===-1) {
    notFound.textContent = "Tidak ada jadwal untuk tanggal ini.";
    return;
  }
  let j = jadwalArr[idx];
  let tr = document.createElement('tr');
  tr.innerHTML = `
    <td class="border p-2">${formatTanggalLong(j.date)}</td>
    <td class="border p-2 font-semibold">${j.team}</td>
    <td class="border p-2">${j.members.map(m=>`<span class="inline-block bg-blue-100 rounded px-2 mr-1 mb-1">${m}</span>`).join('')}</td>
  `;
  tbody.appendChild(tr);
}

// WhatsApp Output
function randomKalimatPenutup() {
  let idx = Math.floor(Math.random()*randomKata2.length);
  return randomKata2[idx];
}
function generateWAOutput() {
  let idx = findByTanggal(currentTanggal);
  if(idx===-1) return 'Tidak ada jadwal untuk tanggal ini.';
  const settings = {
    title: "RONDA MALAM KAISAR RESIDENCE",
    jam: "23.00‚Äì04.00 WIB",
    tz: "WIB"
  };
  let j = jadwalArr[idx];
  // Cari jadwal selanjutnya tim yang sama
  let selanjutnya = jadwalArr.filter(row => row.team === j.team && row.date > j.date)
    .map(row=>`‚Ä¢ ${formatTanggalLong(row.date)}`).join('\n') || '‚Ä¢ -';
  return (
`üî•üö® *${settings.title}* üö®üî•

üìÜ *${formatTanggalLong(j.date)}*  
‚è∞ *Waktu Jaga:* ${settings.jam}  

üë• *${j.team}*  
üëÆ‚Äç‚ôÇÔ∏è *Petugas:*  
${j.members.map(m=>`‚Ä¢ ${m}`).join('\n')}

üìå *Jadwal Selanjutnya ${j.team}:*  
${selanjutnya}

üôè Terima kasih atas partisipasinya.  
Mari jaga lingkungan tetap aman dan nyaman bersama-sama.  

üí• *${randomKalimatPenutup()}* üí•
`
  );
}
function renderWAOutput() {
  document.getElementById('waOutput').textContent = generateWAOutput();
}

// Tanggal picker: set ke earliest/latest jika < atau >
function setTanggalNext(dir) {
  if(!jadwalArr.length) return;
  let idx = findByTanggal(currentTanggal);
  if(idx===-1) {
    currentTanggal = jadwalArr[0].date;
  } else {
    let nextIdx = idx+dir;
    if(nextIdx >=0 && nextIdx < jadwalArr.length) {
      currentTanggal = jadwalArr[nextIdx].date;
    }
  }
  document.getElementById('datePicker').value = currentTanggal;
  renderPreview(); renderWAOutput();
}

// Edit Panel
function showEditPanel(show, idx) {
  const panel = document.getElementById('editRowPanel');
  panel.classList.toggle('hidden', !show);
  if(show) {
    editIdx = idx;
    let j = jadwalArr[idx];
    document.getElementById('editTanggal').value = j.date;
    document.getElementById('editTeam').value = j.team;
    document.getElementById('editAnggota').value = j.members.join('; ');
  } else {
    editIdx = null;
  }
}

// Overlay Format
document.getElementById('btnShowFormat').onclick = function() {
  document.getElementById('formatOverlay').style.display = '';
  document.body.style.overflow = 'hidden';
};
document.getElementById('btnCloseFormat').onclick = function() {
  document.getElementById('formatOverlay').style.display = 'none';
  document.body.style.overflow = '';
};
document.getElementById('formatOverlay').onclick = function(e){
  if(e.target===this){
    this.style.display='none';
    document.body.style.overflow = '';
  }
};
// Copy Format Example
document.getElementById('copyFormatExample').onclick = function() {
  const txt = document.getElementById('exampleFormat').innerText;
  navigator.clipboard.writeText(txt);
  showToast('Format TXT dicopy!');
};
// Copy Full Format TXT (dari data actual)
document.getElementById('btnCopyFormatTxt').onclick = function() {
  let lines = jadwalArr.map(j=>`${formatTanggalLong(j.date)}, ${j.team}, ${j.members.join('; ')}`);
  navigator.clipboard.writeText(lines.join('\n'));
  showToast('Seluruh jadwal dicopy sebagai format TXT!');
};

// Event Listeners
document.getElementById('datePicker').onchange = function() {
  currentTanggal = this.value;
  renderPreview(); renderWAOutput();
};
document.getElementById('btnPrev').onclick = function() { setTanggalNext(-1); };
document.getElementById('btnNext').onclick = function() { setTanggalNext(1); };

// WhatsApp
document.getElementById('btnShareWA').onclick = function() {
  let waText = generateWAOutput();
  if(waText.startsWith('Tidak ada')) { showToast('Tidak ada jadwal hari ini.'); return; }
  window.open('https://wa.me/?text='+encodeURIComponent(waText), '_blank');
};
document.getElementById('btnCopyWA').onclick = function() {
  let waText = generateWAOutput();
  navigator.clipboard.writeText(waText);
  showToast('Teks disalin!');
};
document.getElementById('btnPrint').onclick = function(){ window.print(); };

// Edit
document.getElementById('btnEditRow').onclick = function() {
  let idx = findByTanggal(currentTanggal);
  if(idx===-1) { showToast('Tidak ada jadwal untuk diedit!'); return; }
  showEditPanel(true, idx);
};
document.getElementById('btnCancelEdit').onclick = function() {
  showEditPanel(false);
};
document.getElementById('editForm').onsubmit = function(e){
  e.preventDefault();
  if(editIdx===null) return;
  let tgl = document.getElementById('editTanggal').value;
  let tim = document.getElementById('editTeam').value;
  let anggota = document.getElementById('editAnggota').value;
  if(!tgl||!tim||!anggota) { showToast('Lengkapi semua input!'); return;}
  jadwalArr[editIdx] = { date: tgl, team: tim, members: anggota.split(';').map(m=>m.trim()).filter(Boolean) };
  saveJadwal(jadwalArr);
  currentTanggal = tgl;
  document.getElementById('datePicker').value = currentTanggal;
  showEditPanel(false);
  renderPreview(); renderWAOutput();
  showToast('Jadwal disimpan!');
};

// Import/Export
document.getElementById('btnImport').onclick=()=>document.getElementById('inputFile').click();
document.getElementById('inputFile').onchange=function(e){
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=ev=>{
    if(f.name.endsWith('.json')){
      try{jadwalArr=JSON.parse(ev.target.result)||[];}catch{showToast('Format JSON salah!');return;}
    }else{
      jadwalArr=parseJadwalTxt(ev.target.result);
    }
    saveJadwal(jadwalArr);
    let today = (new Date()).toISOString().slice(0,10);
    if(findByTanggal(today)!==-1) currentTanggal = today;
    else if(jadwalArr.length) currentTanggal = jadwalArr[0].date;
    document.getElementById('datePicker').value = currentTanggal;
    renderPreview(); renderWAOutput();
    showToast('Berhasil import!');
  };
  r.readAsText(f);
};
document.getElementById('btnExportTxt').onclick=function(){
  let lines=jadwalArr.map(j=>`${formatTanggalLong(j.date)}, ${j.team}, ${j.members.join('; ')}`);
  let blob=new Blob([lines.join('\n')],{type:'text/plain'}),a=document.createElement('a');
  a.href=URL.createObjectURL(blob);a.download="jadwal_ronda.txt";a.click();URL.revokeObjectURL(a.href);showToast('Export TXT!');
};
document.getElementById('btnExportJson').onclick=function(){
  let blob=new Blob([JSON.stringify(jadwalArr,null,2)],{type:'application/json'}),a=document.createElement('a');
  a.href=URL.createObjectURL(blob);a.download="jadwal_ronda.json";a.click();URL.revokeObjectURL(a.href);showToast('Export JSON!');
};
document.getElementById('btnClear').onclick=function(){
  if(confirm('Hapus semua jadwal?')){jadwalArr=[];saveJadwal(jadwalArr);renderPreview();renderWAOutput();}
  let today = (new Date()).toISOString().slice(0,10);
  currentTanggal = today;
  document.getElementById('datePicker').value = today;
};

// INIT: load, set tanggal ke hari ini
window.onload = function() {
  if(window.matchMedia('(prefers-color-scheme: dark)').matches) {
    document.body.classList.add('dark');
  }
  jadwalArr = loadJadwal();
  let today = (new Date()).toISOString().slice(0,10);
  if(findByTanggal(today)!==-1) currentTanggal = today;
  else if(jadwalArr.length) currentTanggal = jadwalArr[0].date;
  else currentTanggal = today;
  document.getElementById('datePicker').value = currentTanggal;
  renderPreview(); renderWAOutput();
};

</script>
</body>
</html>
