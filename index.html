<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Ronda Malam Scheduler</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="dark light">
  <style>
    html { color-scheme: light dark; }
    body { transition: background 0.2s, color 0.2s; }
    .card {
      @apply bg-white dark:bg-slate-800 rounded-2xl shadow-md p-4 md:p-7 transition-colors duration-200;
    }
    .card-section {
      @apply bg-slate-50 dark:bg-slate-700 rounded-xl p-3 mb-4 shadow-sm border border-slate-100 dark:border-slate-700;
    }
    .card-section:last-child { margin-bottom: 0; }
    .card-title {
      @apply font-bold text-xl md:text-2xl text-slate-700 dark:text-slate-100 mb-2;
    }
    .card-label {
      @apply font-semibold text-slate-600 dark:text-slate-300 mb-1;
    }
    .card-action-bar {
      @apply flex flex-wrap gap-2 mt-2 mb-2;
    }
    .wa-btn {
      background: #25D366;
      color: white;
      font-weight: 700;
      border-radius: 6px;
      padding: 0.5rem 1.3rem;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5em;
      transition: background 0.2s;
      box-shadow: 0 1px 7px #0001;
      outline: none;
      justify-content: center;
    }
    .wa-btn:hover { background: #1ebd5a; }
    .wa-icon { width: 1.2em; height: 1.2em; display:inline-block; vertical-align:middle;}
    .copy-btn {
      background: #f1f5f9;
      border: 1px solid #cbd5e1;
      padding: 0.3em 0.85em;
      font-size: 0.93em;
      border-radius: 0.4em;
      color: #334155;
      cursor: pointer;
      margin-left: 0.2em;
      transition: background .17s;
    }
    .copy-btn:hover { background: #e0e7ef;}
    body.dark .copy-btn { background: #232329; color: #f1f5f9; border-color: #475569;}
    .edit-anggota-textarea {
      min-height: 90px;
      resize: vertical;
      font-family: inherit;
      font-size: 0.97em;
      padding: .6em .8em !important;
      width: 100%;
      border-radius: .4em;
      background: #fff;
    }
    body.dark .edit-anggota-textarea {
      background: #232329;
      color: #f1f5f9;
      border-color: #475569;
    }
    .edit-anggota-label {
      font-size: 0.97em;
      font-weight: 500;
      margin-bottom: 0.2em;
      display: block;
    }
    .wa-preview {
      background: #f7fdf9;
      color: #2d4736;
      border: 1px solid #25D366;
      border-radius: 1em;
      font-family: "Segoe UI", Arial, sans-serif;
      font-size: 1.009em;
      line-height: 1.65;
      padding: 1em 1.2em;
      min-height: 120px;
      word-break: break-word;
      letter-spacing: 0.01em;
      box-shadow: 0 1px 8px #0001;
      margin-bottom: 0.2em;
    }
    body.dark .wa-preview {
      background: #17291e;
      color: #e9ffe2;
      border-color: #25D366;
    }
    .card-table th, .card-table td {
      @apply border px-2 py-1;
    }
    .card-table th { @apply bg-slate-200 dark:bg-slate-700;}
    .card-table {
      @apply w-full rounded-xl overflow-hidden text-sm mt-2;
    }
    @media (max-width:600px) {
      .card { padding: 0.7rem !important; }
      .card-section { padding: 0.75rem !important;}
      .wa-preview { font-size: 0.99em; padding: 0.8em !important;}
      .wa-btn { font-size: 0.97em; padding: 0.42em 1em;}
      .edit-anggota-textarea { font-size: 0.97em;}
    }
    @media print {
      .no-print { display:none !important;}
      .card, .card-section, .wa-preview { background: #fff !important; color:#222 !important;}
      .card-table th, .card-table td { background: #fff !important; color:#222 !important;}
      .wa-preview { border-color: #bbb !important;}
    }
    /* Overlay & Toast (unchanged) */
    .overlay-bg {
      background: rgba(0,0,0,.58);
      position: fixed; z-index: 1000;
      left:0; top:0; width:100vw; height:100vh;
      display: flex; align-items: center; justify-content: center;
      transition: opacity .25s;
    }
    .overlay-panel {
      background: #fff;
      max-width: 95vw;
      width: 385px;
      border-radius: 1rem;
      padding: 1.3rem 1rem 1.1rem 1rem;
      box-shadow: 0 4px 32px #0002;
      color: #334155;
      position: relative;
      font-size: 15px;
      animation: fadeInOverlay .2s;
    }
    @keyframes fadeInOverlay {
      from { opacity: 0; transform: scale(0.95);}
      to   { opacity: 1; transform: scale(1);}
    }
    body.dark .overlay-panel { background: #232329; color: #f1f5f9;}
    .overlay-panel pre {
      background: #f1f5f9;
      color: #475569;
      font-size: 13px;
      border-radius: .5em;
      margin-top: 12px;
      padding: 0.9em 1em;
      line-height: 1.55;
      white-space: pre-wrap;
    }
    .overlay-panel .close-btn {
      position: absolute;
      right: 1rem;
      top: 1rem;
      font-size: 1.1em;
      color: #94a3b8;
      background: none;
      border: none;
      cursor: pointer;
      transition: color .13s;
    }
    .overlay-panel .close-btn:active, .overlay-panel .close-btn:focus, .overlay-panel .close-btn:hover {
      color: #2563eb;
    }
    .tutorial-step {
      margin-bottom: 1.15em;
      padding-left: 0.4em;
      border-left: 3px solid #2563eb;
      background: #f1f5f9;
      border-radius: .43em;
      padding-top: .5em;
      padding-bottom: .5em;
    }
    body.dark .tutorial-step { background: #232329; }
    .tutorial-list li { margin-bottom: 0.55em;}
  </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 min-h-screen text-slate-700 dark:text-slate-100" id="mainBody">

<div class="max-w-2xl mx-auto mt-6 mb-10">
  <!-- Header Card -->
  <div class="card mb-5 relative">
    <div class="flex items-center gap-2 justify-between mb-2">
      <span class="card-title flex-1">Ronda Malam Scheduler</span>
      <button id="btnShowTutorial" class="no-print px-3 py-1 text-xs bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-200 rounded-lg">Tutorial</button>
    </div>
    <div class="text-slate-500 dark:text-slate-300 text-sm">Jadwalkan, kelola, dan bagikan jadwal ronda malam dengan mudah.</div>
  </div>

  <!-- Main Card Section -->
  <div class="card">

    <!-- Section: Import/Export -->
    <div class="card-section">
      <div class="card-label mb-2">Import / Export Jadwal</div>
      <div class="card-action-bar">
        <input type="file" id="inputFile" accept=".txt,.json" class="hidden" />
        <button id="btnImport" class="px-3 py-1 bg-blue-600 text-white rounded-lg text-xs hover:bg-blue-700">Import TXT/JSON</button>
        <button id="btnExportTxt" class="px-3 py-1 bg-green-600 text-white rounded-lg text-xs hover:bg-green-700">Export TXT</button>
        <button id="btnExportJson" class="px-3 py-1 bg-sky-600 text-white rounded-lg text-xs hover:bg-sky-700">Export JSON</button>
        <button id="btnClear" class="px-3 py-1 bg-red-600 text-white rounded-lg text-xs hover:bg-red-700">Clear Jadwal</button>
        <button id="btnCopyFormatTxt" class="px-3 py-1 bg-slate-100 border border-slate-300 rounded-lg text-xs hover:bg-slate-200 text-slate-700" title="Copy Format TXT">Copy Format TXT</button>
      </div>
    </div>

    <!-- Section: Tanggal Picker -->
    <div class="card-section flex flex-col md:flex-row md:items-center gap-3 mb-4">
      <label class="card-label min-w-[110px] mb-0">Pilih Tanggal:</label>
      <input type="date" id="datePicker" class="border rounded-lg p-2 text-sm flex-1 max-w-xs" />
      <div class="flex gap-2">
        <button id="btnPrev" class="px-3 py-1 text-xs rounded-lg bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 border border-slate-200 dark:border-slate-600 no-print">&lt;</button>
        <button id="btnNext" class="px-3 py-1 text-xs rounded-lg bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 border border-slate-200 dark:border-slate-600 no-print">&gt;</button>
      </div>
    </div>

    <!-- Section: Jadwal Preview Table -->
    <div class="card-section mb-4">
      <div class="card-label">Jadwal Hari Ini</div>
      <table class="card-table">
        <thead>
          <tr>
            <th>Tanggal</th>
            <th>Tim</th>
            <th>Anggota</th>
          </tr>
        </thead>
        <tbody id="previewTableBody"></tbody>
      </table>
      <div id="notFound" class="text-center text-slate-400 p-3"></div>
    </div>

    <!-- Section: Edit -->
    <div id="editRowPanel" class="card-section mb-4 hidden">
      <div class="font-semibold text-base mb-1">Edit Jadwal</div>
      <form id="editForm" class="flex flex-col gap-1">
        <label class="edit-anggota-label">Tanggal: <input type="date" id="editTanggal" class="border rounded-lg p-2 text-sm" required></label>
        <label class="edit-anggota-label">Tim: <input type="text" id="editTeam" class="border rounded-lg p-2 text-sm" required></label>
        <label class="edit-anggota-label" for="editAnggota">Anggota:</label>
        <textarea id="editAnggota" class="edit-anggota-textarea border text-sm" required placeholder="Satu nama per baris"></textarea>
        <div class="flex gap-2 mt-2">
          <button class="px-4 py-1 bg-blue-600 text-white rounded-lg text-xs hover:bg-blue-700" type="submit">Simpan</button>
          <button id="btnCancelEdit" class="px-4 py-1 bg-slate-200 dark:bg-slate-700 rounded-lg text-xs hover:bg-slate-300" type="button">Batal</button>
        </div>
      </form>
    </div>

    <!-- Section: WhatsApp Output & Actions -->
    <div class="card-section">
      <div class="card-label mb-2">Preview & Bagikan Jadwal</div>
      <div class="card-action-bar mb-2" id="waBtnDesktop" style="display:none;">
        <button id="btnShareWA" class="wa-btn" style="min-width:150px;">
          <svg viewBox="0 0 32 32" fill="none" class="wa-icon"><circle cx="16" cy="16" r="16" fill="#25D366"/><path d="M16 6.3c-5.4 0-9.7 4.3-9.7 9.7 0 1.7.5 3.3 1.3 4.7L6 26l5.4-1.7c1.3.7 2.8 1.1 4.3 1.1 5.4 0 9.7-4.3 9.7-9.7S21.4 6.3 16 6.3zm0 17.1c-1.3 0-2.6-.3-3.7-.9l-.3-.2-3.2 1 1-3.1-.2-.3C8.8 18.3 8.4 17.2 8.4 16c0-4.2 3.4-7.6 7.6-7.6s7.6 3.4 7.6 7.6-3.4 7.6-7.6 7.6zm4.1-5.7c-.2-.1-1.2-.6-1.3-.7-.2-.1-.3-.1-.5.1-.1.2-.6.7-.7.8-.1.1-.2.2-.5.1-1.1-.4-2-1.1-2.7-2-.2-.2.1-.3.2-.4.1-.1.2-.2.3-.4.1-.2 0-.3-.1-.5-.1-.1-.5-1.3-.7-1.7-.2-.4-.3-.3-.5-.3-.2 0-.3 0-.5 0-.2.1-.5.2-.8.5-.3.3-1.1 1.1-1.1 2.6 0 1.4 1.2 2.8 1.4 2.9.2.1 2.3 1.5 4.5 1.5 2.2 0 3.5-1.5 3.6-2.9.2-.3.2-.4 0-.5z" fill="#fff"/></svg>
          Bagikan WhatsApp
        </button>
        <button id="btnCopyWA" class="copy-btn">Copy Text</button>
        <button id="btnEditRow" class="copy-btn">Edit Baris</button>
        <button id="btnPrint" class="copy-btn">Print</button>
      </div>
      <div id="waOutput" class="wa-preview"></div>
    </div>
  </div>
</div>

<!-- Overlay Tutorial -->
<div id="tutorialOverlay" class="overlay-bg" style="display:none;">
  <div class="overlay-panel" style="max-width: 540px;">
    <button class="close-btn" id="btnCloseTutorial" title="Tutup">&times;</button>
    <div class="font-semibold text-base mb-2 text-center">Tutorial Penggunaan Ronda Malam Scheduler</div>
    <div class="text-sm">
      <div class="tutorial-step">
        <b>1. Import Jadwal</b>  
        <ul class="tutorial-list list-disc pl-5">
          <li>Gunakan tombol <b>Import TXT/JSON</b> untuk memasukkan jadwal dari file TXT atau JSON.</li>
          <li>Format TXT: <i>Hari, Tanggal, Tim, Anggota1; Anggota2; ...</i></li>
        </ul>
      </div>
      <div class="tutorial-step">
        <b>2. Navigasi &amp; Edit Jadwal</b>
        <ul class="tutorial-list list-disc pl-5">
          <li>Pilih tanggal menggunakan picker, atau gunakan tombol <b>&lt;</b> dan <b>&gt;</b> untuk berpindah hari.</li>
          <li>Edit jadwal per hari dengan klik <b>Edit Baris</b> lalu simpan perubahan.</li>
        </ul>
      </div>
      <div class="tutorial-step">
        <b>3. Bagikan Jadwal ke WhatsApp</b>
        <ul class="tutorial-list list-disc pl-5">
          <li>Tombol WhatsApp akan tampil otomatis di bawah pada perangkat mobile jika jadwal tersedia.</li>
          <li>Di desktop, gunakan tombol "Bagikan WhatsApp" atau copy teks lalu paste ke aplikasi chat lain.</li>
        </ul>
      </div>
      <div class="tutorial-step">
        <b>4. Export/Backup Jadwal</b>
        <ul class="tutorial-list list-disc pl-5">
          <li><b>Export TXT</b>: simpan jadwal dalam format teks mudah dibaca.</li>
          <li><b>Export JSON</b>: simpan seluruh data untuk backup/restore.</li>
          <li><b>Copy Format TXT</b>: salin seluruh jadwal dalam format teks terstruktur.</li>
        </ul>
      </div>
      <div class="tutorial-step">
        <b>5. Lain-lain</b>
        <ul class="tutorial-list list-disc pl-5">
          <li><b>Clear Jadwal</b>: hapus seluruh jadwal (permanen).</li>
          <li><b>Print</b>: cetak jadwal hari ini langsung dari browser.</li>
        </ul>
      </div>
    </div>
    <div class="mt-2 text-xs text-center text-slate-500">
      Fitur akan terus dikembangkan sesuai kebutuhan ronda Anda.
    </div>
  </div>
</div>

<!-- Mobile Sticky WhatsApp Action Bar -->
<div id="waActionBar" class="wa-action-bar no-print" style="display:none;">
  <button id="btnShareWAMobile" class="wa-btn" style="font-size:1.1em;">
    <svg viewBox="0 0 32 32" fill="none" class="wa-icon"><circle cx="16" cy="16" r="16" fill="#25D366"/><path d="M16 6.3c-5.4 0-9.7 4.3-9.7 9.7 0 1.7.5 3.3 1.3 4.7L6 26l5.4-1.7c1.3.7 2.8 1.1 4.3 1.1 5.4 0 9.7-4.3 9.7-9.7S21.4 6.3 16 6.3zm0 17.1c-1.3 0-2.6-.3-3.7-.9l-.3-.2-3.2 1 1-3.1-.2-.3C8.8 18.3 8.4 17.2 8.4 16c0-4.2 3.4-7.6 7.6-7.6s7.6 3.4 7.6 7.6-3.4 7.6-7.6 7.6zm4.1-5.7c-.2-.1-1.2-.6-1.3-.7-.2-.1-.3-.1-.5.1-.1.2-.6.7-.7.8-.1.1-.2.2-.5.1-1.1-.4-2-1.1-2.7-2-.2-.2.1-.3.2-.4.1-.1.2-.2.3-.4.1-.2 0-.3-.1-.5-.1-.1-.5-1.3-.7-1.7-.2-.4-.3-.3-.5-.3-.2 0-.3 0-.5 0-.2.1-.5.2-.8.5-.3.3-1.1 1.1-1.1 2.6 0 1.4 1.2 2.8 1.4 2.9.2.1 2.3 1.5 4.5 1.5 2.2 0 3.5-1.5 3.6-2.9.2-.3.2-.4 0-.5z" fill="#fff"/></svg>
    WhatsApp
  </button>
  <button id="btnCopyWAMobile" class="copy-btn">Copy</button>
  <button id="btnEditRowMobile" class="copy-btn">Edit</button>
  <button id="btnPrintMobile" class="copy-btn">Print</button>
</div>

<!-- Toast Notification -->
<div id="toast" class="fixed left-1/2 bottom-7 px-4 py-2 rounded shadow text-white bg-slate-800 text-sm z-50 transition-all" style="display:none;transform:translateX(-50%);"></div>

<script>
let jadwalArr = [];
let currentTanggal = null;
let editIdx = null;
const STORAGE_KEY = "ronda_jadwal_v3";
const randomKata2 = [
  "Keamanan Kita Prioritas!",
  "Utamakan Siskamling, Nyaman Bersama!",
  "Bersama, Lingkungan Aman Nyaman!",
  "Jaga Lingkungan, Jaga Keluarga!",
  "Satukan Langkah, Aman Bersama!",
  "Ronda untuk Harmoni Bersama!",
  "Bersatu Menjaga, Damai Dirasa!",
  "Bersama kita lebih kuat!",
  "Ronda Malam, Wujud Peduli!",
  "Ayo Jaga Malam, Demi Kenyamanan!"
];

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.display = '';
  t.style.opacity = '1';
  setTimeout(() => { t.style.opacity = '0'; }, 1600);
  setTimeout(() => { t.style.display = 'none'; }, 1900);
}

// Format dan parsing tanggal (ID)
function pad(n){ return n<10?'0'+n:n; }
function formatTanggalLong(iso){
  const hari=['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'];
  const bulan=['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];
  let d=new Date(iso);
  if(isNaN(d)) return iso;
  return `${hari[d.getDay()]}, ${d.getDate()} ${bulan[d.getMonth()]} ${d.getFullYear()}`;
}
function parseTanggalToISO(s){
  s=s.trim().replace(/^[A-Za-z]+,\s*/,'');
  let [tgl,bln,th]=s.split(' ');
  if(!tgl||!bln||!th)return null;
  const bulan={Januari:1,Februari:2,Maret:3,April:4,Mei:5,Juni:6,Juli:7,Agustus:8,September:9,Oktober:10,November:11,Desember:12,
    Jan:1,Feb:2,Mar:3,Apr:4,Mei:5,Jun:6,Jul:7,Agu:8,Sep:9,Okt:10,Nov:11,Des:12};
  let m=bulan[bln];
  if(!m)return null;
  return `${th}-${pad(m)}-${pad(parseInt(tgl,10))}`;
}

// Parse TXT
function parseJadwalTxt(txt){
  const lines=txt.split('\n').map(l=>l.trim()).filter(l=>!!l&&!/Jadwal\s+Tim/i.test(l));
  let res=[];
  for(let line of lines){
    let parts=line.split(',');
    if(parts.length<4)continue;
    let tanggal=parts[1].trim();
    let team=parts[2].trim();
    let membersRaw=parts.slice(3).join(',').trim();
    let members=membersRaw.split(';').map(m=>m.trim()).filter(Boolean);
    let iso=parseTanggalToISO(parts[0]+','+tanggal)||parseTanggalToISO(tanggal);
    if(!iso)continue;
    res.push({date:iso,team,members});
  }
  return res.sort((a,b)=>a.date.localeCompare(b.date));
}

// LocalStorage
function saveJadwal(arr){ localStorage.setItem(STORAGE_KEY,JSON.stringify(arr)); }
function loadJadwal(){ let d=localStorage.getItem(STORAGE_KEY); try{return d?JSON.parse(d):[];}catch{return [];} }

// Cari index berdasar tanggal
function findByTanggal(tanggal) {
  return jadwalArr.findIndex(j=>j.date===tanggal);
}

// Render Tabel Preview
function renderPreview() {
  const tbody = document.getElementById('previewTableBody');
  const notFound = document.getElementById('notFound');
  tbody.innerHTML = '';
  notFound.textContent = '';
  let idx = findByTanggal(currentTanggal);
  if(idx===-1) {
    notFound.textContent = "Tidak ada jadwal untuk tanggal ini.";
    toggleWAActionBar(false);
    toggleBtnDesktopWA(false);
    return;
  }
  let j = jadwalArr[idx];
  let tr = document.createElement('tr');
  tr.innerHTML = `
    <td>${formatTanggalLong(j.date)}</td>
    <td class="font-semibold">${j.team}</td>
    <td>${j.members.map(m=>`<span class="inline-block bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded px-2 mr-1 mb-1">${m}</span>`).join('')}</td>
  `;
  tbody.appendChild(tr);
  toggleWAActionBar(true);
  toggleBtnDesktopWA(true);
}

// WhatsApp Output
function randomKalimatPenutup() {
  let idx = Math.floor(Math.random()*randomKata2.length);
  return randomKata2[idx];
}
function generateWAOutput() {
  let idx = findByTanggal(currentTanggal);
  if(idx===-1) return 'Tidak ada jadwal untuk tanggal ini.';
  const settings = {
    title: "RONDA MALAM KAISAR RESIDENCE",
    jam: "23.00‚Äì04.00 WIB",
    tz: "WIB"
  };
  let j = jadwalArr[idx];
  // Cari jadwal selanjutnya tim yang sama
  let selanjutnya = jadwalArr.filter(row => row.team === j.team && row.date > j.date)
    .map(row=>`‚Ä¢ ${formatTanggalLong(row.date)}`).join('\n') || '‚Ä¢ -';
  return (
`üî•üö® *${settings.title}* üö®üî•

üìÜ *${formatTanggalLong(j.date)}*  
‚è∞ *Waktu Jaga:* ${settings.jam}  

üë• *${j.team}*  
üëÆ‚Äç‚ôÇÔ∏è *Petugas:*  
${j.members.map(m=>`‚Ä¢ ${m}`).join('\n')}

üìå *Jadwal Selanjutnya ${j.team}:*  
${selanjutnya}

üôè Terima kasih atas partisipasinya.  
Mari jaga lingkungan tetap aman dan nyaman bersama-sama.  

üí• *${randomKalimatPenutup()}* üí•
`
  );
}
function renderWAOutput() {
  document.getElementById('waOutput').textContent = generateWAOutput();
}

// Tanggal picker: set ke earliest/latest jika < atau >
function setTanggalNext(dir) {
  if(!jadwalArr.length) return;
  let idx = findByTanggal(currentTanggal);
  if(idx===-1) {
    currentTanggal = jadwalArr[0].date;
  } else {
    let nextIdx = idx+dir;
    if(nextIdx >=0 && nextIdx < jadwalArr.length) {
      currentTanggal = jadwalArr[nextIdx].date;
    }
  }
  document.getElementById('datePicker').value = currentTanggal;
  renderPreview(); renderWAOutput();
}

// Edit Panel
function showEditPanel(show, idx) {
  const panel = document.getElementById('editRowPanel');
  panel.classList.toggle('hidden', !show);
  if(show) {
    editIdx = idx;
    let j = jadwalArr[idx];
    document.getElementById('editTanggal').value = j.date;
    document.getElementById('editTeam').value = j.team;
    // Show anggota as 1 per line for easier editing
    const anggota = j.members.join('\n');
    const ta = document.getElementById('editAnggota');
    ta.value = anggota;
    // Auto resize textarea to fit content
    setTimeout(()=>{
      ta.style.height = "auto";
      ta.style.height = (ta.scrollHeight+4) + "px";
    },1);
    ta.oninput = function() {
      this.style.height = "auto";
      this.style.height = (this.scrollHeight+4) + "px";
    };
  } else {
    editIdx = null;
  }
}

// Overlay Tutorial
document.getElementById('btnShowTutorial').onclick = function() {
  document.getElementById('tutorialOverlay').style.display = '';
  document.body.style.overflow = 'hidden';
};
document.getElementById('btnCloseTutorial').onclick = function() {
  document.getElementById('tutorialOverlay').style.display = 'none';
  document.body.style.overflow = '';
};
document.getElementById('tutorialOverlay').onclick = function(e){
  if(e.target===this){
    this.style.display='none';
    document.body.style.overflow = '';
  }
};

// Copy Full Format TXT (dari data actual)
document.getElementById('btnCopyFormatTxt').onclick = function() {
  let lines = jadwalArr.map(j=>`${formatTanggalLong(j.date)}, ${j.team}, ${j.members.join('; ')}`);
  navigator.clipboard.writeText(lines.join('\n'));
  showToast('Seluruh jadwal dicopy sebagai format TXT!');
};

// Event Listeners
document.getElementById('datePicker').onchange = function() {
  currentTanggal = this.value;
  renderPreview(); renderWAOutput();
};
document.getElementById('btnPrev').onclick = function() { setTanggalNext(-1); };
document.getElementById('btnNext').onclick = function() { setTanggalNext(1); };

// WhatsApp Desktop
function toggleBtnDesktopWA(show) {
  document.getElementById('waBtnDesktop').style.display = show ? '' : 'none';
}
document.getElementById('btnShareWA').onclick = function() {
  shareToWA();
};
document.getElementById('btnCopyWA').onclick = function() {
  let waText = generateWAOutput();
  navigator.clipboard.writeText(waText).then(()=>showToast('Teks disalin!'));
};
document.getElementById('btnEditRow').onclick = function() {
  let idx = findByTanggal(currentTanggal);
  if(idx===-1) { showToast('Tidak ada jadwal untuk diedit!'); return; }
  showEditPanel(true, idx);
};
document.getElementById('btnPrint').onclick = function(){ window.print(); };

// WhatsApp Mobile Sticky Bar
function toggleWAActionBar(show) {
  let bar = document.getElementById('waActionBar');
  bar.style.display = show ? '' : 'none';
}
document.getElementById('btnShareWAMobile').onclick = function() {
  shareToWA();
};
document.getElementById('btnCopyWAMobile').onclick = function() {
  let waText = generateWAOutput();
  navigator.clipboard.writeText(waText).then(()=>showToast('Teks disalin!'));
};
document.getElementById('btnEditRowMobile').onclick = function() {
  let idx = findByTanggal(currentTanggal);
  if(idx===-1) { showToast('Tidak ada jadwal untuk diedit!'); return; }
  showEditPanel(true, idx);
};
document.getElementById('btnPrintMobile').onclick = function(){ window.print(); };

function shareToWA() {
  let waText = generateWAOutput();
  if(waText.startsWith('Tidak ada')) { showToast('Tidak ada jadwal hari ini.'); return; }
  if (navigator.share) {
    navigator.share({text: waText}).catch(()=>{});
  } else {
    window.open('https://wa.me/?text='+encodeURIComponent(waText), '_blank');
  }
}

// Edit
document.getElementById('btnCancelEdit').onclick = function() {
  showEditPanel(false);
};
document.getElementById('editForm').onsubmit = function(e){
  e.preventDefault();
  if(editIdx===null) return;
  let tgl = document.getElementById('editTanggal').value;
  let tim = document.getElementById('editTeam').value;
  // Ambil anggota dari textarea, tiap baris = 1 anggota, kosong diabaikan
  let anggota = document.getElementById('editAnggota').value
    .split('\n').map(m=>m.trim()).filter(Boolean);
  if(!tgl||!tim||!anggota.length) { showToast('Lengkapi semua input!'); return;}
  jadwalArr[editIdx] = { date: tgl, team: tim, members: anggota };
  saveJadwal(jadwalArr);
  currentTanggal = tgl;
  document.getElementById('datePicker').value = currentTanggal;
  showEditPanel(false);
  renderPreview(); renderWAOutput();
  showToast('Jadwal disimpan!');
};

// Import/Export
document.getElementById('btnImport').onclick=()=>document.getElementById('inputFile').click();
document.getElementById('inputFile').onchange=function(e){
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=ev=>{
    if(f.name.endsWith('.json')){
      try{jadwalArr=JSON.parse(ev.target.result)||[];}catch{showToast('Format JSON salah!');return;}
    }else{
      jadwalArr=parseJadwalTxt(ev.target.result);
    }
    saveJadwal(jadwalArr);
    let today = (new Date()).toISOString().slice(0,10);
    if(findByTanggal(today)!==-1) currentTanggal = today;
    else if(jadwalArr.length) currentTanggal = jadwalArr[0].date;
    document.getElementById('datePicker').value = currentTanggal;
    renderPreview(); renderWAOutput();
    showToast('Berhasil import!');
  };
  r.readAsText(f);
};
document.getElementById('btnExportTxt').onclick=function(){
  let lines=jadwalArr.map(j=>`${formatTanggalLong(j.date)}, ${j.team}, ${j.members.join('; ')}`);
  let blob=new Blob([lines.join('\n')],{type:'text/plain'}),a=document.createElement('a');
  a.href=URL.createObjectURL(blob);a.download="jadwal_ronda.txt";a.click();URL.revokeObjectURL(a.href);showToast('Export TXT!');
};
document.getElementById('btnExportJson').onclick=function(){
  let blob=new Blob([JSON.stringify(jadwalArr,null,2)],{type:'application/json'}),a=document.createElement('a');
  a.href=URL.createObjectURL(blob);a.download="jadwal_ronda.json";a.click();URL.revokeObjectURL(a.href);showToast('Export JSON!');
};
document.getElementById('btnClear').onclick=function(){
  if(confirm('Hapus semua jadwal?')){jadwalArr=[];saveJadwal(jadwalArr);renderPreview();renderWAOutput();}
  let today = (new Date()).toISOString().slice(0,10);
  currentTanggal = today;
  document.getElementById('datePicker').value = today;
};

// INIT: load, set tanggal ke hari ini
window.onload = function() {
  if(window.matchMedia('(prefers-color-scheme: dark)').matches) {
    document.body.classList.add('dark');
  }
  jadwalArr = loadJadwal();
  let today = (new Date()).toISOString().slice(0,10);
  if(findByTanggal(today)!==-1) currentTanggal = today;
  else if(jadwalArr.length) currentTanggal = jadwalArr[0].date;
  else currentTanggal = today;
  document.getElementById('datePicker').value = currentTanggal;
  renderPreview(); renderWAOutput();
};
</script>
</body>
</html>
