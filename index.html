<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Ronda Malam Scheduler</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="dark light">
  <style>
    html { color-scheme: light dark; }
    body { transition: background 0.2s, color 0.2s; }
    @media (max-width:600px) {
      .max-w-2xl { max-width: 100vw !important; }
      .p-4, .p-3 { padding: 0.75rem !important; }
      .rounded { border-radius: 0.6rem !important; }
      table, th, td { font-size: 14px !important; }
      .box { border-radius: 0.8rem !important; }
      .section { padding: 0.8rem 0.7rem !important; }
    }
    @media print {
      body, .bg-white { background: #fff !important; color:#222 !important;}
      .shadow, .rounded, .bg-slate-50, .bg-slate-100, .bg-slate-200 { box-shadow:none !important; border-radius:0 !important; background: #fff !important;}
      .max-w-2xl { max-width: 100vw !important; }
      pre, textarea { background: #fff !important; color: #000 !important;}
      #mainBody { color: #000 !important;}
      .no-print { display:none !important;}
    }
    .overlay-bg {
      background: rgba(0,0,0,.58);
      position: fixed; z-index: 1000;
      left:0; top:0; width:100vw; height:100vh;
      display: flex; align-items: center; justify-content: center;
      transition: opacity .25s;
    }
    .overlay-panel {
      background: #fff;
      max-width: 95vw;
      width: 370px;
      border-radius: 1rem;
      padding: 1.3rem 1rem 1.1rem 1rem;
      box-shadow: 0 4px 32px #0002;
      color: #334155;
      position: relative;
      font-size: 15px;
    }
    body.dark .overlay-panel { background: #232329; color: #f1f5f9;}
    .overlay-panel pre {
      background: #f1f5f9;
      color: #475569;
      font-size: 13px;
      border-radius: .5em;
      margin-top: 12px;
      padding: 0.9em 1em;
      line-height: 1.55;
      white-space: pre-wrap;
    }
    .overlay-panel .close-btn {
      position: absolute;
      right: 1rem;
      top: 1rem;
      font-size: 1.1em;
      color: #94a3b8;
      background: none;
      border: none;
      cursor: pointer;
      transition: color .13s;
    }
    .overlay-panel .close-btn:active, .overlay-panel .close-btn:focus, .overlay-panel .close-btn:hover {
      color: #2563eb;
    }
    .copy-btn {
      background: #f1f5f9;
      border: 1px solid #cbd5e1;
      padding: 0.3em 0.85em;
      font-size: 0.93em;
      border-radius: 0.4em;
      color: #334155;
      cursor: pointer;
      margin-left: 0.2em;
      transition: background .17s;
    }
    .copy-btn:hover { background: #e0e7ef;}
    body.dark .copy-btn { background: #232329; color: #f1f5f9; border-color: #475569;}
    .overflow-x-auto { overflow-x: auto; }
    .box {
      background: #f6ffe9;
      border-radius: 1.1rem;
      padding: 1.1em 0.9em;
      margin-bottom: 1.1rem;
      border: 1px solid #d3fbc2;
    }
    .section {
      padding: 1rem 1rem;
      margin-bottom: 0.8rem;
      border-radius: 0.7em;
      background: #f8fafc;
    }
    .judul {
      font-weight: 700;
      font-size: 1.13em;
      margin-bottom: 0.5em;
      text-align: center;
      color: #2e7d32;
      letter-spacing: .02em;
    }
    .wa-preview {
      font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
      font-size: 1em;
      background: #e9ffe8;
      color: #184d1c;
      border-radius: 0.8em;
      padding: 0.95em 0.9em;
      overflow-x: auto;
      box-shadow: 0 1px 4px #0001;
      line-height: 1.65;
      word-break: break-word;
      margin-bottom: 0.2em;
      margin-top: 1em;
    }
    .wa-preview strong { font-weight: bold; color:#1a7816;}
    .wa-preview em { font-style: italic; }
    .wa-preview ul, .wa-preview li { margin-bottom: 0; }
    .wa-preview .next-dates {margin-bottom:0.3em;}
    .wa-preview .thanks { margin-top: 0.5em; }
    .wa-preview .closing { font-weight: bold; color: #2563eb; margin-top: 0.6em;}
    .wa-preview .icon { font-size:1.2em; vertical-align:middle;}
    /* Mobile scroll for box */
    @media (max-width:520px) {
      .wa-preview { font-size: 0.97em; padding: 0.85em 0.5em;}
      .box { padding: 0.7em 0.4em;}
      .section { padding: 0.6em 0.5em;}
    }
  </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-700" id="mainBody">

<div class="max-w-2xl mx-auto mt-2 p-2 md:p-4 bg-white rounded shadow">
  <div class="flex items-center justify-between mb-2">
    <h1 class="text-lg md:text-xl font-bold text-center flex-1">Ronda Malam Scheduler</h1>
    <button id="btnShowFormat" class="no-print px-2 py-1 text-xs bg-slate-200 rounded ml-2">Format TXT</button>
  </div>
  <!-- Import / Export -->
  <div class="flex flex-wrap gap-2 mb-3 no-print justify-center">
    <input type="file" id="inputFile" accept=".txt,.json" class="hidden" />
    <button id="btnImport" class="px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">Import TXT</button>
    <button id="btnExportTxt" class="px-3 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700">Export TXT</button>
    <button id="btnExportJson" class="px-3 py-1 bg-sky-600 text-white rounded text-xs hover:bg-sky-700">Export JSON</button>
    <button id="btnClear" class="px-3 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700">Clear Jadwal</button>
    <button id="btnCopyFormatTxt" class="px-3 py-1 bg-slate-100 border border-slate-300 rounded text-xs hover:bg-slate-200" title="Copy Format TXT">Copy Format TXT</button>
  </div>
  <!-- Tanggal Picker -->
  <div class="flex flex-col md:flex-row md:items-center gap-2 mb-3">
    <label class="font-semibold flex-shrink-0 min-w-[110px]">Pilih Tanggal:</label>
    <input type="date" id="datePicker" class="border rounded p-1 text-sm flex-1 max-w-xs" />
    <button id="btnPrev" class="px-2 py-1 text-xs rounded bg-slate-100 hover:bg-slate-200 border border-slate-200 no-print">&lt;</button>
    <button id="btnNext" class="px-2 py-1 text-xs rounded bg-slate-100 hover:bg-slate-200 border border-slate-200 no-print">&gt;</button>
  </div>
  <!-- Preview Tabel -->
  <div id="previewContainer" class="mb-3 overflow-x-auto">
    <table class="w-full border text-sm rounded overflow-hidden min-w-[360px]">
      <thead>
        <tr class="bg-slate-200 dark:bg-slate-700">
          <th class="p-2 border">Tanggal</th>
          <th class="p-2 border">Tim</th>
          <th class="p-2 border">Anggota</th>
        </tr>
      </thead>
      <tbody id="previewTableBody"></tbody>
    </table>
    <div id="notFound" class="text-center text-slate-400 p-3"></div>
  </div>
  <!-- Edit -->
  <div id="editRowPanel" class="mb-3 hidden">
    <div class="bg-slate-100 rounded p-2 mb-2">
      <div class="mb-2 font-semibold">Edit Jadwal</div>
      <form id="editForm" class="flex flex-col gap-1">
        <label>Tanggal: <input type="date" id="editTanggal" class="border rounded p-1 text-sm" required></label>
        <label>Tim: <input type="text" id="editTeam" class="border rounded p-1 text-sm" required></label>
        <label>Anggota: <input type="text" id="editAnggota" class="border rounded p-1 text-sm" required></label>
        <div class="flex gap-2 mt-2">
          <button class="px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700" type="submit">Simpan</button>
          <button id="btnCancelEdit" class="px-3 py-1 bg-slate-200 rounded text-xs hover:bg-slate-300" type="button">Batal</button>
        </div>
      </form>
    </div>
  </div>
  <!-- WhatsApp Output -->
  <div class="bg-slate-50 section wa-preview">
    <div id="waOutput"></div>
    <div class="flex gap-2 mt-3 no-print">
      <button id="btnCopyWA" class="px-3 py-1 bg-slate-200 rounded text-xs hover:bg-slate-300">Copy Teks Jadwal</button>
      <button id="btnEditRow" class="px-3 py-1 bg-yellow-100 border border-yellow-400 text-yellow-900 rounded text-xs hover:bg-yellow-200">Edit Baris</button>
      <button id="btnPrint" class="px-3 py-1 bg-slate-200 rounded text-xs hover:bg-slate-300">Print</button>
    </div>
  </div>
</div>

<!-- Overlay Format -->
<div id="formatOverlay" class="overlay-bg" style="display:none;">
  <div class="overlay-panel">
    <button class="close-btn" id="btnCloseFormat" title="Tutup">&times;</button>
    <div class="font-semibold text-base mb-2 text-center">Format File TXT Jadwal Ronda</div>
    <div>
      <ul class="mb-3 pl-4 text-sm list-disc">
        <li>Setiap baris <b>= 1 jadwal</b> (1 hari, 1 tim)</li>
        <li>Pemisah antar item: <b>koma ( , )</b></li>
        <li>Format: <b>Hari, Tanggal, Tim, Anggota1; Anggota2; ...</b></li>
        <li>Contoh:</li>
      </ul>
      <pre id="exampleFormat">
Rabu, 11 Juni 2025, Tim 1, Putra A.01; Hendra Ds. A.09; Ali B.15
Kamis, 12 Juni 2025, Tim 2, Ridho A.02; Kamil A.06; Rudi Hartono B.16
      </pre>
      <button id="copyFormatExample" class="copy-btn">Copy Format</button>
      <div class="mt-2 text-xs text-slate-500">Anggota dipisahkan titik koma ( ; )</div>
    </div>
  </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="fixed left-1/2 bottom-7 px-4 py-2 rounded shadow text-white bg-slate-800 text-sm z-50 transition-all" style="display:none;transform:translateX(-50%);"></div>

<script>
let jadwalArr = [];
let currentTanggal = null;
let editIdx = null;
const STORAGE_KEY = "ronda_jadwal_v3";
const randomKata2 = [
  "Keamanan Kita Prioritas!",
  "Utamakan Siskamling, Nyaman Bersama!",
  "Bersama, Lingkungan Aman Nyaman!",
  "Jaga Lingkungan, Jaga Keluarga!",
  "Satukan Langkah, Aman Bersama!",
  "Ronda untuk Harmoni Bersama!",
  "Bersatu Menjaga, Damai Dirasa!",
  "Bersama kita lebih kuat!",
  "Ronda Malam, Wujud Peduli!",
  "Ayo Jaga Malam, Demi Kenyamanan!"
];

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.display = '';
  t.style.opacity = '1';
  setTimeout(() => { t.style.opacity = '0'; }, 1600);
  setTimeout(() => { t.style.display = 'none'; }, 1900);
}

// Format dan parsing tanggal (ID)
function pad(n){ return n<10?'0'+n:n; }
function formatTanggalLong(iso){
  const hari=['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'];
  const bulan=['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];
  let d=new Date(iso);
  if(isNaN(d)) return iso;
  return `${hari[d.getDay()]}, ${d.getDate()} ${bulan[d.getMonth()]} ${d.getFullYear()}`;
}
function parseTanggalToISO(s){
  s=s.trim().replace(/^[A-Za-z]+,\s*/,'');
  let [tgl,bln,th]=s.split(' ');
  if(!tgl||!bln||!th)return null;
  const bulan={Januari:1,Februari:2,Maret:3,April:4,Mei:5,Juni:6,Juli:7,Agustus:8,September:9,Oktober:10,November:11,Desember:12,
    Jan:1,Feb:2,Mar:3,Apr:4,Mei:5,Jun:6,Jul:7,Agu:8,Sep:9,Okt:10,Nov:11,Des:12};
  let m=bulan[bln];
  if(!m)return null;
  return `${th}-${pad(m)}-${pad(parseInt(tgl,10))}`;
}

// Parse TXT
function parseJadwalTxt(txt){
  const lines=txt.split('\n').map(l=>l.trim()).filter(l=>!!l&&!/Jadwal\s+Tim/i.test(l));
  let res=[];
  for(let line of lines){
    let parts=line.split(',');
    if(parts.length<4)continue;
    let tanggal=parts[1].trim();
    let team=parts[2].trim();
    let membersRaw=parts.slice(3).join(',').trim();
    let members=membersRaw.split(';').map(m=>m.trim()).filter(Boolean);
    let iso=parseTanggalToISO(parts[0]+','+tanggal)||parseTanggalToISO(tanggal);
    if(!iso)continue;
    res.push({date:iso,team,members});
  }
  return res.sort((a,b)=>a.date.localeCompare(b.date));
}

// LocalStorage
function saveJadwal(arr){ localStorage.setItem(STORAGE_KEY,JSON.stringify(arr)); }
function loadJadwal(){ let d=localStorage.getItem(STORAGE_KEY); try{return d?JSON.parse(d):[];}catch{return [];} }

// Cari index berdasar tanggal
function findByTanggal(tanggal) {
  return jadwalArr.findIndex(j=>j.date===tanggal);
}

// Render Tabel Preview
function renderPreview() {
  const tbody = document.getElementById('previewTableBody');
  const notFound = document.getElementById('notFound');
  tbody.innerHTML = '';
  notFound.textContent = '';
  let idx = findByTanggal(currentTanggal);
  if(idx===-1) {
    notFound.textContent = "Tidak ada jadwal untuk tanggal ini.";
    return;
  }
  let j = jadwalArr[idx];
  let tr = document.createElement('tr');
  tr.innerHTML = `
    <td class="border p-2">${formatTanggalLong(j.date)}</td>
    <td class="border p-2 font-semibold">${j.team}</td>
    <td class="border p-2">${j.members.map(m=>`<span class="inline-block bg-blue-100 rounded px-2 mr-1 mb-1">${m}</span>`).join('')}</td>
  `;
  tbody.appendChild(tr);
}

// WhatsApp Output (stylized, not using share)
function randomKalimatPenutup() {
  let idx = Math.floor(Math.random()*randomKata2.length);
  return randomKata2[idx];
}
function generateWAOutputHTML() {
  let idx = findByTanggal(currentTanggal);
  if(idx===-1) return '<span class="block text-slate-400">Tidak ada jadwal untuk tanggal ini.</span>';
  const settings = {
    title: "RONDA MALAM KAISAR RESIDENCE",
    jam: "23.00‚Äì04.00 WIB",
    tz: "WIB"
  };
  let j = jadwalArr[idx];
  // Cari jadwal selanjutnya tim yang sama
  let selanjutnya = jadwalArr.filter(row => row.team === j.team && row.date > j.date)
    .map(row=>`<li>${formatTanggalLong(row.date)}</li>`).join('') || '<li>-</li>';
  return `
<div class="judul">üî∑üî∑ <span>${settings.title}</span> üî∑üî∑</div>
<div class="mb-2"><span class="icon">üìÖ</span> <strong>${formatTanggalLong(j.date)}</strong><br>
<span class="icon">‚è∞</span> <strong>Waktu Jaga:</strong> ${settings.jam}</div>
<div><span class="icon">üë•</span> <strong>${j.team}</strong></div>
<div><span class="icon">üßë‚Äç‚úàÔ∏è</span> <strong>Petugas:</strong>
  <ul class="ml-4 mt-1 mb-2">
   ${j.members.map(m=>`<li>${m}</li>`).join('')}
  </ul>
</div>
<div class="next-dates mb-2"><span class="icon">üìå</span> <strong>Jadwal Selanjutnya ${j.team}:</strong>
  <ul class="ml-4 mt-1">${selanjutnya}</ul>
</div>
<div class="thanks">üôè Terima kasih atas partisipasinya.<br>
Mari jaga lingkungan tetap aman dan nyaman bersama-sama.</div>
<div class="closing mt-1">üî∑ <b>${randomKalimatPenutup()}</b> üî∑</div>
`;
}
function generateWAOutputTxt() {
  let idx = findByTanggal(currentTanggal);
  if(idx===-1) return 'Tidak ada jadwal untuk tanggal ini.';
  const settings = {
    title: "RONDA MALAM KAISAR RESIDENCE",
    jam: "23.00‚Äì04.00 WIB",
    tz: "WIB"
  };
  let j = jadwalArr[idx];
  let selanjutnya = jadwalArr.filter(row => row.team === j.team && row.date > j.date)
    .map(row=>`- ${formatTanggalLong(row.date)}`).join('\n') || '-';
  return (
`üî∑üî∑ ${settings.title} üî∑üî∑

üìÖ ${formatTanggalLong(j.date)}
‚è∞ Waktu Jaga: ${settings.jam}

üë• ${j.team}
üßë‚Äç‚úàÔ∏è Petugas:
${j.members.map(m=>`- ${m}`).join('\n')}

üìå Jadwal Selanjutnya ${j.team}:
${selanjutnya}

üôè Terima kasih atas partisipasinya.
Mari jaga lingkungan tetap aman dan nyaman bersama-sama.

üî∑ ${randomKalimatPenutup()} üî∑
`
  );
}
function renderWAOutput() {
  document.getElementById('waOutput').innerHTML = generateWAOutputHTML();
}
// Copy WA Output
document.getElementById('btnCopyWA').onclick = function() {
  let txt = generateWAOutputTxt();
  navigator.clipboard.writeText(txt);
  showToast('Teks jadwal dicopy!');
};
// Print
document.getElementById('btnPrint').onclick = function(){ window.print(); };

// Edit
document.getElementById('btnEditRow').onclick = function() {
  let idx = findByTanggal(currentTanggal);
  if(idx===-1) { showToast('Tidak ada jadwal untuk diedit!'); return; }
  showEditPanel(true, idx);
};
document.getElementById('btnCancelEdit').onclick = function() {
  showEditPanel(false);
};
document.getElementById('editForm').onsubmit = function(e){
  e.preventDefault();
  if(editIdx===null) return;
  let tgl = document.getElementById('editTanggal').value;
  let tim = document.getElementById('editTeam').value;
  let anggota = document.getElementById('editAnggota').value;
  if(!tgl||!tim||!anggota) { showToast('Lengkapi semua input!'); return;}
  jadwalArr[editIdx] = { date: tgl, team: tim, members: anggota.split(';').map(m=>m.trim()).filter(Boolean) };
  saveJadwal(jadwalArr);
  currentTanggal = tgl;
  document.getElementById('datePicker').value = currentTanggal;
  showEditPanel(false);
  renderPreview(); renderWAOutput();
  showToast('Jadwal disimpan!');
};

// Overlay Format
document.getElementById('btnShowFormat').onclick = function() {
  document.getElementById('formatOverlay').style.display = '';
  document.body.style.overflow = 'hidden';
};
document.getElementById('btnCloseFormat').onclick = function() {
  document.getElementById('formatOverlay').style.display = 'none';
  document.body.style.overflow = '';
};
document.getElementById('formatOverlay').onclick = function(e){
  if(e.target===this){
    this.style.display='none';
    document.body.style.overflow = '';
  }
};
// Copy Format Example
document.getElementById('copyFormatExample').onclick = function() {
  const txt = document.getElementById('exampleFormat').innerText;
  navigator.clipboard.writeText(txt);
  showToast('Format TXT dicopy!');
};
// Copy Full Format TXT (dari data actual)
document.getElementById('btnCopyFormatTxt').onclick = function() {
  let lines = jadwalArr.map(j=>`${formatTanggalLong(j.date)}, ${j.team}, ${j.members.join('; ')}`);
  navigator.clipboard.writeText(lines.join('\n'));
  showToast('Seluruh jadwal dicopy sebagai format TXT!');
};

// Tanggal picker: set ke earliest/latest jika < atau >
function setTanggalNext(dir) {
  if(!jadwalArr.length) return;
  let idx = findByTanggal(currentTanggal);
  if(idx===-1) {
    currentTanggal = jadwalArr[0].date;
  } else {
    let nextIdx = idx+dir;
    if(nextIdx >=0 && nextIdx < jadwalArr.length) {
      currentTanggal = jadwalArr[nextIdx].date;
    }
  }
  document.getElementById('datePicker').value = currentTanggal;
  renderPreview(); renderWAOutput();
}

document.getElementById('datePicker').onchange = function() {
  currentTanggal = this.value;
  renderPreview(); renderWAOutput();
};
document.getElementById('btnPrev').onclick = function() { setTanggalNext(-1); };
document.getElementById('btnNext').onclick = function() { setTanggalNext(1); };

// Import/Export
document.getElementById('btnImport').onclick=()=>document.getElementById('inputFile').click();
document.getElementById('inputFile').onchange=function(e){
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=ev=>{
    if(f.name.endsWith('.json')){
      try{jadwalArr=JSON.parse(ev.target.result)||[];}catch{showToast('Format JSON salah!');return;}
    }else{
      jadwalArr=parseJadwalTxt(ev.target.result);
    }
    saveJadwal(jadwalArr);
    let today = (new Date()).toISOString().slice(0,10);
    if(findByTanggal(today)!==-1) currentTanggal = today;
    else if(jadwalArr.length) currentTanggal = jadwalArr[0].date;
    document.getElementById('datePicker').value = currentTanggal;
    renderPreview(); renderWAOutput();
    showToast('Berhasil import!');
  };
  r.readAsText(f);
};
document.getElementById('btnExportTxt').onclick=function(){
  let lines=jadwalArr.map(j=>`${formatTanggalLong(j.date)}, ${j.team}, ${j.members.join('; ')}`);
  let blob=new Blob([lines.join('\n')],{type:'text/plain'}),a=document.createElement('a');
  a.href=URL.createObjectURL(blob);a.download="jadwal_ronda.txt";a.click();URL.revokeObjectURL(a.href);showToast('Export TXT!');
};
document.getElementById('btnExportJson').onclick=function(){
  let blob=new Blob([JSON.stringify(jadwalArr,null,2)],{type:'application/json'}),a=document.createElement('a');
  a.href=URL.createObjectURL(blob);a.download="jadwal_ronda.json";a.click();URL.revokeObjectURL(a.href);showToast('Export JSON!');
};
document.getElementById('btnClear').onclick=function(){
  if(confirm('Hapus semua jadwal?')){jadwalArr=[];saveJadwal(jadwalArr);renderPreview();renderWAOutput();}
  let today = (new Date()).toISOString().slice(0,10);
  currentTanggal = today;
  document.getElementById('datePicker').value = today;
};

// INIT: load, set tanggal ke hari ini
window.onload = function() {
  if(window.matchMedia('(prefers-color-scheme: dark)').matches) {
    document.body.classList.add('dark');
  }
  jadwalArr = loadJadwal();
  let today = (new Date()).toISOString().slice(0,10);
  if(findByTanggal(today)!==-1) currentTanggal = today;
  else if(jadwalArr.length) currentTanggal = jadwalArr[0].date;
  else currentTanggal = today;
  document.getElementById('datePicker').value = currentTanggal;
  renderPreview(); renderWAOutput();
};
</script>
</body>
</html>
