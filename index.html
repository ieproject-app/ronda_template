<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
  <title>Ronda Malam Scheduler</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="dark light">
  <style>
    html { color-scheme: light dark; }
    body { transition: background 0.2s, color 0.2s; font-family: 'Segoe UI', Arial, sans-serif; }
    .main-container { padding-bottom: 96px; }
    @media (min-width:601px) {.main-container { padding-bottom: 0 !important; }}
    @media (max-width:600px) {
      .max-w-2xl { max-width: 100vw !important; }
      .main-container { padding-bottom: 96px !important; }
      .p-4, .p-3 { padding: 0.85rem !important; }
      .rounded { border-radius: 0.6rem !important; }
      table, th, td { font-size: 14px !important; }
    }
    @media print {
      .no-print, .mobile-action-bar { display:none !important;}
      .main-container { padding-bottom: 0 !important; }
    }
    .copy-btn {
      background: #f1f5f9;
      border: 1px solid #cbd5e1;
      padding: 0.3em 0.85em;
      font-size: 0.93em;
      border-radius: 0.4em;
      color: #334155;
      cursor: pointer;
      margin-left: 0.2em;
      transition: background .17s;
    }
    .copy-btn:hover { background: #e0e7ef;}
    body.dark .copy-btn { background: #232329; color: #f1f5f9; border-color: #475569;}
    .wa-preview {
      background: #f7fdf9;
      color: #2d4736;
      border: 1px solid #25D366;
      border-radius: .6em;
      font-size: 1.009em;
      line-height: 1.65;
      padding: 0.9em 1em;
      margin-bottom: 0.5em;
      min-height: 120px;
      word-break: break-word;
      letter-spacing: 0.01em;
      box-shadow: 0 1px 8px #0001;
    }
    body.dark .wa-preview {
      background: #17291e;
      color: #e9ffe2;
      border-color: #25D366;
    }
    .wa-btn-group {
      display: flex;
      gap: 0.7em;
      justify-content: flex-end;
      margin-bottom: 0.4em;
    }
    @media (max-width:600px) {.wa-btn-group { display: none !important;}}
    @media (min-width:601px) {.wa-btn-group { display: flex !important;}}
    .edit-anggota-textarea {
      min-height: 90px;
      resize: vertical;
      font-family: inherit;
      font-size: 0.97em;
      padding: .6em .8em !important;
      width: 100%;
      border-radius: .4em;
      background: #fff;
    }
    body.dark .edit-anggota-textarea {
      background: #232329;
      color: #f1f5f9;
      border-color: #475569;
    }
    .edit-anggota-label {
      font-size: 0.97em;
      font-weight: 500;
      margin-bottom: 0.2em;
      display: block;
    }
    .mobile-action-bar {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      z-index: 1100;
      background: #fff;
      border-top: 1px solid #e5e7eb;
      box-shadow: 0 -1px 10px #0002;
      display: flex;
      gap: 0.8em;
      padding: 0.7em 0.8em;
      justify-content: space-evenly;
      align-items: center;
      transition: transform 0.2s;
    }
    .mobile-action-bar .copy-btn { flex:1; min-width:0; }
    body.dark .mobile-action-bar { background: #232329; border-top-color: #334155;}
    @media (min-width:601px) {.mobile-action-bar { display:none !important;}}
    @media print {.mobile-action-bar { display:none !important;}}
    /* Overlay tutorial simple */
    .simple-tutorial-bg {
      background: rgba(0,0,0,.5);
      position: fixed; z-index: 1000;
      left:0; top:0; width:100vw; height:100vh;
      display: flex; align-items: center; justify-content: center;
      transition: opacity .25s;
    }
    .simple-tutorial-panel {
      background: #fff;
      max-width: 90vw;
      width: 340px;
      border-radius: 1em;
      padding: 1.1em 1.2em;
      box-shadow: 0 4px 32px #0002;
      color: #334155;
      position: relative;
      font-size: 15px;
      animation: fadeInOverlay .2s;
    }
    @media (max-width:400px) {
      .simple-tutorial-panel { width:98vw; font-size:14px;}
    }
    body.dark .simple-tutorial-panel { background: #232329; color: #e7e7e7;}
    .simple-tutorial-panel .close-btn {
      position: absolute;
      right: 1em; top: 1em;
      font-size: 1.25em;
      color: #94a3b8;
      background: none;
      border: none;
      cursor: pointer;
    }
    .simple-tutorial-panel .close-btn:active,
    .simple-tutorial-panel .close-btn:focus,
    .simple-tutorial-panel .close-btn:hover { color: #2563eb; }
    .simple-tutorial-panel ul { margin-top:0.6em; margin-bottom:0.6em; }
    .simple-tutorial-panel li { margin-bottom:0.37em;}
    /* Mobile: date picker + next/prev on one row */
    @media (max-width:600px) {
      .tanggal-picker-mobile {
        flex-direction: column;
        gap: 0.7em;
      }
      .tanggal-picker-btns {
        display: flex;
        flex-direction: row;
        gap: 0.7em;
        width: 100%;
      }
      .tanggal-picker-btns button { flex:1; }
    }
    @media (min-width:601px) {
      .tanggal-picker-mobile { flex-direction: row; }
      .tanggal-picker-btns { gap:0.7em; }
    }
  </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-700 font-sans" id="mainBody">

<div class="main-container max-w-2xl w-full mx-auto mt-2 p-4 md:p-6 bg-white dark:bg-slate-800 rounded shadow relative">
  <div class="flex items-center justify-between mb-2">
    <h1 class="text-lg md:text-xl font-bold text-center flex-1">Ronda Malam Scheduler</h1>
    <div class="flex gap-2">
      <button id="btnShowTutorial" class="no-print px-2 py-1 text-xs bg-blue-200 rounded ml-1 font-semibold">Tutorial</button>
    </div>
  </div>
  <!-- Import / Export -->
  <div class="flex flex-wrap gap-2 mb-3 no-print justify-center">
    <input type="file" id="inputFile" accept=".txt,.json" class="hidden" />
    <button id="btnImport" class="px-3 py-1 bg-blue-600 text-white rounded text-xs font-semibold hover:bg-blue-700">Import TXT/JSON</button>
    <button id="btnExportTxt" class="px-3 py-1 bg-green-600 text-white rounded text-xs font-semibold hover:bg-green-700">Export TXT</button>
    <button id="btnExportJson" class="px-3 py-1 bg-sky-600 text-white rounded text-xs font-semibold hover:bg-sky-700">Export JSON</button>
    <button id="btnClear" class="px-3 py-1 bg-red-600 text-white rounded text-xs font-semibold hover:bg-red-700">Clear Jadwal</button>
    <button id="btnCopyFormatTxt" class="px-3 py-1 bg-slate-100 border border-slate-300 rounded text-xs font-semibold hover:bg-slate-200" title="Copy Format TXT">Copy Format TXT</button>
  </div>
  <!-- Filter Tim -->
  <div class="flex flex-wrap gap-2 mb-3 no-print justify-center items-center">
    <label for="filterTeam" class="font-semibold text-sm mr-1">Filter Tim:</label>
    <select id="filterTeam" class="border rounded px-2 py-1 text-sm max-w-xs">
      <option value="">Semua Tim</option>
    </select>
    <button id="btnResetFilter" class="px-2 py-1 bg-slate-100 border border-slate-300 rounded text-xs hover:bg-slate-200 font-semibold" type="button">Reset</button>
  </div>
  <!-- Tanggal Picker -->
  <div class="flex tanggal-picker-mobile gap-2 mb-3">
    <label class="font-semibold flex-shrink-0 min-w-[110px]">Pilih Tanggal:</label>
    <div class="flex-1 flex flex-col gap-2">
      <input type="date" id="datePicker" class="border rounded p-1 text-sm max-w-xs" />
      <div class="tanggal-picker-btns">
        <button id="btnPrev" class="px-2 py-1 text-xs rounded bg-slate-100 hover:bg-slate-200 border border-slate-200 no-print font-semibold">&lt;</button>
        <button id="btnNext" class="px-2 py-1 text-xs rounded bg-slate-100 hover:bg-slate-200 border border-slate-200 no-print font-semibold">&gt;</button>
      </div>
    </div>
  </div>
  <!-- Preview Tabel -->
  <div id="previewContainer" class="mb-3 overflow-x-auto">
    <table class="min-w-full border text-sm rounded overflow-hidden">
      <thead>
        <tr class="bg-slate-200 dark:bg-slate-700">
          <th class="p-2 border">Tanggal</th>
          <th class="p-2 border">Tim</th>
          <th class="p-2 border">Anggota</th>
        </tr>
      </thead>
      <tbody id="previewTableBody"></tbody>
    </table>
    <div id="notFound" class="text-center text-slate-400 p-3"></div>
  </div>
  <!-- Edit -->
  <div id="editRowPanel" class="mb-3 hidden">
    <div class="bg-slate-100 dark:bg-slate-700 rounded p-2 mb-2">
      <div class="mb-2 font-semibold">Edit Jadwal</div>
      <form id="editForm" class="flex flex-col gap-1">
        <label>Tanggal: <input type="date" id="editTanggal" class="border rounded p-1 text-sm" required></label>
        <label>Tim: <input type="text" id="editTeam" class="border rounded p-1 text-sm" required></label>
        <label class="edit-anggota-label" for="editAnggota">Anggota:</label>
        <textarea id="editAnggota" class="edit-anggota-textarea border text-sm" required></textarea>
        <div class="flex gap-2 mt-2">
          <button class="px-3 py-1 bg-blue-600 text-white rounded text-xs font-semibold hover:bg-blue-700" type="submit">Simpan</button>
          <button id="btnCancelEdit" class="px-3 py-1 bg-slate-200 rounded text-xs font-semibold hover:bg-slate-300" type="button">Batal</button>
        </div>
      </form>
    </div>
  </div>
  <!-- WhatsApp Output -->
  <div class="mt-2 mb-2 bg-slate-100 dark:bg-slate-700 rounded p-3">
    <div class="wa-btn-group no-print" id="waBtnDesktop" style="display:none;">
      <button id="btnCopyWA" class="copy-btn font-semibold">Copy Teks</button>
      <button id="btnEditRow" class="copy-btn font-semibold">Edit Baris</button>
    </div>
    <div id="waOutput" class="wa-preview"></div>
  </div>
</div>

<!-- Overlay Tutorial Simple -->
<div id="tutorialOverlay" class="simple-tutorial-bg" style="display:none;">
  <div class="simple-tutorial-panel">
    <button class="close-btn" id="btnCloseTutorial" title="Tutup">&times;</button>
    <div class="font-bold text-base mb-2 text-center">Panduan Singkat</div>
    <ul class="list-disc pl-5 mb-2">
      <li>Import jadwal via <b>Import TXT/JSON</b>.</li>
      <li>Filter jadwal berdasarkan tim pada <b>Filter Tim</b>.</li>
      <li>Pilih tanggal, lalu edit/copy jadwal hari itu.</li>
      <li>Edit satu tim, otomatis update semua jadwal tim itu.</li>
      <li><b>Copy Teks</b> untuk membagikan ke WhatsApp atau aplikasi lain.</li>
      <li>Export dan backup jadwal via <b>Export TXT</b>/<b>Export JSON</b>.</li>
      <li>Hapus seluruh jadwal dengan <b>Clear Jadwal</b>.</li>
    </ul>
    <div class="text-xs text-center text-slate-500 mt-1">
      Fitur akan terus dikembangkan sesuai kebutuhan ronda Anda.
    </div>
  </div>
</div>

<div id="mobileActionBar" class="mobile-action-bar no-print" style="display:none;">
  <button id="btnCopyWAMobile" class="copy-btn font-semibold">Copy Teks</button>
  <button id="btnEditRowMobile" class="copy-btn font-semibold">Edit</button>
</div>

<div id="toast" class="fixed left-1/2 bottom-7 px-4 py-2 rounded shadow text-white bg-slate-800 text-sm z-50 transition-all" style="display:none;transform:translateX(-50%);"></div>

<script>
let jadwalArr = [];
let currentTanggal = null;
let editIdx = null;
let currentFilterTeam = "";
const STORAGE_KEY = "ronda_jadwal_v3";
const randomKata2 = [
  "Keamanan Kita Prioritas!",
  "Utamakan Siskamling, Nyaman Bersama!",
  "Bersama, Lingkungan Aman Nyaman!",
  "Jaga Lingkungan, Jaga Keluarga!",
  "Satukan Langkah, Aman Bersama!",
  "Ronda untuk Harmoni Bersama!",
  "Bersatu Menjaga, Damai Dirasa!",
  "Bersama kita lebih kuat!",
  "Ronda Malam, Wujud Peduli!",
  "Ayo Jaga Malam, Demi Kenyamanan!",
  // Tambahan baru
  "Bersatu menjaga, bersama menyelematkan.",
  "Sinar sentermu cahaya harapan di malam kelam.",
  "Keberanianmu malam ini adalah ketenangan esok hari.",
  "Ronda bukan tugas, tapi wujud cinta pada lingkungan.",
  "Langkahmu tegap, keamanan pun terjaga.",
  "Di sela senyap malam, keberanianmu berbicara.",
  "Jagalah lingkar keamanan dengan hati penuh tanggung jawab.",
  "Setiap putaran ronda adalah wujud kepedulian.",
  "Kita ronda, agar semua bisa tidur nyenyak.",
  "Bersama kita kuat, sendiri kita rentan.",
  "Heningnya malam butuh keberanianmu.",
  "Satu senter, sejuta rasa aman.",
  "Ronda pagi—kemenangan kecil bagi hati besar.",
  "Tangan di senter, mata di lingkungan.",
  "Langkah berjaga, cermin solidaritas.",
  "Keamananmu pijar bagi kita semua.",
  "Jaga malam, jaga persaudaraan.",
  "Malam gelap, hati terang.",
  "Satu komando: aman dan damai!",
  "Ronda: rutinitas yang memberi arti.",
  "Jadilah lentera kecil di kegelapan.",
  "Semangat ronda, semangat kebersamaan.",
  "Kesiagaanmu malam ini adalah senyum esok hari.",
  "Ronda: aksi nyata, bukan lip service.",
  "Malam mungkin panjang, tapi solidaritas lebih panjang.",
  "Keberanianmu, keamanan warga.",
  "Langkahmu malam ini memberi harapan.",
  "Ronda: walau sunyi, kita tak sendiri.",
  "Pasang senter, pancarkan rasa aman.",
  "Setiap putaran, setiap jiwa terlindungi.",
  "Ronda hari ini, damai esok hari."
];

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.display = '';
  t.style.opacity = '1';
  setTimeout(() => { t.style.opacity = '0'; }, 1600);
  setTimeout(() => { t.style.display = 'none'; }, 1900);
}

function pad(n){ return n<10?'0'+n:n; }
function formatTanggalLong(iso){
  const hari=['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'];
  const bulan=['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];
  let d=new Date(iso);
  if(isNaN(d)) return iso;
  return `${hari[d.getDay()]}, ${d.getDate()} ${bulan[d.getMonth()]} ${d.getFullYear()}`;
}
function parseTanggalToISO(s){
  s=s.trim().replace(/^[A-Za-z]+,\s*/,'');
  let [tgl,bln,th]=s.split(' ');
  if(!tgl||!bln||!th)return null;
  const bulan={Januari:1,Februari:2,Maret:3,April:4,Mei:5,Juni:6,Juli:7,Agustus:8,September:9,Oktober:10,November:11,Desember:12,
    Jan:1,Feb:2,Mar:3,Apr:4,Mei:5,Jun:6,Jul:7,Agu:8,Sep:9,Okt:10,Nov:11,Des:12};
  let m=bulan[bln];
  if(!m)return null;
  return `${th}-${pad(m)}-${pad(parseInt(tgl,10))}`;
}
function parseJadwalTxt(txt){
  const lines=txt.split('\n').map(l=>l.trim()).filter(l=>!!l&&!/Jadwal\s+Tim/i.test(l));
  let res=[];
  for(let line of lines){
    let parts=line.split(',');
    if(parts.length<4)continue;
    let tanggal=parts[1].trim();
    let team=parts[2].trim();
    let membersRaw=parts.slice(3).join(',').trim();
    let members=membersRaw.split(';').map(m=>m.trim()).filter(Boolean);
    let iso=parseTanggalToISO(parts[0]+','+tanggal)||parseTanggalToISO(tanggal);
    if(!iso)continue;
    res.push({date:iso,team,members});
  }
  return res.sort((a,b)=>a.date.localeCompare(b.date));
}
function saveJadwal(arr){ localStorage.setItem(STORAGE_KEY,JSON.stringify(arr)); }
function loadJadwal(){ let d=localStorage.getItem(STORAGE_KEY); try{return d?JSON.parse(d):[];}catch{return [];} }

// --- Sorted Tim filter by "Tim [number]" order
function getUniqueTeams() {
  let set = new Set();
  jadwalArr.forEach(j => set.add(j.team));
  let teams = Array.from(set);
  // sort by "Tim [number]" then alpha if not match
  return teams.sort((a, b) => {
    let numA = (a.match(/Tim (\d+)/i)||[])[1], numB = (b.match(/Tim (\d+)/i)||[])[1];
    if(numA && numB) return parseInt(numA) - parseInt(numB);
    if(numA) return -1;
    if(numB) return 1;
    return a.localeCompare(b);
  });
}
function renderFilterTeamOptions() {
  const select = document.getElementById('filterTeam');
  const prev = select.value;
  select.innerHTML = `<option value="">Semua Tim</option>`;
  getUniqueTeams().forEach(team => {
    const opt = document.createElement('option');
    opt.value = team;
    opt.textContent = team;
    select.appendChild(opt);
  });
  if (getUniqueTeams().includes(prev)) select.value = prev;
  else select.value = "";
}

function getFilteredJadwal() {
  if (!currentFilterTeam) return jadwalArr.slice().sort((a,b)=>a.date.localeCompare(b.date));
  return jadwalArr.filter(j=>j.team === currentFilterTeam).sort((a,b)=>a.date.localeCompare(b.date));
}
function findByTanggal(tanggal) {
  let filtered = getFilteredJadwal();
  return filtered.findIndex(j=>j.date===tanggal);
}
function renderPreview() {
  const tbody = document.getElementById('previewTableBody');
  const notFound = document.getElementById('notFound');
  tbody.innerHTML = '';
  notFound.textContent = '';
  let filtered = getFilteredJadwal();
  let idx = filtered.findIndex(j=>j.date===currentTanggal);
  if(idx===-1) {
    if(filtered.length>0) {
      currentTanggal = filtered[0].date;
      idx = 0;
    } else {
      notFound.textContent = "Tidak ada jadwal untuk filter ini.";
      toggleMobileActionBar(false);
      toggleBtnDesktopWA(false);
      return;
    }
  }
  let j = filtered[idx];
  let tr = document.createElement('tr');
  tr.innerHTML = `
    <td class="border p-2">${formatTanggalLong(j.date)}</td>
    <td class="border p-2 font-semibold">${j.team}</td>
    <td class="border p-2">${j.members.map(m=>`<span class="inline-block bg-blue-100 rounded px-2 mr-1 mb-1">${m}</span>`).join('')}</td>
  `;
  tbody.appendChild(tr);
  toggleMobileActionBar(true);
  toggleBtnDesktopWA(true);
}
function setTanggalNext(dir) {
  let filtered = getFilteredJadwal();
  if(!filtered.length) return;
  let idx = filtered.findIndex(j=>j.date===currentTanggal);
  if(idx===-1) {
    currentTanggal = filtered[0].date;
  } else {
    let nextIdx = idx+dir;
    if(nextIdx >=0 && nextIdx < filtered.length) {
      currentTanggal = filtered[nextIdx].date;
    }
  }
  document.getElementById('datePicker').value = currentTanggal;
  renderPreview(); renderWAOutput();
}
function randomKalimatPenutup() {
  let idx = Math.floor(Math.random()*randomKata2.length);
  return randomKata2[idx];
}
function generateWAOutput() {
  let filtered = getFilteredJadwal();
  let idx = filtered.findIndex(j=>j.date===currentTanggal);
  if(idx===-1) return 'Tidak ada jadwal untuk tanggal ini.';
  const settings = {
    title: "RONDA MALAM KAISAR RESIDENCE",
    jam: "23.00–04.00 WIB",
    tz: "WIB"
  };
  let j = filtered[idx];
  let selanjutnya = filtered.filter(row => row.team === j.team && row.date > j.date)
    .map(row=>`• ${formatTanggalLong(row.date)}`).join('\n') || '• -';
  return (
`🔥🚨 *${settings.title}* 🚨🔥

📆 *${formatTanggalLong(j.date)}*  
⏰ *Waktu Jaga:* ${settings.jam}  

👥 *${j.team}*  
👮‍♂️ *Petugas:*  
${j.members.map(m=>`• ${m}`).join('\n')}

📌 *Jadwal Selanjutnya ${j.team}:*  
${selanjutnya}

🙏 Terima kasih atas partisipasinya.  
Mari jaga lingkungan tetap aman dan nyaman bersama-sama.  

💥 *${randomKalimatPenutup()}* 💥
`
  );
}
function renderWAOutput() {
  document.getElementById('waOutput').textContent = generateWAOutput();
}
function showEditPanel(show, idx) {
  const panel = document.getElementById('editRowPanel');
  panel.classList.toggle('hidden', !show);
  if(show) {
    let j = jadwalArr[idx];
    editIdx = idx;
    document.getElementById('editTanggal').value = j.date;
    document.getElementById('editTeam').value = j.team;
    const anggota = j.members.join('\n');
    const ta = document.getElementById('editAnggota');
    ta.value = anggota;
    setTimeout(()=>{
      ta.style.height = "auto";
      ta.style.height = (ta.scrollHeight+4) + "px";
    },1);
    ta.oninput = function() {
      this.style.height = "auto";
      this.style.height = (this.scrollHeight+4) + "px";
    };
  } else {
    editIdx = null;
  }
}
document.getElementById('filterTeam').onchange = function() {
  currentFilterTeam = this.value;
  let filtered = getFilteredJadwal();
  if(filtered.length > 0) {
    currentTanggal = filtered[0].date;
    document.getElementById('datePicker').value = currentTanggal;
  }
  renderPreview();
  renderWAOutput();
};
document.getElementById('btnResetFilter').onclick = function() {
  currentFilterTeam = "";
  document.getElementById('filterTeam').value = "";
  let filtered = getFilteredJadwal();
  if(filtered.length > 0) {
    currentTanggal = filtered[0].date;
    document.getElementById('datePicker').value = currentTanggal;
  }
  renderPreview();
  renderWAOutput();
};
document.getElementById('datePicker').onchange = function() {
  currentTanggal = this.value;
  renderPreview(); renderWAOutput();
};
document.getElementById('btnPrev').onclick = function() { setTanggalNext(-1); };
document.getElementById('btnNext').onclick = function() { setTanggalNext(1); };
function toggleBtnDesktopWA(show) {
  document.getElementById('waBtnDesktop').style.display = show ? '' : 'none';
}
document.getElementById('btnCopyWA').onclick = function() {
  let waText = generateWAOutput();
  navigator.clipboard.writeText(waText).then(()=>showToast('Teks disalin!'));
};
document.getElementById('btnEditRow').onclick = function() {
  let filtered = getFilteredJadwal();
  let idxFiltered = filtered.findIndex(j=>j.date===currentTanggal);
  if(idxFiltered===-1) { showToast('Tidak ada jadwal untuk diedit!'); return; }
  let obj = filtered[idxFiltered];
  let idx = jadwalArr.findIndex(j=>j.date === obj.date && j.team === obj.team);
  if(idx===-1) idx = jadwalArr.findIndex(j=>j.date === obj.date);
  showEditPanel(true, idx);
};
function toggleMobileActionBar(show) {
  let bar = document.getElementById('mobileActionBar');
  bar.style.display = show ? '' : 'none';
}
document.getElementById('btnCopyWAMobile').onclick = function() {
  let waText = generateWAOutput();
  navigator.clipboard.writeText(waText).then(()=>showToast('Teks disalin!'));
};
document.getElementById('btnEditRowMobile').onclick = function() {
  let filtered = getFilteredJadwal();
  let idxFiltered = filtered.findIndex(j=>j.date===currentTanggal);
  if(idxFiltered===-1) { showToast('Tidak ada jadwal untuk diedit!'); return; }
  let obj = filtered[idxFiltered];
  let idx = jadwalArr.findIndex(j=>j.date === obj.date && j.team === obj.team);
  if(idx===-1) idx = jadwalArr.findIndex(j=>j.date === obj.date);
  showEditPanel(true, idx);
};
document.getElementById('btnCancelEdit').onclick = function() {
  showEditPanel(false);
};
document.getElementById('editForm').onsubmit = function(e){
  e.preventDefault();
  if(editIdx===null) return;
  let tgl = document.getElementById('editTanggal').value;
  let timBaru = document.getElementById('editTeam').value.trim();
  let anggotaBaru = document.getElementById('editAnggota').value
    .split('\n').map(m=>m.trim()).filter(Boolean);
  if(!tgl||!timBaru||!anggotaBaru.length) { showToast('Lengkapi semua input!'); return;}
  let timSebelum = jadwalArr[editIdx].team;
  let timSebelumLower = timSebelum.trim().toLowerCase();
  let timBaruLower = timBaru.toLowerCase();
  if (timSebelumLower === timBaruLower) {
    for (let i = 0; i < jadwalArr.length; i++) {
      if (jadwalArr[i].team.trim().toLowerCase() === timBaruLower) {
        jadwalArr[i].members = anggotaBaru.slice();
      }
    }
    jadwalArr[editIdx].date = tgl;
    jadwalArr[editIdx].team = timBaru;
  } else {
    for (let i = 0; i < jadwalArr.length; i++) {
      if (jadwalArr[i].team.trim().toLowerCase() === timSebelumLower) {
        jadwalArr[i].team = timBaru;
        jadwalArr[i].members = anggotaBaru.slice();
      }
    }
    jadwalArr[editIdx].date = tgl;
    jadwalArr[editIdx].team = timBaru;
    jadwalArr[editIdx].members = anggotaBaru.slice();
  }
  saveJadwal(jadwalArr);
  renderFilterTeamOptions();
  if(currentFilterTeam && !getUniqueTeams().includes(currentFilterTeam)) {
    currentFilterTeam = "";
    document.getElementById('filterTeam').value = "";
  }
  let filtered = getFilteredJadwal();
  if(filtered.length>0) currentTanggal = filtered[0].date;
  else currentTanggal = tgl;
  document.getElementById('datePicker').value = currentTanggal;
  showEditPanel(false);
  renderPreview(); renderWAOutput();
  showToast('Seluruh jadwal tim "'+timBaru+'" telah diperbarui!');
};
document.getElementById('btnCopyFormatTxt').onclick = function() {
  let lines = jadwalArr.map(j=>`${formatTanggalLong(j.date)}, ${j.team}, ${j.members.join('; ')}`);
  navigator.clipboard.writeText(lines.join('\n'));
  showToast('Seluruh jadwal dicopy sebagai format TXT!');
};
function afterDataChange() {
  renderFilterTeamOptions();
  let filtered = getFilteredJadwal();
  if(filtered.length>0) currentTanggal = filtered[0].date;
  document.getElementById('datePicker').value = currentTanggal;
  renderPreview(); renderWAOutput();
}
document.getElementById('btnImport').onclick=()=>document.getElementById('inputFile').click();
document.getElementById('inputFile').onchange=function(e){
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=ev=>{
    if(f.name.endsWith('.json')){
      try{jadwalArr=JSON.parse(ev.target.result)||[];}catch{showToast('Format JSON salah!');return;}
    }else{
      jadwalArr=parseJadwalTxt(ev.target.result);
    }
    saveJadwal(jadwalArr);
    afterDataChange();
    showToast('Berhasil import!');
  };
  r.readAsText(f);
};
document.getElementById('btnExportTxt').onclick=function(){
  let lines=jadwalArr.map(j=>`${formatTanggalLong(j.date)}, ${j.team}, ${j.members.join('; ')}`);
  let blob=new Blob([lines.join('\n')],{type:'text/plain'}),a=document.createElement('a');
  a.href=URL.createObjectURL(blob);a.download="jadwal_ronda.txt";a.click();URL.revokeObjectURL(a.href);showToast('Export TXT!');
};
document.getElementById('btnExportJson').onclick=function(){
  let blob=new Blob([JSON.stringify(jadwalArr,null,2)],{type:'application/json'}),a=document.createElement('a');
  a.href=URL.createObjectURL(blob);a.download="jadwal_ronda.json";a.click();URL.revokeObjectURL(a.href);showToast('Export JSON!');
};
document.getElementById('btnClear').onclick=function(){
  if(confirm('Hapus semua jadwal?')){jadwalArr=[];saveJadwal(jadwalArr);}
  afterDataChange();
};
window.onload = function() {
  if(window.matchMedia('(prefers-color-scheme: dark)').matches) {
    document.body.classList.add('dark');
  }
  jadwalArr = loadJadwal();
  renderFilterTeamOptions();
  let filtered = getFilteredJadwal();
  let today = (new Date()).toISOString().slice(0,10);
  if(filtered.find(j=>j.date===today)) currentTanggal = today;
  else if(filtered.length) currentTanggal = filtered[0].date;
  else currentTanggal = today;
  document.getElementById('datePicker').value = currentTanggal;
  renderPreview(); renderWAOutput();
};
// Overlay tutorial
document.getElementById('btnShowTutorial').onclick = function() {
  document.getElementById('tutorialOverlay').style.display = '';
  document.body.style.overflow = 'hidden';
};
document.getElementById('btnCloseTutorial').onclick = function() {
  document.getElementById('tutorialOverlay').style.display = 'none';
  document.body.style.overflow = '';
};
document.getElementById('tutorialOverlay').onclick = function(e){
  if(e.target===this){
    this.style.display='none';
    document.body.style.overflow = '';
  }
};
</script>
</body>
</html>
