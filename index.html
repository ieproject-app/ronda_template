<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Ronda Malam Scheduler</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <meta name="color-scheme" content="dark light">
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --secondary: #10b981;
      --secondary-dark: #059669;
      --card-bg: #ffffff;
      --card-bg-dark: #1e293b;
      --text: #334155;
      --text-dark: #e2e8f0;
    }
    
    html { color-scheme: light dark; }
    body { 
      transition: background 0.2s, color 0.2s;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      font-family: 'Segoe UI', system-ui, sans-serif;
    }
    
    body.dark {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    }
    
    .card {
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
      padding: 1.75rem;
      transition: all 0.3s ease;
      border: 1px solid rgba(0,0,0,0.05);
      margin-bottom: 1.5rem;
    }
    
    body.dark .card {
      background: var(--card-bg-dark);
      border-color: rgba(255,255,255,0.05);
      box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3);
    }
    
    .card-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1.25rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid #e2e8f0;
    }
    
    body.dark .card-header {
      border-bottom-color: #334155;
    }
    
    .card-header i {
      font-size: 1.5rem;
      color: var(--primary);
    }
    
    .card-header h2 {
      font-size: 1.35rem;
      font-weight: 700;
      color: var(--text);
      margin: 0;
    }
    
    body.dark .card-header h2 {
      color: var(--text-dark);
    }
    
    .btn {
      padding: 0.65rem 1.25rem;
      border-radius: 10px;
      font-weight: 600;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.2s ease;
      cursor: pointer;
      border: none;
      outline: none;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
    }
    
    .btn-secondary {
      background: var(--secondary);
      color: white;
    }
    
    .btn-secondary:hover {
      background: var(--secondary-dark);
    }
    
    .btn-outline {
      background: transparent;
      border: 2px solid var(--primary);
      color: var(--primary);
    }
    
    .btn-outline:hover {
      background: rgba(37, 99, 235, 0.1);
    }
    
    .input-group {
      margin-bottom: 1.25rem;
    }
    
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--text);
    }
    
    body.dark label {
      color: var(--text-dark);
    }
    
    input, select, textarea {
      width: 100%;
      padding: 0.85rem;
      border-radius: 12px;
      border: 1px solid #cbd5e1;
      background: #f8fafc;
      font-size: 1rem;
      transition: all 0.2s;
    }
    
    body.dark input, 
    body.dark select, 
    body.dark textarea {
      background: #1e293b;
      border-color: #334155;
      color: #e2e8f0;
    }
    
    input:focus, select:focus, textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
      outline: none;
    }
    
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.25rem;
    }
    
    .flex-center {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .nav-buttons {
      display: flex;
      gap: 0.5rem;
    }
    
    .nav-btn {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .nav-btn:hover {
      background: #e2e8f0;
    }
    
    body.dark .nav-btn {
      background: #334155;
      border-color: #475569;
    }
    
    body.dark .nav-btn:hover {
      background: #475569;
    }
    
    .table-container {
      overflow-x: auto;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      margin-bottom: 1.5rem;
    }
    
    body.dark .table-container {
      border-color: #334155;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 500px;
    }
    
    th {
      background: #f1f5f9;
      text-align: left;
      font-weight: 600;
      padding: 1rem;
      color: var(--text);
      border-bottom: 2px solid #e2e8f0;
    }
    
    body.dark th {
      background: #334155;
      color: var(--text-dark);
      border-bottom-color: #475569;
    }
    
    td {
      padding: 1rem;
      border-bottom: 1px solid #e2e8f0;
      color: var(--text);
    }
    
    body.dark td {
      border-bottom-color: #334155;
      color: var(--text-dark);
    }
    
    tr:last-child td {
      border-bottom: none;
    }
    
    .member-tag {
      display: inline-block;
      background: #dbeafe;
      color: var(--primary);
      padding: 0.35rem 0.75rem;
      border-radius: 50px;
      font-size: 0.85rem;
      margin: 0.25rem;
      white-space: nowrap;
    }
    
    body.dark .member-tag {
      background: rgba(37, 99, 235, 0.2);
      color: #93c5fd;
    }
    
    .wa-preview {
      background: #f7fdf9;
      color: #2d4736;
      border: 1px solid #25D366;
      border-radius: 16px;
      font-family: "Segoe UI", Arial, sans-serif;
      font-size: 1.05rem;
      line-height: 1.65;
      padding: 1.25rem;
      min-height: 170px;
      word-break: break-word;
      letter-spacing: 0.01em;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
      white-space: pre-wrap;
    }
    
    body.dark .wa-preview {
      background: #17291e;
      color: #e9ffe2;
      border-color: #25D366;
    }
    
    .action-bar {
      display: flex;
      gap: 0.75rem;
      margin-top: 1rem;
    }
    
    .btn-wa {
      background: #25D366;
      color: white;
      flex: 1;
    }
    
    .btn-wa:hover {
      background: #1ebd5a;
    }
    
    .btn-copy {
      background: #f1f5f9;
      color: var(--text);
    }
    
    body.dark .btn-copy {
      background: #334155;
      color: var(--text-dark);
    }
    
    .btn-copy:hover {
      background: #e2e8f0;
    }
    
    body.dark .btn-copy:hover {
      background: #475569;
    }
    
    .hidden {
      display: none;
    }
    
    .toast {
      position: fixed;
      left: 50%;
      bottom: 2rem;
      transform: translateX(-50%);
      padding: 0.85rem 1.5rem;
      border-radius: 12px;
      background: var(--card-bg);
      color: var(--text);
      box-shadow: 0 10px 25px -5px rgba(0,0,0,0.2);
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      opacity: 0;
      transition: opacity 0.3s;
      border: 1px solid rgba(0,0,0,0.05);
    }
    
    body.dark .toast {
      background: var(--card-bg-dark);
      color: var(--text-dark);
      border-color: rgba(255,255,255,0.05);
    }
    
    .toast.show {
      opacity: 1;
    }
    
    @media (max-width: 768px) {
      .grid-2 {
        grid-template-columns: 1fr;
      }
      
      .card {
        padding: 1.25rem;
      }
      
      .action-bar .btn span {
        display: none;
      }
      
      .action-bar .btn i {
        margin-right: 0;
      }
    }
    
    @media (max-width: 480px) {
      .card {
        padding: 1rem;
      }
      
      .btn {
        padding: 0.65rem 1rem;
        font-size: 0.85rem;
      }
      
      .table-container {
        border-radius: 10px;
      }
    }
    
    .fade-in {
      animation: fadeIn 0.3s ease forwards;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="min-h-screen text-slate-700 dark:text-slate-200 p-4 md:p-6" id="mainBody">
  <div class="max-w-4xl mx-auto">
    <!-- Header Card -->
    <div class="card fade-in">
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
        <div>
          <h1 class="text-2xl md:text-3xl font-bold text-slate-800 dark:text-white">Ronda Malam Scheduler</h1>
          <p class="text-slate-600 dark:text-slate-400 mt-1">Atur dan bagikan jadwal ronda dengan mudah</p>
        </div>
        <div class="flex gap-2">
          <button id="btnShowTutorial" class="btn btn-outline">
            <i class="fas fa-question-circle"></i> Panduan
          </button>
          <button id="themeToggle" class="btn btn-outline">
            <i class="fas fa-moon"></i>
          </button>
        </div>
      </div>
      
      <!-- Import/Export Card -->
      <div class="bg-slate-50 dark:bg-slate-800/50 rounded-xl p-4 mb-4">
        <div class="flex flex-wrap gap-2 justify-center">
          <input type="file" id="inputFile" accept=".txt,.json" class="hidden" />
          <button id="btnImport" class="btn btn-primary">
            <i class="fas fa-file-import"></i> Import
          </button>
          <button id="btnExportTxt" class="btn btn-secondary">
            <i class="fas fa-file-export"></i> Export TXT
          </button>
          <button id="btnExportJson" class="btn btn-secondary">
            <i class="fas fa-file-code"></i> Export JSON
          </button>
          <button id="btnClear" class="btn bg-rose-500 hover:bg-rose-600 text-white">
            <i class="fas fa-trash-alt"></i> Hapus
          </button>
          <button id="btnCopyFormatTxt" class="btn bg-amber-500 hover:bg-amber-600 text-white">
            <i class="fas fa-copy"></i> Format TXT
          </button>
        </div>
      </div>
    </div>
    
    <!-- Tanggal Picker Card -->
    <div class="card fade-in">
      <div class="card-header">
        <i class="fas fa-calendar-alt"></i>
        <h2>Pilih Tanggal</h2>
      </div>
      
      <div class="grid-2">
        <div class="input-group">
          <label for="datePicker">Tanggal</label>
          <input type="date" id="datePicker" />
        </div>
        
        <div>
          <label>Navigasi</label>
          <div class="flex items-center gap-3">
            <div class="nav-buttons">
              <button id="btnPrev" class="nav-btn">
                <i class="fas fa-chevron-left"></i>
              </button>
              <button id="btnNext" class="nav-btn">
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
            <button id="btnToday" class="btn bg-indigo-500 hover:bg-indigo-600 text-white flex-1">
              <i class="fas fa-calendar-day"></i> Hari Ini
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Preview Card -->
    <div class="card fade-in">
      <div class="card-header">
        <i class="fas fa-table"></i>
        <h2>Preview Jadwal</h2>
      </div>
      
      <div id="previewContainer">
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Tanggal</th>
                <th>Tim</th>
                <th>Anggota</th>
              </tr>
            </thead>
            <tbody id="previewTableBody"></tbody>
          </table>
        </div>
        <div id="notFound" class="text-center text-slate-500 dark:text-slate-400 p-4"></div>
      </div>
    </div>
    
    <!-- Edit Panel Card -->
    <div id="editRowPanel" class="card fade-in hidden">
      <div class="card-header">
        <i class="fas fa-edit"></i>
        <h2>Edit Jadwal</h2>
      </div>
      
      <form id="editForm" class="flex flex-col gap-4">
        <div class="grid-2">
          <div class="input-group">
            <label for="editTanggal">Tanggal</label>
            <input type="date" id="editTanggal" required />
          </div>
          
          <div class="input-group">
            <label for="editTeam">Tim</label>
            <input type="text" id="editTeam" required />
          </div>
        </div>
        
        <div class="input-group">
          <label for="editAnggota">Anggota (satu per baris)</label>
          <textarea id="editAnggota" rows="4" required></textarea>
        </div>
        
        <div class="flex gap-3">
          <button class="btn btn-primary flex-1" type="submit">
            <i class="fas fa-save"></i> Simpan
          </button>
          <button id="btnCancelEdit" class="btn bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 flex-1" type="button">
            <i class="fas fa-times"></i> Batal
          </button>
        </div>
      </form>
    </div>
    
    <!-- WhatsApp Output Card -->
    <div class="card fade-in">
      <div class="card-header">
        <i class="fab fa-whatsapp"></i>
        <h2>Bagikan ke WhatsApp</h2>
      </div>
      
      <div id="waOutput" class="wa-preview"></div>
      
      <div class="action-bar">
        <button id="btnShareWA" class="btn btn-wa">
          <i class="fab fa-whatsapp"></i> <span>Bagikan WhatsApp</span>
        </button>
        <button id="btnCopyWA" class="btn btn-copy">
          <i class="fas fa-copy"></i> <span>Copy Text</span>
        </button>
        <button id="btnEditRow" class="btn btn-copy">
          <i class="fas fa-edit"></i> <span>Edit</span>
        </button>
        <button id="btnPrint" class="btn btn-copy">
          <i class="fas fa-print"></i> <span>Print</span>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Overlay Tutorial -->
  <div id="tutorialOverlay" class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4 hidden">
    <div class="bg-white dark:bg-slate-800 rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-slate-800 dark:text-white">Panduan Penggunaan</h3>
        <button id="btnCloseTutorial" class="text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 text-2xl">
          &times;
        </button>
      </div>
      
      <div class="space-y-4 text-slate-700 dark:text-slate-300">
        <div class="bg-blue-50 dark:bg-slate-700/50 p-4 rounded-xl">
          <h4 class="font-bold text-blue-700 dark:text-blue-300 mb-2 flex items-center gap-2">
            <i class="fas fa-file-import"></i> Import Jadwal
          </h4>
          <p>Gunakan tombol <span class="font-semibold">Import</span> untuk memasukkan jadwal dari file TXT atau JSON.</p>
          <p class="mt-2 text-sm bg-white dark:bg-slate-800 p-3 rounded-lg">
            Format TXT:<br>
            <code>Senin, 01 Januari 2024, Tim A, Anggota1; Anggota2; ...</code>
          </p>
        </div>
        
        <div class="bg-emerald-50 dark:bg-slate-700/50 p-4 rounded-xl">
          <h4 class="font-bold text-emerald-700 dark:text-emerald-300 mb-2 flex items-center gap-2">
            <i class="fas fa-calendar-alt"></i> Navigasi & Edit Jadwal
          </h4>
          <ul class="list-disc pl-5 space-y-1">
            <li>Pilih tanggal menggunakan date picker atau tombol navigasi</li>
            <li>Klik <span class="font-semibold">Hari Ini</span> untuk kembali ke tanggal sekarang</li>
            <li>Edit jadwal per hari dengan klik tombol <span class="font-semibold">Edit</span></li>
          </ul>
        </div>
        
        <div class="bg-green-50 dark:bg-slate-700/50 p-4 rounded-xl">
          <h4 class="font-bold text-green-700 dark:text-green-300 mb-2 flex items-center gap-2">
            <i class="fab fa-whatsapp"></i> Bagikan ke WhatsApp
          </h4>
          <p>Gunakan tombol <span class="font-semibold">Bagikan WhatsApp</span> untuk langsung membagikan jadwal melalui WhatsApp.</p>
          <p class="mt-2">Anda juga bisa <span class="font-semibold">Copy Text</span> untuk menyalin teks jadwal dan membagikannya melalui aplikasi lain.</p>
        </div>
        
        <div class="bg-amber-50 dark:bg-slate-700/50 p-4 rounded-xl">
          <h4 class="font-bold text-amber-700 dark:text-amber-300 mb-2 flex items-center gap-2">
            <i class="fas fa-download"></i> Export/Backup Jadwal
          </h4>
          <ul class="list-disc pl-5 space-y-1">
            <li><span class="font-semibold">Export TXT</span>: simpan jadwal dalam format teks mudah dibaca</li>
            <li><span class="font-semibold">Export JSON</span>: simpan seluruh data untuk backup/restore</li>
            <li><span class="font-semibold">Format TXT</span>: salin seluruh jadwal dalam format teks terstruktur</li>
          </ul>
        </div>
      </div>
      
      <div class="mt-6 text-center text-sm text-slate-500 dark:text-slate-400">
        Fitur akan terus dikembangkan sesuai kebutuhan ronda Anda
      </div>
    </div>
  </div>
  
  <!-- Toast Notification -->
  <div id="toast" class="toast">
    <i class="fas fa-check-circle text-green-500"></i>
    <span id="toastMessage">Pesan berhasil disalin!</span>
  </div>
  
  <script>
    let jadwalArr = [];
    let currentTanggal = null;
    let editIdx = null;
    const STORAGE_KEY = "ronda_jadwal_v3";
    const randomKata2 = [
      "Keamanan Kita Prioritas!",
      "Utamakan Siskamling, Nyaman Bersama!",
      "Bersama, Lingkungan Aman Nyaman!",
      "Jaga Lingkungan, Jaga Keluarga!",
      "Satukan Langkah, Aman Bersama!",
      "Ronda untuk Harmoni Bersama!",
      "Bersatu Menjaga, Damai Dirasa!",
      "Bersama kita lebih kuat!",
      "Ronda Malam, Wujud Peduli!",
      "Ayo Jaga Malam, Demi Kenyamanan!"
    ];

    // Format dan parsing tanggal (ID)
    function pad(n){ return n<10?'0'+n:n; }
    function formatTanggalLong(iso){
      const hari=['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'];
      const bulan=['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];
      let d=new Date(iso);
      if(isNaN(d)) return iso;
      return `${hari[d.getDay()]}, ${d.getDate()} ${bulan[d.getMonth()]} ${d.getFullYear()}`;
    }
    function parseTanggalToISO(s){
      s=s.trim().replace(/^[A-Za-z]+,\s*/,'');
      let [tgl,bln,th]=s.split(' ');
      if(!tgl||!bln||!th)return null;
      const bulan={Januari:1,Februari:2,Maret:3,April:4,Mei:5,Juni:6,Juli:7,Agustus:8,September:9,Oktober:10,November:11,Desember:12,
        Jan:1,Feb:2,Mar:3,Apr:4,Mei:5,Jun:6,Jul:7,Agu:8,Sep:9,Okt:10,Nov:11,Des:12};
      let m=bulan[bln];
      if(!m)return null;
      return `${th}-${pad(m)}-${pad(parseInt(tgl,10))}`;
    }

    // Parse TXT
    function parseJadwalTxt(txt){
      const lines=txt.split('\n').map(l=>l.trim()).filter(l=>!!l&&!/Jadwal\s+Tim/i.test(l));
      let res=[];
      for(let line of lines){
        let parts=line.split(',');
        if(parts.length<4)continue;
        let tanggal=parts[1].trim();
        let team=parts[2].trim();
        let membersRaw=parts.slice(3).join(',').trim();
        let members=membersRaw.split(';').map(m=>m.trim()).filter(Boolean);
        let iso=parseTanggalToISO(parts[0]+','+tanggal)||parseTanggalToISO(tanggal);
        if(!iso)continue;
        res.push({date:iso,team,members});
      }
      return res.sort((a,b)=>a.date.localeCompare(b.date));
    }

    // LocalStorage
    function saveJadwal(arr){ localStorage.setItem(STORAGE_KEY,JSON.stringify(arr)); }
    function loadJadwal(){ let d=localStorage.getItem(STORAGE_KEY); try{return d?JSON.parse(d):[];}catch{return [];} }

    // Cari index berdasar tanggal
    function findByTanggal(tanggal) {
      return jadwalArr.findIndex(j=>j.date===tanggal);
    }

    // Render Tabel Preview
    function renderPreview() {
      const tbody = document.getElementById('previewTableBody');
      const notFound = document.getElementById('notFound');
      tbody.innerHTML = '';
      notFound.textContent = '';
      let idx = findByTanggal(currentTanggal);
      if(idx===-1) {
        notFound.textContent = "Tidak ada jadwal untuk tanggal ini.";
        return;
      }
      let j = jadwalArr[idx];
      let tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${formatTanggalLong(j.date)}</td>
        <td class="font-semibold">${j.team}</td>
        <td>${j.members.map(m=>`<span class="member-tag">${m}</span>`).join('')}</td>
      `;
      tbody.appendChild(tr);
    }

    // WhatsApp Output
    function randomKalimatPenutup() {
      let idx = Math.floor(Math.random()*randomKata2.length);
      return randomKata2[idx];
    }
    function generateWAOutput() {
      let idx = findByTanggal(currentTanggal);
      if(idx===-1) return 'Tidak ada jadwal untuk tanggal ini.';
      const settings = {
        title: "RONDA MALAM KAISAR RESIDENCE",
        jam: "23.00‚Äì04.00 WIB",
        tz: "WIB"
      };
      let j = jadwalArr[idx];
      // Cari jadwal selanjutnya tim yang sama
      let selanjutnya = jadwalArr.filter(row => row.team === j.team && row.date > j.date)
        .map(row=>`‚Ä¢ ${formatTanggalLong(row.date)}`).join('\n') || '‚Ä¢ -';
      return (
`üî•üö® *${settings.title}* üö®üî•

üìÜ *${formatTanggalLong(j.date)}*  
‚è∞ *Waktu Jaga:* ${settings.jam}  

üë• *${j.team}*  
üëÆ‚Äç‚ôÇÔ∏è *Petugas:*  
${j.members.map(m=>`‚Ä¢ ${m}`).join('\n')}

üìå *Jadwal Selanjutnya ${j.team}:*  
${selanjutnya}

üôè Terima kasih atas partisipasinya.  
Mari jaga lingkungan tetap aman dan nyaman bersama-sama.  

üí• *${randomKalimatPenutup()}* üí•
`
      );
    }
    function renderWAOutput() {
      document.getElementById('waOutput').textContent = generateWAOutput();
    }

    // Tanggal picker: set ke earliest/latest jika < atau >
    function setTanggalNext(dir) {
      if(!jadwalArr.length) return;
      let idx = findByTanggal(currentTanggal);
      if(idx===-1) {
        currentTanggal = jadwalArr[0].date;
      } else {
        let nextIdx = idx+dir;
        if(nextIdx >=0 && nextIdx < jadwalArr.length) {
          currentTanggal = jadwalArr[nextIdx].date;
        }
      }
      document.getElementById('datePicker').value = currentTanggal;
      renderPreview(); renderWAOutput();
    }

    // Edit Panel
    function showEditPanel(show, idx) {
      const panel = document.getElementById('editRowPanel');
      panel.classList.toggle('hidden', !show);
      if(show) {
        editIdx = idx;
        let j = jadwalArr[idx];
        document.getElementById('editTanggal').value = j.date;
        document.getElementById('editTeam').value = j.team;
        // Show anggota as 1 per line for easier editing
        const anggota = j.members.join('\n');
        document.getElementById('editAnggota').value = anggota;
      } else {
        editIdx = null;
      }
    }

    function showToast(msg) {
      const t = document.getElementById('toast');
      const msgEl = document.getElementById('toastMessage');
      msgEl.textContent = msg;
      t.classList.add('show');
      setTimeout(() => { t.classList.remove('show'); }, 2000);
    }

    // Theme Toggle
    function toggleTheme() {
      const body = document.body;
      body.classList.toggle('dark');
      const themeIcon = document.querySelector('#themeToggle i');
      if(body.classList.contains('dark')) {
        themeIcon.classList.remove('fa-moon');
        themeIcon.classList.add('fa-sun');
      } else {
        themeIcon.classList.remove('fa-sun');
        themeIcon.classList.add('fa-moon');
      }
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
      // Theme toggle
      document.getElementById('themeToggle').addEventListener('click', toggleTheme);
      
      // Tutorial overlay
      document.getElementById('btnShowTutorial').addEventListener('click', function() {
        document.getElementById('tutorialOverlay').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
      });
      
      document.getElementById('btnCloseTutorial').addEventListener('click', function() {
        document.getElementById('tutorialOverlay').classList.add('hidden');
        document.body.style.overflow = '';
      });
      
      document.getElementById('tutorialOverlay').addEventListener('click', function(e) {
        if(e.target === this) {
          this.classList.add('hidden');
          document.body.style.overflow = '';
        }
      });
      
      // Date picker
      document.getElementById('datePicker').addEventListener('change', function() {
        currentTanggal = this.value;
        renderPreview(); 
        renderWAOutput();
      });
      
      // Navigation buttons
      document.getElementById('btnPrev').addEventListener('click', function() { setTanggalNext(-1); });
      document.getElementById('btnNext').addEventListener('click', function() { setTanggalNext(1); });
      document.getElementById('btnToday').addEventListener('click', function() {
        const today = new Date().toISOString().slice(0,10);
        currentTanggal = today;
        document.getElementById('datePicker').value = today;
        renderPreview(); 
        renderWAOutput();
      });
      
      // WhatsApp actions
      document.getElementById('btnShareWA').addEventListener('click', function() {
        let waText = generateWAOutput();
        if(waText.startsWith('Tidak ada')) { 
          showToast('Tidak ada jadwal hari ini.'); 
          return; 
        }
        if (navigator.share) {
          navigator.share({text: waText}).catch(()=>{});
        } else {
          window.open('https://wa.me/?text='+encodeURIComponent(waText), '_blank');
        }
      });
      
      document.getElementById('btnCopyWA').addEventListener('click', function() {
        let waText = generateWAOutput();
        navigator.clipboard.writeText(waText).then(()=>showToast('Teks disalin!'));
      });
      
      document.getElementById('btnEditRow').addEventListener('click', function() {
        let idx = findByTanggal(currentTanggal);
        if(idx===-1) { 
          showToast('Tidak ada jadwal untuk diedit!'); 
          return; 
        }
        showEditPanel(true, idx);
      });
      
      document.getElementById('btnPrint').addEventListener('click', function(){ 
        window.print(); 
      });
      
      // Edit form
      document.getElementById('btnCancelEdit').addEventListener('click', function() {
        showEditPanel(false);
      });
      
      document.getElementById('editForm').addEventListener('submit', function(e){
        e.preventDefault();
        if(editIdx===null) return;
        let tgl = document.getElementById('editTanggal').value;
        let tim = document.getElementById('editTeam').value;
        // Ambil anggota dari textarea, tiap baris = 1 anggota, kosong diabaikan
        let anggota = document.getElementById('editAnggota').value
          .split('\n').map(m=>m.trim()).filter(Boolean);
        if(!tgl||!tim||!anggota.length) { 
          showToast('Lengkapi semua input!'); 
          return;
        }
        jadwalArr[editIdx] = { date: tgl, team: tim, members: anggota };
        saveJadwal(jadwalArr);
        currentTanggal = tgl;
        document.getElementById('datePicker').value = currentTanggal;
        showEditPanel(false);
        renderPreview(); 
        renderWAOutput();
        showToast('Jadwal disimpan!');
      });
      
      // Import/Export
      document.getElementById('btnImport').addEventListener('click', function() {
        document.getElementById('inputFile').click();
      });
      
      document.getElementById('inputFile').addEventListener('change', function(e){
        const f=e.target.files[0];if(!f)return;
        const r=new FileReader();
        r.onload=function(ev){
          if(f.name.endsWith('.json')){
            try{jadwalArr=JSON.parse(ev.target.result)||[];}catch{showToast('Format JSON salah!');return;}
          }else{
            jadwalArr=parseJadwalTxt(ev.target.result);
          }
          saveJadwal(jadwalArr);
          let today = (new Date()).toISOString().slice(0,10);
          if(findByTanggal(today)!==-1) currentTanggal = today;
          else if(jadwalArr.length) currentTanggal = jadwalArr[0].date;
          document.getElementById('datePicker').value = currentTanggal;
          renderPreview(); 
          renderWAOutput();
          showToast('Berhasil import!');
        };
        r.readAsText(f);
      });
      
      document.getElementById('btnExportTxt').addEventListener('click', function(){
        if(jadwalArr.length === 0) {
          showToast('Tidak ada data untuk diexport!');
          return;
        }
        let lines=jadwalArr.map(j=>`${formatTanggalLong(j.date)}, ${j.team}, ${j.members.join('; ')}`);
        let blob=new Blob([lines.join('\n')],{type:'text/plain'}),a=document.createElement('a');
        a.href=URL.createObjectURL(blob);a.download="jadwal_ronda.txt";a.click();URL.revokeObjectURL(a.href);
        showToast('Export TXT berhasil!');
      });
      
      document.getElementById('btnExportJson').addEventListener('click', function(){
        if(jadwalArr.length === 0) {
          showToast('Tidak ada data untuk diexport!');
          return;
        }
        let blob=new Blob([JSON.stringify(jadwalArr,null,2)],{type:'application/json'}),a=document.createElement('a');
        a.href=URL.createObjectURL(blob);a.download="jadwal_ronda.json";a.click();URL.revokeObjectURL(a.href);
        showToast('Export JSON berhasil!');
      });
      
      document.getElementById('btnClear').addEventListener('click', function(){
        if(jadwalArr.length === 0) {
          showToast('Tidak ada jadwal untuk dihapus!');
          return;
        }
        
        if(confirm('Hapus semua jadwal? Tindakan ini tidak dapat dibatalkan.')){
          jadwalArr=[];
          saveJadwal(jadwalArr);
          renderPreview();
          renderWAOutput();
          showToast('Semua jadwal telah dihapus!');
          
          let today = (new Date()).toISOString().slice(0,10);
          currentTanggal = today;
          document.getElementById('datePicker').value = today;
        }
      });
      
      document.getElementById('btnCopyFormatTxt').addEventListener('click', function() {
        if(jadwalArr.length === 0) {
          showToast('Tidak ada jadwal untuk dicopy!');
          return;
        }
        
        let lines = jadwalArr.map(j=>`${formatTanggalLong(j.date)}, ${j.team}, ${j.members.join('; ')}`);
        navigator.clipboard.writeText(lines.join('\n'));
        showToast('Seluruh jadwal dicopy sebagai format TXT!');
      });
      
      // Initialize
      jadwalArr = loadJadwal();
      let today = (new Date()).toISOString().slice(0,10);
      if(findByTanggal(today)!==-1) currentTanggal = today;
      else if(jadwalArr.length) currentTanggal = jadwalArr[0].date;
      else currentTanggal = today;
      document.getElementById('datePicker').value = currentTanggal;
      renderPreview(); 
      renderWAOutput();
      
      // Auto dark mode detection
      if(window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
        document.querySelector('#themeToggle i').classList.remove('fa-moon');
        document.querySelector('#themeToggle i').classList.add('fa-sun');
      }
    });
  </script>
</body>
</html>
