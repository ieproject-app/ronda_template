<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Ronda Malam Scheduler</title>
  <!-- Tailwind CDN for fast utility classes -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      transition: background 0.2s, color 0.2s;
    }
    @media (max-width: 600px) {
      .max-w-2xl { max-width: 99vw !important; }
      .p-4 { padding: 1.2rem !important; }
    }
    @media print {
      body, .bg-white { background: #fff !important; color:#222 !important;}
      .shadow, .rounded, .bg-slate-50, .bg-slate-100, .bg-slate-200 { box-shadow:none !important; border-radius:0 !important; background: #fff !important;}
      .max-w-2xl { max-width: 100vw !important; }
      pre, textarea { background: #fff !important; color: #000 !important;}
      #mainBody { color: #000 !important;}
      #darkToggle, #btnShareWA, #btnCopyWA, #btnImport, #btnExportTxt, #btnExportJson, #btnClear, #btnParse, #btnGenerateWA { display:none !important;}
    }
    body.dark, .dark .bg-white { background: #18181b !important; color: #e5e7eb !important;}
    body.dark .bg-white, body.dark .bg-slate-50, body.dark .bg-slate-100, body.dark .bg-slate-200 { background: #232329 !important; color: #e5e7eb !important;}
    body.dark pre, body.dark textarea { background: #252534 !important; color: #f1f5f9 !important;}
  </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-700 transition-colors" id="mainBody">

<div class="max-w-2xl mx-auto mt-4 p-4 bg-white rounded shadow">
  <div class="flex items-center justify-between mb-2">
    <h1 class="text-xl font-bold" id="appTitle">Ronda Malam Scheduler</h1>
    <button id="darkToggle" class="text-xs px-2 py-1 rounded bg-slate-200 hover:bg-slate-300">Dark Mode</button>
  </div>
  <!-- SETTINGS -->
  <form id="settingsForm" class="flex gap-2 mb-4 flex-wrap">
    <input type="text" id="inputTitle" class="flex-1 border rounded p-1 text-sm" value="RONDA MALAM KAISAR RESIDENCE" placeholder="Judul">
    <input type="text" id="inputJam" class="flex-1 border rounded p-1 text-sm" value="23.00‚Äì04.00 WIB" placeholder="Jam Shift">
    <input type="text" id="inputTz" class="flex-1 border rounded p-1 text-sm" value="WIB" placeholder="Zona Waktu">
  </form>
  <!-- ADD BARIS -->
  <form id="addRowForm" class="flex gap-2 mb-2 flex-wrap">
    <input type="date" id="addTanggal" class="border rounded p-1 text-sm flex-1" required>
    <input type="text" id="addTeam" class="border rounded p-1 text-sm flex-1" placeholder="Tim 1" required>
    <input type="text" id="addAnggota" class="border rounded p-1 text-sm flex-[2]" placeholder="Nama1; Nama2; ..." required>
    <button class="px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700" type="submit">Tambah</button>
  </form>
  <!-- IMPORT/EXPORT -->
  <div class="flex flex-wrap gap-2 mb-2">
    <input type="file" id="inputFile" accept=".txt,.json" class="hidden" />
    <button id="btnImport" class="px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">Import</button>
    <button id="btnExportTxt" class="px-3 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700">Export TXT</button>
    <button id="btnExportJson" class="px-3 py-1 bg-sky-600 text-white rounded text-xs hover:bg-sky-700">Export JSON</button>
    <button id="btnClear" class="px-3 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700">Clear Jadwal</button>
  </div>
  <!-- TEXTAREA PARSE -->
  <div>
    <textarea id="jadwalText" rows="4" class="w-full border rounded p-2 mb-2 text-sm" placeholder="Paste batch jadwal.txt di sini..."></textarea>
    <button id="btnParse" class="px-3 py-1 bg-purple-600 text-white rounded text-xs hover:bg-purple-700">Parse & Simpan</button>
  </div>
</div>

<!-- PREVIEW & CRUD -->
<div class="max-w-2xl mx-auto mt-4 p-4 bg-white rounded shadow">
  <h2 class="text-lg font-semibold mb-2">Preview Jadwal & Edit</h2>
  <div id="jadwalList" class="flex flex-col gap-2"></div>
</div>

<!-- OUTPUT WA -->
<div class="max-w-2xl mx-auto mt-4 mb-8 p-4 bg-white rounded shadow">
  <h2 class="text-lg font-semibold mb-2">Output WhatsApp</h2>
  <div class="mb-2 flex gap-2">
    <button id="btnShareWA" class="px-3 py-1 bg-green-500 text-white rounded text-xs hover:bg-green-600">Share to WhatsApp</button>
    <button id="btnCopyWA" class="px-3 py-1 bg-slate-200 rounded text-xs hover:bg-slate-300">Copy Text</button>
    <button id="btnPrint" class="px-3 py-1 bg-slate-200 rounded text-xs hover:bg-slate-300">Print Jadwal</button>
  </div>
  <pre id="waOutput" class="whitespace-pre-wrap bg-slate-100 p-3 rounded text-sm"></pre>
</div>
<div id="toast" class="fixed left-1/2 bottom-7 px-4 py-2 rounded shadow text-white bg-slate-800 text-sm z-50 transition-all" style="display:none;transform:translateX(-50%);"></div>
<script>
// State
let jadwalArr = [];
let settings = { title: "RONDA MALAM KAISAR RESIDENCE", jam: "23.00‚Äì04.00 WIB", tz: "WIB" };
const STORAGE_KEY = "ronda_jadwal_v2";
const SETTINGS_KEY = "ronda_settings_v2";

// Utils
function showToast(msg) { const t=document.getElementById('toast');t.textContent=msg;t.style.display='';t.style.opacity='1';setTimeout(()=>{t.style.opacity='0';},1500);setTimeout(()=>{t.style.display='none';},1800);}
function pad(n){return n<10?'0'+n:n;}
function parseTanggalToISO(s){s=s.trim().replace(/^[A-Za-z]+,\s*/,'');let [tgl,bln,th]=s.split(' ');if(!tgl||!bln||!th)return null;const bulan={Januari:1,Februari:2,Maret:3,April:4,Mei:5,Juni:6,Juli:7,Agustus:8,September:9,Oktober:10,November:11,Desember:12,Jan:1,Feb:2,Mar:3,Apr:4,Mei:5,Jun:6,Jul:7,Agu:8,Sep:9,Okt:10,Nov:11,Des:12};let m=bulan[bln];if(!m)return null;return `${th}-${pad(m)}-${pad(parseInt(tgl,10))}`;}
function formatTanggalLong(iso){const hari=['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'];const bulan=['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];let d=new Date(iso);if(isNaN(d))return iso;return `${hari[d.getDay()]}, ${d.getDate()} ${bulan[d.getMonth()]} ${d.getFullYear()}`;}

// LocalStorage
function saveJadwal(arr){localStorage.setItem(STORAGE_KEY,JSON.stringify(arr));}
function loadJadwal(){let d=localStorage.getItem(STORAGE_KEY);try{return d?JSON.parse(d):[];}catch{return [];}}
function saveSettings(obj){localStorage.setItem(SETTINGS_KEY,JSON.stringify(obj));}
function loadSettings(){let d=localStorage.getItem(SETTINGS_KEY);try{return d?JSON.parse(d):null;}catch{return null;}}

// Parse TXT
function parseJadwalTxt(txt){
  const lines=txt.split('\n').map(l=>l.trim()).filter(l=>!!l&&!/Jadwal\s+Tim/i.test(l));
  let res=[];for(let line of lines){
    let parts=line.split(',');
    if(parts.length<4)continue;
    let tanggal=parts[1].trim();
    let team=parts[2].trim();
    let membersRaw=parts.slice(3).join(',').trim();
    let members=membersRaw.split(';').map(m=>m.trim()).filter(Boolean);
    let iso=parseTanggalToISO(parts[0]+','+tanggal)||parseTanggalToISO(tanggal);
    if(!iso)continue;
    res.push({date:iso,team,members});
  }
  return res;
}

// Render List
function renderJadwalList(){
  const d=document.getElementById('jadwalList');
  if(!jadwalArr.length){d.innerHTML='<div class="text-slate-400 italic">Belum ada jadwal.</div>';return;}
  d.innerHTML='';
  jadwalArr.forEach((j,idx)=>{
    const card=document.createElement('div');
    card.className="p-2 rounded border flex flex-col gap-1 bg-slate-50 dark:bg-slate-900";
    card.innerHTML=`
    <div class="flex justify-between items-center">
      <span class="font-semibold">${formatTanggalLong(j.date)}</span>
      <div>
        <button class="text-xs px-2 py-1 rounded bg-slate-200 hover:bg-slate-400 mr-1" data-edit="${idx}">Edit</button>
        <button class="text-xs px-2 py-1 rounded bg-red-200 hover:bg-red-400" data-del="${idx}">Delete</button>
      </div>
    </div>
    <div class="flex flex-wrap gap-2 text-sm">
      <span class="font-semibold">${j.team}</span>
      <span>|</span>
      <span>${j.members.map(m=>`<span class="rounded bg-blue-100 px-2 mr-1">${m}</span>`).join('')}</span>
    </div>`;
    d.appendChild(card);
    card.querySelector(`[data-del="${idx}"]`).onclick=()=>{jadwalArr.splice(idx,1);saveJadwal(jadwalArr);renderJadwalList();renderWAOutput();}
    card.querySelector(`[data-edit="${idx}"]`).onclick=()=>{
      document.getElementById('addTanggal').value=j.date;
      document.getElementById('addTeam').value=j.team;
      document.getElementById('addAnggota').value=j.members.join('; ');
      jadwalArr.splice(idx,1);
      saveJadwal(jadwalArr);
      renderJadwalList();
      renderWAOutput();
      showToast('Edit baris pada form, lalu klik Tambah');
    }
  });
}

// WhatsApp Output
function generateWAOutput(jadwalArr,settings){
  if(!jadwalArr.length)return 'Belum ada jadwal!';
  let grouped={};jadwalArr.forEach(j=>{if(!grouped[j.team])grouped[j.team]=[];grouped[j.team].push(j);});
  Object.values(grouped).forEach(arr=>arr.sort((a,b)=>a.date.localeCompare(b.date)));
  let outputArr=[];
  for(let team in grouped){
    let sorted=grouped[team],first=sorted[0],others=sorted.slice(1);
    outputArr.push(
`üî•üö® *${settings.title}* üö®üî•

üìÜ *${formatTanggalLong(first.date)}*  
‚è∞ *Waktu Jaga:* ${settings.jam}  

üë• *${first.team}*  
üëÆ‚Äç‚ôÇÔ∏è *Petugas:*  
${first.members.map(m=>`‚Ä¢ ${m}`).join('\n')}

üìå *Jadwal Selanjutnya ${first.team}:*  
${others.map(j=>`‚Ä¢ ${formatTanggalLong(j.date)}`).join('\n')||'‚Ä¢ -'}

üôè Terima kasih atas partisipasinya.  
Mari jaga lingkungan tetap aman dan nyaman bersama-sama.  

üí• *Keamanan Kita Prioritas!* üí•
`
    );
  }
  return outputArr.join('\n\n‚Äî\n\n');
}
function renderWAOutput(){
  document.getElementById('waOutput').textContent=generateWAOutput(jadwalArr,settings);
}

// SETTINGS
function updateSettingsFromForm(){
  settings.title=document.getElementById('inputTitle').value.trim()||'RONDA MALAM KAISAR RESIDENCE';
  settings.jam=document.getElementById('inputJam').value.trim()||'23.00‚Äì04.00 WIB';
  settings.tz=document.getElementById('inputTz').value.trim()||'WIB';
  saveSettings(settings);
  renderWAOutput();
  document.getElementById('appTitle').textContent=settings.title;
}
document.getElementById('settingsForm').oninput=updateSettingsFromForm;

// DARK MODE
document.getElementById('darkToggle').onclick=function(){
  document.body.classList.toggle('dark');
  localStorage.setItem('ronda_dark',document.body.classList.contains('dark')?"1":"0");
}

// ADD BARIS
document.getElementById('addRowForm').onsubmit=function(e){
  e.preventDefault();
  let date=document.getElementById('addTanggal').value,team=document.getElementById('addTeam').value,members=document.getElementById('addAnggota').value;
  if(!date||!team||!members){showToast('Lengkapi semua input!');return;}
  jadwalArr.push({date,team,members:members.split(';').map(m=>m.trim()).filter(Boolean)});
  saveJadwal(jadwalArr);
  renderJadwalList();renderWAOutput();
  document.getElementById('addTanggal').value='';document.getElementById('addTeam').value='';document.getElementById('addAnggota').value='';
}

// IMPORT
document.getElementById('btnImport').onclick=()=>document.getElementById('inputFile').click();
document.getElementById('inputFile').onchange=function(e){
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=ev=>{
    if(f.name.endsWith('.json')){
      try{jadwalArr=JSON.parse(ev.target.result)||[];}catch{showToast('Format JSON salah!');return;}
    }else{
      jadwalArr=parseJadwalTxt(ev.target.result);
    }
    saveJadwal(jadwalArr);renderJadwalList();renderWAOutput();
    showToast('Berhasil import!');
  };
  r.readAsText(f);
}

// EXPORT
document.getElementById('btnExportTxt').onclick=function(){
  let lines=jadwalArr.map(j=>`${formatTanggalLong(j.date)}, ${j.team}, ${j.members.join('; ')}`);
  let blob=new Blob([lines.join('\n')],{type:'text/plain'}),a=document.createElement('a');
  a.href=URL.createObjectURL(blob);a.download="jadwal_ronda.txt";a.click();URL.revokeObjectURL(a.href);showToast('Export TXT!');
};
document.getElementById('btnExportJson').onclick=function(){
  let blob=new Blob([JSON.stringify(jadwalArr,null,2)],{type:'application/json'}),a=document.createElement('a');
  a.href=URL.createObjectURL(blob);a.download="jadwal_ronda.json";a.click();URL.revokeObjectURL(a.href);showToast('Export JSON!');
};

// CLEAR
document.getElementById('btnClear').onclick=function(){
  if(confirm('Hapus semua jadwal?')){jadwalArr=[];saveJadwal(jadwalArr);renderJadwalList();renderWAOutput();}
}

// PARSE & SIMPAN
document.getElementById('btnParse').onclick=function(){
  let txt=document.getElementById('jadwalText').value;
  let arr=parseJadwalTxt(txt);
  if(!arr.length){showToast('Format tidak dikenali!');return;}
  jadwalArr=arr;saveJadwal(jadwalArr);renderJadwalList();renderWAOutput();showToast('Jadwal diparse & simpan!');
};

// WA
document.getElementById('btnShareWA').onclick=function(){
  let waText=document.getElementById('waOutput').textContent;window.open('https://wa.me/?text='+encodeURIComponent(waText),'_blank');
};
document.getElementById('btnCopyWA').onclick=function(){
  navigator.clipboard.writeText(document.getElementById('waOutput').textContent);showToast('Teks disalin!');
};
document.getElementById('btnPrint').onclick=function(){window.print();};

// INIT
window.onload=function(){
  if(localStorage.getItem('ronda_dark')==="1")document.body.classList.add('dark');
  let s=loadSettings();if(s){settings=s;document.getElementById('inputTitle').value=s.title;document.getElementById('inputJam').value=s.jam;document.getElementById('inputTz').value=s.tz;document.getElementById('appTitle').textContent=s.title;}
  jadwalArr=loadJadwal();renderJadwalList();renderWAOutput();
};
</script>
</body>
</html>
