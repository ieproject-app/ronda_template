<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ronda Malam Scheduler</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <meta name="color-scheme" content="dark light">
    <style>
        /* Base styles and theme variables */
        :root {
            --bg-light: #f8fafc; --text-light: #1e293b; --card-bg-light: #ffffff;
            --bg-dark: #0b1120; --text-dark: #e2e8f0; --card-bg-dark: #1e293b;
            --border-light: #e2e8f0; --border-dark: #334155;
            --primary: #3b82f6; --primary-hover: #2563eb;
            --green: #22c55e; --red: #ef4444; --slate: #64748b;
        }
        html { color-scheme: light dark; font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
        body { transition: background-color 0.3s, color 0.3s; }
        body.dark { background-color: var(--bg-dark); color: var(--text-dark); }
        .card {
            background-color: var(--card-bg-light);
            border: 1px solid var(--border-light);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        body.dark .card { background-color: var(--card-bg-dark); border-color: var(--border-dark); }
        .card:hover { transform: translateY(-3px); box-shadow: 0 7px 20px -5px rgba(0,0,0,0.07); }
        body.dark .card:hover { box-shadow: 0 7px 20px -5px rgba(0,0,0,0.2); }
        
        /* Modal (Overlay) styles */
        .modal-overlay {
            background: rgba(0,0,0,.6); backdrop-filter: blur(5px);
            position: fixed; z-index: 1000;
            left:0; top:0; width:100%; height:100%;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: opacity .25s; pointer-events: none;
        }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-panel {
            background-color: var(--card-bg-light); color: var(--text-light);
            max-width: 95vw; width: 500px;
            border-radius: 1rem; padding: 1.5rem;
            box-shadow: 0 10px 40px #0003;
            transform: scale(0.95); transition: transform .25s;
        }
        .modal-overlay.visible .modal-panel { transform: scale(1); }
        body.dark .modal-panel { background-color: var(--card-bg-dark); color: var(--text-dark); }

        /* Custom button styles */
        .btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: all .2s; display: inline-flex; align-items: center; gap: 0.5rem; justify-content: center; cursor: pointer; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-secondary { background-color: var(--border-light); color: var(--text-light); border: 1px solid var(--border-light); }
        .btn-secondary:hover { background-color: #e2e8f0; border-color: #cbd5e1; }
        body.dark .btn-secondary { background-color: #334155; color: #e2e8f0; border-color: #475569; }
        body.dark .btn-secondary:hover { background-color: #475569; }
        .btn-danger { background-color: var(--red); color: white; }
        .btn-success { background-color: var(--green); color: white; }
        .btn-icon { padding: 0.5rem; }

        /* Toast Notification */
        #toast {
            position: fixed; left: 50%; bottom: 20px; transform: translate(-50%, 100px);
            background-color: #1e293b; color: white;
            padding: 10px 20px; border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 9999;
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        #toast.show { transform: translate(-50%, 0); }
        body.dark #toast { background-color: #e2e8f0; color: #1e293b; }

        @media print { .no-print { display:none !important;} }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-gray-900 dark:text-slate-200">

    <!-- Header -->
    <header class="bg-white/80 dark:bg-gray-900/80 backdrop-blur-lg sticky top-0 z-50 border-b border-slate-200 dark:border-slate-800 no-print">
        <div class="max-w-5xl mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-xl font-bold text-slate-900 dark:text-white">
                Ronda<span class="text-blue-500">Scheduler</span>
            </h1>
            <div class="flex items-center gap-2">
                <button id="btnPrint" class="btn btn-secondary text-xs">Print</button>
                <button id="btnShowTutorial" class="btn btn-secondary text-xs">Tutorial</button>
                <button id="btnToggleTheme" class="btn btn-secondary btn-icon" title="Toggle Dark Mode">
                    <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/></svg>
                    <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-moon-stars-fill hidden" viewBox="0 0 16 16"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/><path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162h1.212a.217.217 0 0 1 .162.321l-.988.715.387 1.162a.217.217 0 0 1-.321.242l-.988-.715-.988.715a.217.217 0 0 1-.321-.242l.387-1.162-.988-.715a.217.217 0 0 1 .162-.321h1.212l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a.752.752 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a.752.752 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774.258c.346-.115.617-.386.732-.732L13.863.1z"/></svg>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-5xl mx-auto p-4">
        <!-- Controls -->
        <div class="mb-6 p-4 bg-white dark:bg-slate-800 rounded-xl shadow-sm no-print">
             <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <input type="file" id="inputFile" accept=".txt,.json" class="hidden" />
                <button id="btnImport" class="btn btn-primary">
                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/></svg>
                    Import
                </button>
                <button id="btnExportJson" class="btn btn-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v-2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg>
                    Export
                </button>
                <button id="btnCopyFormatTxt" class="btn btn-secondary">
                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3z"/></svg>
                    Copy All
                </button>
                <button id="btnClear" class="btn btn-danger">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5z"/><path d="M11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H2.506a.58.58 0 0 0-.01 0H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1h-.995a.59.59 0 0 0-.01 0H11zm-6.465 1h7.93l-.862 10.777a1 1 0 0 1-.997.923H4.885a1 1 0 0 1-.997-.923L4.535 3.5zM7 5.5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zm3 0a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5z"/></svg>
                    Clear All
                </button>
             </div>
        </div>

        <!-- Schedule Container -->
        <div id="scheduleContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
            <!-- Schedule cards will be injected here -->
        </div>

        <!-- Not Found Message -->
        <div id="notFound" class="text-center text-slate-500 dark:text-slate-400 p-10 rounded-lg border-2 border-dashed border-slate-300 dark:border-slate-700 hidden">
            <h3 class="text-xl font-semibold">Jadwal Kosong</h3>
            <p class="mt-2">Silakan import jadwal menggunakan tombol di atas untuk memulai.</p>
        </div>
    </main>

    <!-- Modal for Editing -->
    <div id="editModal" class="modal-overlay">
        <div class="modal-panel">
            <h2 class="text-xl font-bold mb-4">Edit Jadwal</h2>
            <form id="editForm">
                <div class="mb-3">
                    <label for="editTanggal" class="block text-sm font-medium mb-1">Tanggal</label>
                    <input type="date" id="editTanggal" class="w-full p-2 border rounded-md bg-slate-50 dark:bg-slate-700 border-slate-300 dark:border-slate-600" required>
                </div>
                <div class="mb-3">
                    <label for="editTeam" class="block text-sm font-medium mb-1">Tim</label>
                    <input type="text" id="editTeam" class="w-full p-2 border rounded-md bg-slate-50 dark:bg-slate-700 border-slate-300 dark:border-slate-600" required>
                </div>
                <div class="mb-4">
                    <label for="editAnggota" class="block text-sm font-medium mb-1">Anggota (satu per baris)</label>
                    <textarea id="editAnggota" rows="5" class="w-full p-2 border rounded-md bg-slate-50 dark:bg-slate-700 border-slate-300 dark:border-slate-600 resize-y" required></textarea>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" id="btnCancelEdit" class="btn btn-secondary">Batal</button>
                    <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal for Tutorial -->
    <div id="tutorialModal" class="modal-overlay">
         <div class="modal-panel">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Tutorial Penggunaan</h2>
                <button id="btnCloseTutorial" class="btn btn-icon btn-secondary">&times;</button>
            </div>
            <div class="space-y-4 text-sm text-slate-600 dark:text-slate-300">
                <p><b>1. Import Jadwal:</b> Klik tombol <b>Import</b> untuk memuat data jadwal Anda. Format TXT: <code>Hari, Tanggal, Tim, Anggota1; Anggota2; ...</code></p>
                <p><b>2. Kelola Jadwal:</b> Setiap tanggal ditampilkan sebagai kartu. Gunakan tombol pada setiap kartu untuk <b>Mengedit</b>, <b>Membagikan ke WA</b>, atau <b>Menyalin Teks</b>.</p>
                <p><b>3. Export & Backup:</b> Gunakan tombol <b>Export</b> untuk menyimpan semua data, atau <b>Copy All</b> untuk menyalin semua jadwal dalam format teks.</p>
                <p><b>4. Hapus Jadwal:</b> Tombol <b>Clear All</b> akan menghapus semua data secara permanen (akan ada konfirmasi).</p>
                <p><b>5. Mode Gelap & Print:</b> Gunakan ikon ‚òÄÔ∏è/üåô untuk mengubah tema dan tombol <b>Print</b> untuk mencetak jadwal.</p>
            </div>
        </div>
    </div>
    
    <!-- Modal for Confirmation -->
    <div id="confirmModal" class="modal-overlay">
         <div class="modal-panel w-full max-w-sm">
            <h2 class="text-lg font-bold mb-2">Konfirmasi</h2>
            <p id="confirmMessage" class="text-slate-600 dark:text-slate-300 mb-6"></p>
            <div class="flex justify-end gap-3">
                <button id="btnConfirmCancel" class="btn btn-secondary">Batal</button>
                <button id="btnConfirmOk" class="btn btn-danger">Ya, Lanjutkan</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast">Pesan notifikasi</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // STATE
    let jadwalArr = [];
    let editIdx = null;
    const STORAGE_KEY = "ronda_jadwal_v3";
    const randomKata2 = [
        "Keamanan Kita Prioritas!", "Utamakan Siskamling, Nyaman Bersama!", "Bersama, Lingkungan Aman Nyaman!",
        "Jaga Lingkungan, Jaga Keluarga!", "Satukan Langkah, Aman Bersama!", "Ronda untuk Harmoni Bersama!",
        "Bersatu Menjaga, Damai Dirasa!", "Bersama kita lebih kuat!", "Ronda Malam, Wujud Peduli!", "Ayo Jaga Malam, Demi Kenyamanan!"
    ];

    // DOM ELEMENTS
    const scheduleContainer = document.getElementById('scheduleContainer');
    const notFoundDiv = document.getElementById('notFound');
    const inputFile = document.getElementById('inputFile');
    // Modals
    const editModal = document.getElementById('editModal');
    const tutorialModal = document.getElementById('tutorialModal');
    const confirmModal = document.getElementById('confirmModal');
    const confirmMessage = document.getElementById('confirmMessage');

    // --- UTILS ---
    const showToast = (msg) => {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.classList.add('show');
        setTimeout(() => { t.classList.remove('show'); }, 2500);
    };

    const openModal = (modalElement) => {
        modalElement.classList.add('visible');
        document.body.style.overflow = 'hidden';
    };

    const closeModal = (modalElement) => {
        modalElement.classList.remove('visible');
        document.body.style.overflow = '';
    };

    const showConfirm = (message) => {
        return new Promise((resolve) => {
            confirmMessage.textContent = message;
            openModal(confirmModal);
            
            const okButton = document.getElementById('btnConfirmOk');
            const cancelButton = document.getElementById('btnConfirmCancel');

            const resolveTrue = () => {
                closeModal(confirmModal);
                resolve(true);
                cleanup();
            };
            const resolveFalse = () => {
                closeModal(confirmModal);
                resolve(false);
                cleanup();
            };
            
            const cleanup = () => {
                okButton.removeEventListener('click', resolveTrue);
                cancelButton.removeEventListener('click', resolveFalse);
            };

            okButton.addEventListener('click', resolveTrue, { once: true });
            cancelButton.addEventListener('click', resolveFalse, { once: true });
        });
    };

    const pad = (n) => n < 10 ? '0' + n : n;

    const formatTanggalLong = (iso) => {
        const hari = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
        const bulan = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
        try {
            const d = new Date(iso + 'T00:00:00');
            if (isNaN(d)) return iso;
            return `${hari[d.getDay()]}, ${d.getDate()} ${bulan[d.getMonth()]} ${d.getFullYear()}`;
        } catch (e) { return iso; }
    };
    
    const parseTanggalToISO = (s) => {
        s = s.trim().replace(/^[A-Za-z]+,\s*/, '');
        let [tgl, blnName, th] = s.split(' ');
        if (!tgl || !blnName || !th) return null;
        const bulan = { Januari:1, Februari:2, Maret:3, April:4, Mei:5, Juni:6, Juli:7, Agustus:8, September:9, Oktober:10, November:11, Desember:12, Jan:1, Feb:2, Mar:3, Apr:4, Mei:5, Jun:6, Jul:7, Agu:8, Sep:9, Okt:10, Nov:11, Des:12 };
        let m = Object.keys(bulan).find(key => blnName.toLowerCase() === key.toLowerCase());
        if(!m) return null;
        return `${th}-${pad(bulan[m])}-${pad(parseInt(tgl, 10))}`;
    };

    // --- DATA HANDLING ---
    const saveJadwal = (arr) => localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    const loadJadwal = () => { try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; } catch { return []; }};
    
    const parseJadwalTxt = (txt) => {
        const lines = txt.split('\n').map(l => l.trim()).filter(l => !!l && !/Jadwal\s+Tim/i.test(l));
        let res = [];
        for (let line of lines) {
            let parts = line.split(',');
            if (parts.length < 4) continue;
            let tanggal = parts[1].trim();
            let team = parts[2].trim();
            let membersRaw = parts.slice(3).join(',').trim();
            let members = membersRaw.split(';').map(m => m.trim()).filter(Boolean);
            let iso = parseTanggalToISO(parts[0] + ',' + tanggal) || parseTanggalToISO(tanggal);
            if (!iso) continue;
            res.push({ date: iso, team, members });
        }
        return res;
    };

    // --- RENDER ---
    const renderSchedules = () => {
        scheduleContainer.innerHTML = '';
        if (jadwalArr.length === 0) {
            notFoundDiv.classList.remove('hidden');
            return;
        }
        notFoundDiv.classList.add('hidden');
        
        const todayISO = new Date().toISOString().slice(0, 10);

        jadwalArr.forEach((jadwal, index) => {
            const isToday = jadwal.date === todayISO;
            const card = document.createElement('div');
            card.className = `card p-5 rounded-xl flex flex-col ${isToday ? 'border-2 border-blue-500' : ''}`;
            card.id = `jadwal-${jadwal.date}`;
            
            card.innerHTML = `
                <div class="flex-grow">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <p class="font-semibold text-lg text-slate-800 dark:text-white">${jadwal.team}</p>
                            <p class="text-sm text-slate-500 dark:text-slate-400">${formatTanggalLong(jadwal.date)}</p>
                        </div>
                        ${isToday ? '<span class="text-xs bg-blue-100 text-blue-800 font-semibold px-2 py-1 rounded-full dark:bg-blue-900 dark:text-blue-200">Hari Ini</span>' : ''}
                    </div>
                    <div class="mt-4">
                        <p class="text-sm font-medium mb-2 text-slate-600 dark:text-slate-300">Petugas Jaga:</p>
                        <div class="flex flex-wrap gap-2">
                            ${jadwal.members.map(m => `<span class="bg-slate-100 text-slate-700 text-sm font-medium px-3 py-1 rounded-full dark:bg-slate-700 dark:text-slate-200">${m}</span>`).join('')}
                        </div>
                    </div>
                </div>
                <div class="border-t border-slate-200 dark:border-slate-700 mt-5 pt-4 flex gap-2 justify-end no-print">
                    <button class="btn btn-secondary btn-sm btn-edit" data-index="${index}" title="Edit">Edit</button>
                    <button class="btn btn-secondary btn-sm btn-copy" data-index="${index}" title="Copy Text">Copy</button>
                    <button class="btn btn-sm btn-wa-share" style="background-color:#25D366; color:white;" data-index="${index}" title="Bagikan ke WhatsApp">Share WA</button>
                </div>
            `;
            scheduleContainer.appendChild(card);
        });
    };

    const generateWAOutput = (index) => {
        const j = jadwalArr[index];
        if (!j) return 'Jadwal tidak ditemukan.';
        const settings = { title: "RONDA MALAM", jam: "23.00‚Äì04.00 WIB" };
        const selanjutnya = jadwalArr.filter(row => row.team === j.team && row.date > j.date).map(row => `‚Ä¢ ${formatTanggalLong(row.date)}`).join('\n') || '‚Ä¢ -';
        const randomQuote = randomKata2[Math.floor(Math.random() * randomKata2.length)];
        return `üö® *${settings.title}* üö®üî•\n\n` +
               `üìÜ *${formatTanggalLong(j.date)}*\n` +
               `‚è∞ *Waktu Jaga:* ${settings.jam}\n\n` +
               `üë• *${j.team}*\n` +
               `üëÆ‚Äç‚ôÇÔ∏è *Petugas:*\n${j.members.map(m => `‚Ä¢ ${m}`).join('\n')}\n\n` +
               `üìå *Jadwal Selanjutnya ${j.team}:*\n${selanjutnya}\n\n` +
               `üôè Terima kasih atas partisipasinya. Mari jaga lingkungan tetap aman dan nyaman bersama-sama.\n\n` +
               `üí• *${randomQuote}* üí•`;
    };

    // --- EVENT LISTENERS ---
    
    // Main Controls
    document.getElementById('btnImport').onclick = () => inputFile.click();
    inputFile.onchange = (e) => {
        const f = e.target.files[0];
        if (!f) return;
        const r = new FileReader();
        r.onload = ev => {
            const fileContent = ev.target.result;
            let parsedJadwal;
            if (f.name.endsWith('.json')) {
                try { parsedJadwal = JSON.parse(fileContent) || []; }
                catch { showToast('Format JSON salah!'); return; }
            } else {
                parsedJadwal = parseJadwalTxt(fileContent);
            }

            if (parsedJadwal.length === 0 && fileContent.trim() !== '') {
                showToast('Gagal memuat jadwal. Periksa format file.');
            } else {
                showToast('Berhasil import jadwal!');
            }
            
            jadwalArr = parsedJadwal;
            jadwalArr.sort((a,b) => a.date.localeCompare(b.date));
            saveJadwal(jadwalArr);
            renderSchedules();
        };
        r.readAsText(f);
        e.target.value = null; // Reset file input
    };

    document.getElementById('btnExportJson').onclick = () => {
        if (!jadwalArr.length) { showToast('Tidak ada jadwal untuk diexport.'); return; }
        const blob = new Blob([JSON.stringify(jadwalArr, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "jadwal_ronda.json";
        a.click();
        URL.revokeObjectURL(a.href);
        showToast('Export JSON berhasil!');
    };

    document.getElementById('btnCopyFormatTxt').onclick = () => {
        if (!jadwalArr.length) { showToast('Tidak ada jadwal untuk disalin.'); return; }
        const lines = jadwalArr.map(j => `${formatTanggalLong(j.date)}, ${j.team}, ${j.members.join('; ')}`);
        navigator.clipboard.writeText(lines.join('\n'))
            .then(() => showToast('Seluruh jadwal dicopy sebagai format TXT!'))
            .catch(err => {
                console.error("Copy Error:", err);
                showToast('Gagal menyalin. Coba lagi di browser modern.');
            });
    };
    
    document.getElementById('btnClear').onclick = async () => {
        const confirmed = await showConfirm('Apakah Anda yakin ingin menghapus semua jadwal? Tindakan ini tidak dapat dibatalkan.');
        if (confirmed) {
            jadwalArr = [];
            saveJadwal([]);
            renderSchedules();
            showToast('Semua jadwal telah dihapus.');
        }
    };

    document.getElementById('btnPrint').onclick = () => window.print();

    // Card Actions (Event Delegation)
    scheduleContainer.addEventListener('click', (e) => {
        const target = e.target.closest('button');
        if (!target) return;
        const index = target.dataset.index;
        if(index === undefined) return;
        
        if(target.classList.contains('btn-edit')) {
            editIdx = parseInt(index, 10);
            const j = jadwalArr[editIdx];
            document.getElementById('editTanggal').value = j.date;
            document.getElementById('editTeam').value = j.team;
            document.getElementById('editAnggota').value = j.members.join('\n');
            openModal(editModal);
        }
        else if(target.classList.contains('btn-copy')) {
            const waText = generateWAOutput(index);
            navigator.clipboard.writeText(waText)
                .then(() => showToast('Teks jadwal disalin!'))
                .catch(err => {
                    console.error("Copy Error:", err);
                    showToast('Gagal menyalin teks.');
                });
        }
        else if(target.classList.contains('btn-wa-share')) {
            // Optimized WhatsApp sharing
            const waText = generateWAOutput(index);
            // Prefer WhatsApp Web if on desktop, WhatsApp app if on mobile
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

            // Custom fallback for WhatsApp share
            const waUrl = isMobile
                ? 'whatsapp://send?text=' + encodeURIComponent(waText)
                : 'https://wa.me/?text=' + encodeURIComponent(waText);

            // Try Web Share API with WhatsApp if available (on mobile, with WhatsApp installed)
            if (navigator.share && isMobile) {
                navigator.share({ text: waText })
                    .catch(() => {
                        // fallback ke WhatsApp URL jika user cancel atau tidak support
                        window.open(waUrl, '_blank');
                    });
            } else {
                window.open(waUrl, '_blank');
            }
        }
    });

    // Edit Modal
    document.getElementById('editForm').onsubmit = (e) => {
        e.preventDefault();
        if (editIdx === null) return;
        const tgl = document.getElementById('editTanggal').value;
        const tim = document.getElementById('editTeam').value;
        const anggota = document.getElementById('editAnggota').value.split('\n').map(m => m.trim()).filter(Boolean);
        
        if (!tgl || !tim || !anggota.length) { showToast('Lengkapi semua input!'); return; }
        
        jadwalArr[editIdx] = { date: tgl, team: tim, members: anggota };
        jadwalArr.sort((a,b) => a.date.localeCompare(b.date));
        saveJadwal(jadwalArr);
        
        renderSchedules();
        closeModal(editModal);
        showToast('Jadwal berhasil disimpan!');
        editIdx = null;
    };
    document.getElementById('btnCancelEdit').onclick = () => closeModal(editModal);

    // Tutorial Modal
    document.getElementById('btnShowTutorial').onclick = () => openModal(tutorialModal);
    document.getElementById('btnCloseTutorial').onclick = () => closeModal(tutorialModal);

    // Close modals on overlay click
    [editModal, tutorialModal, confirmModal].forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal(modal);
            }
        });
    });

    // Theme Toggle
    const themeToggleBtn = document.getElementById('btnToggleTheme');
    const lightIcon = document.getElementById('theme-icon-light');
    const darkIcon = document.getElementById('theme-icon-dark');
    
    const applyTheme = (isDark) => {
        document.body.classList.toggle('dark', isDark);
        lightIcon.classList.toggle('hidden', isDark);
        darkIcon.classList.toggle('hidden', !isDark);
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
    };
    
    themeToggleBtn.onclick = () => {
        const isDark = document.body.classList.contains('dark');
        applyTheme(!isDark);
    };

    // --- INITIALIZATION ---
    const init = () => {
        const preferredTheme = localStorage.getItem('theme');
        const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        applyTheme(preferredTheme ? preferredTheme === 'dark' : systemPrefersDark);

        jadwalArr = loadJadwal();
        renderSchedules();

        const todayISO = new Date().toISOString().slice(0, 10);
        const todayCard = document.getElementById(`jadwal-${todayISO}`);
        if (todayCard) {
            setTimeout(() => todayCard.scrollIntoView({ behavior: 'smooth', block: 'center' }), 200);
        }
    };
    
    init();
});
</script>
</body>
</html>
