<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
  <title>Siskamling Maestro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <meta name="color-scheme" content="dark light">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
    
    :root {
      --primary: #2563eb;
      --secondary: #1e40af;
      --accent: #22c55e;
      --card: #f0f9ff;
      --text: #1e293b;
      --border: #cbd5e1;
    }
    
    body.dark {
      --primary: #3b82f6;
      --secondary: #1e40af;
      --accent: #22c55e;
      --card: #1e293b;
      --text: #f1f5f9;
      --border: #475569;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #f0f9ff, #e6f7ff);
      color: var(--text);
      transition: background 0.3s, color 0.3s;
      min-height: 100vh;
      padding: 20px;
    }
    
    body.dark {
      background: linear-gradient(135deg, #0f172a, #1e293b);
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
    }
    
    /* Header Styles */
    .app-header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
    }
    
    .app-header h1 {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--secondary);
      margin-bottom: 10px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .app-header p {
      font-size: 1.1rem;
      color: var(--text);
      opacity: 0.8;
    }
    
    .divider {
      height: 3px;
      background: linear-gradient(to right, transparent, var(--primary), transparent);
      margin: 25px 0;
      border-radius: 10px;
    }
    
    /* Card Styles */
    .card {
      background: var(--card);
      border-radius: 16px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.12);
      padding: 25px;
      margin-bottom: 25px;
      transition: all 0.3s ease;
      border: 1px solid var(--border);
    }
    
    .card-title {
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .card-title i {
      font-size: 1.6rem;
    }
    
    /* Button Styles */
    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      margin-bottom: 10px;
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 20px;
      border-radius: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      min-width: 140px;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--secondary);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    
    .btn-success {
      background: #22c55e;
      color: white;
    }
    
    .btn-info {
      background: #0ea5e9;
      color: white;
    }
    
    .btn-danger {
      background: #ef4444;
      color: white;
    }
    
    .btn-secondary {
      background: #94a3b8;
      color: white;
    }
    
    /* Filter Section */
    .filter-section {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      align-items: center;
      margin-bottom: 25px;
    }
    
    .filter-item {
      flex: 1;
      min-width: 200px;
    }
    
    .filter-item label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--text);
    }
    
    .filter-item select,
    .filter-item input {
      width: 100%;
      padding: 12px 15px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      font-size: 1rem;
    }
    
    .date-navigation {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 20px 0;
    }
    
    /* Schedule Table */
    .schedule-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    }
    
    .schedule-table th {
      background: var(--primary);
      color: white;
      padding: 15px;
      text-align: left;
      font-weight: 600;
    }
    
    .schedule-table td {
      padding: 15px;
      border-bottom: 1px solid var(--border);
      background: var(--card);
    }
    
    .schedule-table tr:last-child td {
      border-bottom: none;
    }
    
    .team-name {
      font-weight: 600;
      color: var(--secondary);
    }
    
    .member-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    
    .member-tag {
      background: rgba(34, 197, 94, 0.15);
      color: #15803d;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.9rem;
    }
    
    body.dark .member-tag {
      background: rgba(34, 197, 94, 0.2);
      color: #86efac;
    }
    
    /* WhatsApp Preview */
    .wa-preview {
      background: #f7fdf9;
      color: #2d4736;
      border: 1px solid #25D366;
      border-radius: 16px;
      padding: 25px;
      margin-top: 20px;
      line-height: 1.7;
      white-space: pre-wrap;
      font-size: 1.05rem;
    }
    
    body.dark .wa-preview {
      background: #17291e;
      color: #e9ffe2;
      border-color: #25D366;
    }
    
    .wa-preview b {
      color: var(--primary);
    }
    
    .wa-actions {
      display: flex;
      justify-content: flex-end;
      gap: 15px;
      margin-top: 20px;
    }
    
    .wa-btn {
      min-width: 140px;
    }
    
    /* Mobile Action Bar */
    .mobile-action-bar {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      z-index: 1100;
      background: var(--card);
      border-top: 1px solid var(--border);
      box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
      display: flex;
      gap: 15px;
      padding: 15px;
      justify-content: center;
      align-items: center;
      display: none;
    }
    
    /* Edit Panel */
    .edit-panel {
      margin-top: 30px;
      padding: 25px;
      border-radius: 16px;
      background: var(--card);
      border: 1px solid var(--border);
    }
    
    .edit-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .form-group label {
      font-weight: 500;
    }
    
    .form-group input,
    .form-group textarea {
      padding: 12px 15px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      font-family: inherit;
    }
    
    .form-group textarea {
      min-height: 120px;
      resize: vertical;
    }
    
    .form-actions {
      display: flex;
      gap: 15px;
      margin-top: 10px;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .btn {
        min-width: 100%;
      }
      
      .filter-section {
        flex-direction: column;
        align-items: stretch;
      }
      
      .schedule-table {
        font-size: 0.9rem;
      }
      
      .schedule-table th, 
      .schedule-table td {
        padding: 12px;
      }
      
      .wa-actions {
        flex-direction: column;
      }
      
      .mobile-action-bar {
        display: flex;
      }
    }
    
    @media (max-width: 480px) {
      .app-header h1 {
        font-size: 2rem;
      }
      
      .card {
        padding: 20px;
      }
    }
    
    /* Animation */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="app-header fade-in">
      <h1>Siskamling Maestro</h1>
      <p>Kelola jadwal ronda dengan mudah dan efisien</p>
    </header>
    
    <div class="divider"></div>
    
    <div class="card fade-in">
      <div class="card-title">
        <i class="fas fa-file-import"></i>
        <span>Manajemen Data</span>
      </div>
      
      <div class="btn-group">
        <button id="btnImport" class="btn btn-primary">
          <i class="fas fa-file-import"></i>
          Import Data
        </button>
        <button id="btnExportTxt" class="btn btn-success">
          <i class="fas fa-file-export"></i>
          Export TXT
        </button>
        <button id="btnExportJson" class="btn btn-info">
          <i class="fas fa-file-code"></i>
          Export JSON
        </button>
        <button id="btnClear" class="btn btn-danger">
          <i class="fas fa-trash-alt"></i>
          Clear Jadwal
        </button>
        <button id="btnCopyFormatTxt" class="btn btn-secondary">
          <i class="fas fa-copy"></i>
          Copy Format
        </button>
      </div>
      
      <input type="file" id="inputFile" accept=".txt,.json" class="hidden" />
    </div>
    
    <div class="card fade-in">
      <div class="card-title">
        <i class="fas fa-filter"></i>
        <span>Filter Jadwal</span>
      </div>
      
      <div class="filter-section">
        <div class="filter-item">
          <label for="filterTeam">Filter Tim</label>
          <select id="filterTeam">
            <option value="">Semua Tim</option>
            <!-- Options will be populated by JS -->
          </select>
        </div>
        
        <div class="filter-item">
          <label for="datePicker">Pilih Tanggal</label>
          <input type="date" id="datePicker" />
        </div>
      </div>
      
      <div class="date-navigation">
        <button id="btnPrev" class="btn btn-primary">
          <i class="fas fa-chevron-left"></i>
          Sebelumnya
        </button>
        <button id="btnNext" class="btn btn-primary">
          Selanjutnya
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>
    
    <div class="card fade-in">
      <div class="card-title">
        <i class="fas fa-calendar-alt"></i>
        <span>Jadwal Ronda</span>
      </div>
      
      <div id="previewContainer">
        <table class="schedule-table">
          <thead>
            <tr>
              <th>Tanggal</th>
              <th>Tim</th>
              <th>Anggota</th>
            </tr>
          </thead>
          <tbody id="previewTableBody">
            <!-- Content will be populated by JS -->
          </tbody>
        </table>
        <div id="notFound"></div>
      </div>
    </div>
    
    <div class="card fade-in" id="editRowPanel" style="display: none;">
      <div class="card-title">
        <i class="fas fa-edit"></i>
        <span>Edit Jadwal</span>
      </div>
      
      <div class="edit-panel">
        <form id="editForm" class="edit-form">
          <div class="form-group">
            <label for="editTanggal">Tanggal</label>
            <input type="date" id="editTanggal" required>
          </div>
          
          <div class="form-group">
            <label for="editTeam">Tim</label>
            <input type="text" id="editTeam" required>
          </div>
          
          <div class="form-group">
            <label for="editAnggota">Anggota (satu per baris)</label>
            <textarea id="editAnggota" required></textarea>
          </div>
          
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save"></i>
              Simpan
            </button>
            <button type="button" id="btnCancelEdit" class="btn btn-secondary">
              <i class="fas fa-times"></i>
              Batal
            </button>
          </div>
        </form>
      </div>
    </div>
    
    <div class="card fade-in">
      <div class="card-title">
        <i class="fab fa-whatsapp"></i>
        <span>Preview Pengumuman WhatsApp</span>
      </div>
      
      <div class="wa-actions" id="waBtnDesktop">
        <button id="btnCopyWA" class="btn btn-success wa-btn">
          <i class="fas fa-copy"></i>
          Copy Teks
        </button>
        <button id="btnEditRow" class="btn btn-primary wa-btn">
          <i class="fas fa-edit"></i>
          Edit
        </button>
      </div>
      
      <div id="waOutput" class="wa-preview">
        <!-- WhatsApp preview will be populated by JS -->
      </div>
    </div>
    
    <div class="mobile-action-bar">
      <button id="btnCopyWAMobile" class="btn btn-success">
        <i class="fas fa-copy"></i>
        Copy Teks
      </button>
      <button id="btnEditRowMobile" class="btn btn-primary">
        <i class="fas fa-edit"></i>
        Edit
      </button>
    </div>
  </div>

  <script>
    let jadwalArr = [];
    let currentTanggal = null;
    let editIdx = null;
    let currentFilterTeam = "";
    const STORAGE_KEY = "ronda_jadwal_v4";
    const randomKata2 = [
      "Keamanan Kita Prioritas!",
      "Utamakan Siskamling, Nyaman Bersama!",
      "Bersama, Lingkungan Aman Nyaman!",
      "Jaga Lingkungan, Jaga Keluarga!",
      "Bersatu Menjaga, Damai Dirasa!",
      "Ronda untuk Harmoni Bersama!",
      "Bersatu Menjaga, Damai Dirasa!",
      "Bersama kita lebih kuat!",
      "Ronda Malam, Wujud Peduli!",
      "Ayo Jaga Malam, Demi Kenyamanan!",
      "Bersatu menjaga, bersama menyelematkan.",
      "Sinar sentermu cahaya harapan di malam kelam.",
      "Keberanianmu malam ini adalah ketenangan esok hari.",
      "Ronda bukan tugas, tapi wujud cinta pada lingkungan.",
      "Langkahmu tegap, keamanan pun terjaga.",
      "Di sela senyap malam, keberanianmu berbicara.",
      "Jagalah lingkar keamanan dengan hati penuh tanggung jawab.",
      "Setiap putaran ronda adalah wujud kepedulian.",
      "Kita ronda, agar semua bisa tidur nyenyak.",
      "Bersama kita kuat, sendiri kita rentan.",
      "Heningnya malam butuh keberanianmu.",
      "Satu senter, sejuta rasa aman.",
      "Ronda pagi‚Äîkemenangan kecil bagi hati besar.",
      "Tangan di senter, mata di lingkungan.",
      "Langkah berjaga, cermin solidaritas.",
      "Keamananmu pijar bagi kita semua.",
      "Jaga malam, jaga persaudaraan.",
      "Malam gelap, hati terang.",
      "Satu komando: aman dan damai!",
      "Ronda: rutinitas yang memberi arti.",
      "Jadilah lentera kecil di kegelapan.",
      "Semangat ronda, semangat kebersamaan.",
      "Kesiagaanmu malam ini adalah senyum esok hari.",
      "Ronda: aksi nyata, bukan lip service.",
      "Malam mungkin panjang, tapi solidaritas lebih panjang.",
      "Keberanianmu, keamanan warga.",
      "Langkahmu malam ini memberi harapan.",
      "Ronda: walau sunyi, kita tak sendiri.",
      "Pasang senter, pancarkan rasa aman.",
      "Setiap putaran, setiap jiwa terlindungi.",
      "Ronda hari ini, damai esok hari."
    ];

    function showToast(msg, type = 'success') {
      // Create toast element
      const toast = document.createElement('div');
      toast.className = `fixed top-5 right-5 px-5 py-3 rounded-lg shadow-lg text-white z-50 transition-all flex items-center ${
        type === 'success' ? 'bg-green-500' : 'bg-red-500'
      }`;
      toast.innerHTML = `
        <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-2"></i>
        <span>${msg}</span>
      `;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => {
          document.body.removeChild(toast);
        }, 300);
      }, 3000);
    }

    function pad(n) { return n < 10 ? '0' + n : n; }
    
    function formatTanggalLong(iso) {
      const hari = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
      const bulan = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
      let d = new Date(iso);
      if (isNaN(d)) return iso;
      return `${hari[d.getDay()]}, ${d.getDate()} ${bulan[d.getMonth()]} ${d.getFullYear()}`;
    }
    
    function parseTanggalToISO(s) {
      s = s.trim().replace(/^[A-Za-z]+,\s*/, '');
      let [tgl, bln, th] = s.split(' ');
      if (!tgl || !bln || !th) return null;
      const bulan = {
        Januari: 1, Februari: 2, Maret: 3, April: 4, Mei: 5, Juni: 6, 
        Juli: 7, Agustus: 8, September: 9, Oktober: 10, November: 11, Desember: 12,
        Jan: 1, Feb: 2, Mar: 3, Apr: 4, Mei: 5, Jun: 6, 
        Jul: 7, Agu: 8, Sep: 9, Okt: 10, Nov: 11, Des: 12
      };
      let m = bulan[bln];
      if (!m) return null;
      return `${th}-${pad(m)}-${pad(parseInt(tgl, 10))}`;
    }
    
    function parseJadwalTxt(txt) {
      const lines = txt.split('\n').map(l => l.trim()).filter(l => !!l && !/Jadwal\s+Tim/i.test(l));
      let res = [];
      for (let line of lines) {
        let parts = line.split(',');
        if (parts.length < 4) continue;
        let tanggal = parts[1].trim();
        let team = parts[2].trim();
        let membersRaw = parts.slice(3).join(',').trim();
        let members = membersRaw.split(';').map(m => m.trim()).filter(Boolean);
        let iso = parseTanggalToISO(parts[0] + ',' + tanggal) || parseTanggalToISO(tanggal);
        if (!iso) continue;
        res.push({ date: iso, team, members });
      }
      return res.sort((a, b) => a.date.localeCompare(b.date));
    }
    
    function saveJadwal(arr) { localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }
    
    function loadJadwal() { 
      let d = localStorage.getItem(STORAGE_KEY); 
      try { return d ? JSON.parse(d) : []; } catch { return []; } 
    }

    function getUniqueTeams() {
      let set = new Set();
      jadwalArr.forEach(j => set.add(j.team));
      let teams = Array.from(set);
      return teams.sort((a, b) => {
        let numA = (a.match(/Tim (\d+)/i) || [])[1], numB = (b.match(/Tim (\d+)/i) || [])[1];
        if (numA && numB) return parseInt(numA) - parseInt(numB);
        if (numA) return -1;
        if (numB) return 1;
        return a.localeCompare(b);
      });
    }
    
    function renderFilterTeamOptions() {
      const select = document.getElementById('filterTeam');
      const prev = select.value;
      select.innerHTML = '<option value="">Semua Tim</option>';
      getUniqueTeams().forEach(team => {
        const opt = document.createElement('option');
        opt.value = team;
        opt.textContent = team;
        select.appendChild(opt);
      });
      if (getUniqueTeams().includes(prev)) select.value = prev;
      else select.value = "";
    }
    
    function getFilteredJadwal() {
      if (!currentFilterTeam) return jadwalArr.slice().sort((a, b) => a.date.localeCompare(b.date));
      return jadwalArr.filter(j => j.team === currentFilterTeam).sort((a, b) => a.date.localeCompare(b.date));
    }
    
    function renderPreview() {
      const tbody = document.getElementById('previewTableBody');
      const notFound = document.getElementById('notFound');
      tbody.innerHTML = '';
      notFound.innerHTML = '';
      
      let filtered = getFilteredJadwal();
      let idx = filtered.findIndex(j => j.date === currentTanggal);
      
      if (idx === -1) {
        if (filtered.length > 0) {
          currentTanggal = filtered[0].date;
          idx = 0;
        } else {
          notFound.innerHTML = `
            <div class="text-center py-8">
              <i class="fas fa-calendar-times text-4xl text-gray-400 mb-4"></i>
              <h3 class="text-xl font-semibold">Tidak ada jadwal</h3>
              <p class="text-gray-600 mt-2">Silakan tambahkan jadwal melalui fitur import</p>
            </div>
          `;
          toggleMobileActionBar(false);
          toggleBtnDesktopWA(false);
          return;
        }
      }
      
      let j = filtered[idx];
      let tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${formatTanggalLong(j.date)}</td>
        <td><span class="team-name">${j.team}</span></td>
        <td>
          <div class="member-list">
            ${j.members.map(m => `<span class="member-tag">${m}</span>`).join('')}
          </div>
        </td>
      `;
      tbody.appendChild(tr);
      toggleMobileActionBar(true);
      toggleBtnDesktopWA(true);
    }
    
    function setTanggalNext(dir) {
      let filtered = getFilteredJadwal();
      if (!filtered.length) return;
      let idx = filtered.findIndex(j => j.date === currentTanggal);
      if (idx === -1) {
        currentTanggal = filtered[0].date;
      } else {
        let nextIdx = idx + dir;
        if (nextIdx >= 0 && nextIdx < filtered.length) {
          currentTanggal = filtered[nextIdx].date;
        }
      }
      document.getElementById('datePicker').value = currentTanggal;
      renderPreview();
      renderWAOutput();
    }
    
    function randomKalimatPenutup() {
      let idx = Math.floor(Math.random() * randomKata2.length);
      return randomKata2[idx];
    }
    
    function generateWAOutput() {
      let filtered = getFilteredJadwal();
      let idx = filtered.findIndex(j => j.date === currentTanggal);
      if (idx === -1) return 'Tidak ada jadwal untuk tanggal ini.';
      
      const settings = {
        title: "RONDA MALAM KAISAR RESIDENCE",
        jam: "23.00‚Äì04.00 WIB",
        tz: "WIB"
      };
      
      let j = filtered[idx];
      
      // Get next schedules for the same team after current date
      let selanjutnya = filtered
        .filter(row => row.team === j.team && row.date > j.date)
        .map(row => `‚Ä¢ ${formatTanggalLong(row.date)}`)
        .join('\n') || '‚Ä¢ -';
      
      return `**${settings.title}**\n\n` +
        `üìÜ *${formatTanggalLong(j.date)}*\n` +
        `‚è∞ *Waktu Jaga:* ${settings.jam}\n\n` +
        `üë• *${j.team}*\n` +
        `üëÆ‚Äç‚ôÇÔ∏è *Petugas:*\n` +
        `${j.members.map(m => `‚Ä¢ ${m}`).join('\n')}\n\n` +
        `üìå *Jadwal Selanjutnya ${j.team}:*\n` +
        `${selanjutnya}\n\n` +
        `üôè Terima kasih atas partisipasinya.\n` +
        `Mari jaga lingkungan tetap aman dan nyaman bersama-sama.\n\n` +
        `üí• *${randomKalimatPenutup()}* üí•`;
    }
    
    function renderWAOutput() {
      document.getElementById('waOutput').textContent = generateWAOutput();
    }
    
    function showEditPanel(show, idx) {
      const panel = document.getElementById('editRowPanel');
      panel.style.display = show ? 'block' : 'none';
      
      if (show) {
        let j = jadwalArr[idx];
        editIdx = idx;
        document.getElementById('editTanggal').value = j.date;
        document.getElementById('editTeam').value = j.team;
        document.getElementById('editAnggota').value = j.members.join('\n');
        
        // Scroll to edit panel on mobile
        if (window.innerWidth <= 768) {
          panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      } else {
        editIdx = null;
      }
    }
    
    function toggleMobileActionBar(show) {
      const bar = document.getElementById('mobileActionBar');
      bar.style.display = show && window.innerWidth <= 768 ? 'flex' : 'none';
    }
    
    function toggleBtnDesktopWA(show) {
      const waBtnDesktop = document.getElementById('waBtnDesktop');
      waBtnDesktop.style.display = show && window.innerWidth > 768 ? 'flex' : 'none';
    }
    
    function afterDataChange() {
      renderFilterTeamOptions();
      let filtered = getFilteredJadwal();
      if (filtered.length > 0) currentTanggal = filtered[0].date;
      document.getElementById('datePicker').value = currentTanggal;
      renderPreview();
      renderWAOutput();
    }
    
    // Initialize the application
    function initApp() {
      // Set dark mode based on preference
      if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
      }
      
      // Load data from localStorage
      jadwalArr = loadJadwal();
      
      // Initialize UI
      renderFilterTeamOptions();
      
      // Set default date
      let today = new Date().toISOString().slice(0, 10);
      let filtered = getFilteredJadwal();
      
      if (filtered.length) {
        // Try to find today's date or use first available
        let todayIndex = filtered.findIndex(j => j.date === today);
        currentTanggal = todayIndex !== -1 ? today : filtered[0].date;
      } else {
        currentTanggal = today;
      }
      
      document.getElementById('datePicker').value = currentTanggal;
      renderPreview();
      renderWAOutput();
    }
    
    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
      initApp();
      
      // Filter Team change
      document.getElementById('filterTeam').addEventListener('change', function() {
        currentFilterTeam = this.value;
        let filtered = getFilteredJadwal();
        if (filtered.length > 0) {
          currentTanggal = filtered[0].date;
          document.getElementById('datePicker').value = currentTanggal;
        }
        renderPreview();
        renderWAOutput();
      });
      
      // Date picker change
      document.getElementById('datePicker').addEventListener('change', function() {
        currentTanggal = this.value;
        renderPreview();
        renderWAOutput();
      });
      
      // Navigation buttons
      document.getElementById('btnPrev').addEventListener('click', function() { 
        setTanggalNext(-1); 
      });
      
      document.getElementById('btnNext').addEventListener('click', function() { 
        setTanggalNext(1); 
      });
      
      // Copy WA text
      document.getElementById('btnCopyWA').addEventListener('click', function() {
        let waText = generateWAOutput();
        navigator.clipboard.writeText(waText).then(() => {
          showToast('Teks berhasil disalin!');
        });
      });
      
      document.getElementById('btnCopyWAMobile').addEventListener('click', function() {
        let waText = generateWAOutput();
        navigator.clipboard.writeText(waText).then(() => {
          showToast('Teks berhasil disalin!');
        });
      });
      
      // Edit row
      document.getElementById('btnEditRow').addEventListener('click', function() {
        let filtered = getFilteredJadwal();
        let idxFiltered = filtered.findIndex(j => j.date === currentTanggal);
        if (idxFiltered === -1) { 
          showToast('Tidak ada jadwal untuk diedit!', 'error'); 
          return; 
        }
        let obj = filtered[idxFiltered];
        let idx = jadwalArr.findIndex(j => j.date === obj.date && j.team === obj.team);
        if (idx === -1) idx = jadwalArr.findIndex(j => j.date === obj.date);
        showEditPanel(true, idx);
      });
      
      document.getElementById('btnEditRowMobile').addEventListener('click', function() {
        let filtered = getFilteredJadwal();
        let idxFiltered = filtered.findIndex(j => j.date === currentTanggal);
        if (idxFiltered === -1) { 
          showToast('Tidak ada jadwal untuk diedit!', 'error'); 
          return; 
        }
        let obj = filtered[idxFiltered];
        let idx = jadwalArr.findIndex(j => j.date === obj.date && j.team === obj.team);
        if (idx === -1) idx = jadwalArr.findIndex(j => j.date === obj.date);
        showEditPanel(true, idx);
      });
      
      // Cancel edit
      document.getElementById('btnCancelEdit').addEventListener('click', function() {
        showEditPanel(false);
      });
      
      // Save edit
      document.getElementById('editForm').addEventListener('submit', function(e) {
        e.preventDefault();
        if (editIdx === null) return;
        
        let tgl = document.getElementById('editTanggal').value;
        let timBaru = document.getElementById('editTeam').value.trim();
        let anggotaBaru = document.getElementById('editAnggota').value
          .split('\n').map(m => m.trim()).filter(Boolean);
        
        if (!tgl || !timBaru || !anggotaBaru.length) { 
          showToast('Lengkapi semua input!', 'error'); 
          return;
        }
        
        let timSebelum = jadwalArr[editIdx].team;
        let timSebelumLower = timSebelum.trim().toLowerCase();
        let timBaruLower = timBaru.toLowerCase();
        
        // Update all schedules for this team
        jadwalArr.forEach((item, i) => {
          if (item.team.trim().toLowerCase() === timSebelumLower) {
            jadwalArr[i].team = timBaru;
            jadwalArr[i].members = anggotaBaru.slice();
          }
        });
        
        // Update date for the edited entry
        jadwalArr[editIdx].date = tgl;
        
        saveJadwal(jadwalArr);
        renderFilterTeamOptions();
        
        if (currentFilterTeam && !getUniqueTeams().includes(currentFilterTeam)) {
          currentFilterTeam = "";
          document.getElementById('filterTeam').value = "";
        }
        
        let filtered = getFilteredJadwal();
        if (filtered.length > 0) currentTanggal = filtered[0].date;
        else currentTanggal = tgl;
        
        document.getElementById('datePicker').value = currentTanggal;
        showEditPanel(false);
        renderPreview();
        renderWAOutput();
        showToast('Jadwal tim "' + timBaru + '" diperbarui!');
      });
      
      // Import data
      document.getElementById('btnImport').addEventListener('click', () => {
        document.getElementById('inputFile').click();
      });
      
      document.getElementById('inputFile').addEventListener('change', function(e) {
        const f = e.target.files[0];
        if (!f) return;
        
        const r = new FileReader();
        r.onload = function(ev) {
          try {
            if (f.name.endsWith('.json')) {
              jadwalArr = JSON.parse(ev.target.result) || [];
            } else {
              jadwalArr = parseJadwalTxt(ev.target.result);
            }
            saveJadwal(jadwalArr);
            afterDataChange();
            showToast('Data berhasil diimport!');
          } catch (error) {
            showToast('Format file tidak valid!', 'error');
          }
        };
        r.readAsText(f);
        e.target.value = '';
      });
      
      // Export data
      document.getElementById('btnExportTxt').addEventListener('click', function() {
        let lines = jadwalArr.map(j => `${formatTanggalLong(j.date)}, ${j.team}, ${j.members.join('; ')}`);
        let blob = new Blob([lines.join('\n')], { type: 'text/plain' });
        let a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "jadwal_ronda.txt";
        a.click();
        URL.revokeObjectURL(a.href);
        showToast('Export TXT berhasil!');
      });
      
      document.getElementById('btnExportJson').addEventListener('click', function() {
        let blob = new Blob([JSON.stringify(jadwalArr, null, 2)], { type: 'application/json' });
        let a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "jadwal_ronda.json";
        a.click();
        URL.revokeObjectURL(a.href);
        showToast('Export JSON berhasil!');
      });
      
      // Clear data
      document.getElementById('btnClear').addEventListener('click', function() {
        if (confirm('Apakah Anda yakin ingin menghapus semua jadwal?')) {
          jadwalArr = [];
          saveJadwal(jadwalArr);
          afterDataChange();
          showToast('Semua jadwal telah dihapus!');
        }
      });
      
      // Copy format TXT
      document.getElementById('btnCopyFormatTxt').addEventListener('click', function() {
        let lines = jadwalArr.map(j => `${formatTanggalLong(j.date)}, ${j.team}, ${j.members.join('; ')}`);
        navigator.clipboard.writeText(lines.join('\n'));
        showToast('Format TXT disalin!');
      });
    });
  </script>
</body>
</html>
